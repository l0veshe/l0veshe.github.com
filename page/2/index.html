<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="止乎于静">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="止乎于静">
<meta property="og:locale">
<meta property="article:author" content="Chenhan Hank">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'default'
  };
</script>

  <title>止乎于静</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">止乎于静</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/07/%E5%9B%BD%E6%9C%8D%E5%8A%A0%E9%80%9F%E5%AE%89%E8%A3%85DOCKER/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/07/%E5%9B%BD%E6%9C%8D%E5%8A%A0%E9%80%9F%E5%AE%89%E8%A3%85DOCKER/" class="post-title-link" itemprop="url">国服加速安装DOCKER</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-07 23:42:01" itemprop="dateCreated datePublished" datetime="2021-09-07T23:42:01+08:00">2021-09-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-Docker"><a href="#1-Docker" class="headerlink" title="1. Docker"></a>1. Docker</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils </span><br><span class="line"></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">yum -y install docker-ce</span><br><span class="line"></span><br><span class="line">mkdir -p /etc/docker</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line"></span><br><span class="line">    &quot;max-size&quot;: &quot;5m&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;max-file&quot;:&quot;3&quot;</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line"></span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://registry.docker-cn.com&quot;, &quot;https://docker.mirrors.ustc.edu.cn&quot;]</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl start docker</span><br><span class="line"></span><br><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure>
<h2 id="2-Docker-Compose"><a href="#2-Docker-Compose" class="headerlink" title="2. Docker Compose"></a>2. Docker Compose</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://get.daocloud.io/docker/compose/releases/download/1.24.0/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line">chmod a+x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>
<h2 id="3-Helm"><a href="#3-Helm" class="headerlink" title="3. Helm"></a>3. Helm</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># https://github.com/helm/helm/releases</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/07/ES%E8%8A%82%E7%82%B9%E8%A7%84%E5%88%92/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/07/ES%E8%8A%82%E7%82%B9%E8%A7%84%E5%88%92/" class="post-title-link" itemprop="url">ES节点规划</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-07 23:39:15" itemprop="dateCreated datePublished" datetime="2021-09-07T23:39:15+08:00">2021-09-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>客户需求</p>
<p>版本 6.8</p>
<p>存储内容： 事件数据(无payload)、运维日志（含payload），告警 少，忽略；存储时间6个月，副本数2</p>
<p>假设条件：事件数据es大小800B,运维日志es大小1000B.(索引&amp;原始日志)</p>
<p>存储估算:  (10000<em>800+9000</em>1000)<em>2</em>86400*365)0.5=488T</p>
<p>为保证服务的稳定运行，建议至少预留15%的存储空间，因此建议申请的存储容量为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">实际空间 = 源数据 × (1 + 副本数量) × (1 + 数据膨胀) / (1 - 内部任务开销) / (1 - 操作系统预留)</span><br></pre></td></tr></table></figure>
<p>这里取副本数为1，数据膨胀为0，操作系统预留为100(G)/(5*1024)(G)=0.02</p>
<p>存储容量需求 ≈ 244T <em> (1+1)</em>1*1/(1-0.02) ≈ 498T</p>
<p>建议单个节点上同一索引的shard个数不要超5个。</p>
<p>建议shard的个数（包括副本）要尽可能等于数据节点数，或者是数据节点数的整数倍。</p>
<p>对于日志分析或者超大索引场景，建议单个shard大小不要超过30-100GB。这里按30/50/100G数据一个分片计算。1GB堆内存对应30-50个分片。</p>
<p>分片数</p>
<p>热数据 498T*1024 /30  ≈ 16998.4 分片</p>
<p>一般 498T*1024 /50  ≈ 10199.04 分片</p>
<p>冷数据 498T*1024 /100  ≈ 5099.52 分片</p>
<p>按分片至少需要服务器数量</p>
<p>单个数据节点的shard数量 = 当前节点的内存大小 * 50（大规格实例参考）</p>
<p>拿16核64G型号节点计算，每台堆内存设置为32</p>
<p>热数据 16998.4 /(32*30) = 17.7 ≈18</p>
<p>10199.04/(32*30) = 10.624  ≈11</p>
<p>10199.04/(32*50) =6.374 ≈ 7</p>
<p>5099.52/(32*30) =5.312≈  6</p>
<p>冷数据 5099/(32*50) = 3.18 ≈  4</p>
<p>根据数据冷热程度，最少分片需要至少16c64 4台~18台</p>
<p>按存储至少需要服务器数量</p>
<p>按照存储开源ES每台支持最大存储5T，需要100台</p>
<p>按照tencent es每台支持 最大存储30T，需要17台</p>
<p>所以需要型号为16c64G,</p>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>型号</th>
<th>数量至少需要</th>
</tr>
</thead>
<tbody>
<tr>
<td>开源ES</td>
<td>16c64 5T</td>
<td>100</td>
</tr>
<tr>
<td>tencent es</td>
<td>16c64 30T</td>
<td>17</td>
</tr>
</tbody>
</table>
</div>
<p>型号数量至少需要开源ES16c64 5T100tencent es16c64 30T17配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: txsoc-es-cluster</span><br><span class="line">node.name: node-isa1-1</span><br><span class="line">node.attr.rack_id: rack-isa1</span><br><span class="line">cluster.routing.allocation.awareness.attributes: rack_id</span><br><span class="line">cluster.routing.allocation.same_shard.host: true</span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line">node.max_local_storage_nodes: 1</span><br><span class="line"></span><br><span class="line">network.host: isa1</span><br><span class="line">http.port: 9200</span><br><span class="line">transport.tcp.port: 9300</span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;isa1:9300&quot;,&quot;isa2:9300&quot;,&quot;isa3:9300&quot;]</span><br><span class="line"></span><br><span class="line">path.data: /data/isa_data/elasticsearch-1</span><br><span class="line">path.logs: /data/isa_log/elasticsearch-1</span><br><span class="line"></span><br><span class="line">thread_pool.bulk.queue_size: 2000</span><br><span class="line"># 节点总内存堆的15%用作索引缓冲区大小</span><br><span class="line"># 10TB 磁盘数据量，其对应的 FST 内存占用量在 10GB ~ 15GB 左右</span><br><span class="line">indices.memory.index_buffer_size: 15% # default 10%</span><br><span class="line"># 所有breaker使用的内存值，默认值为 JVM 堆内存的70%，当内存达到最高值时会触发内存回收</span><br><span class="line">indices.breaker.total.limit: 40% # default 70%</span><br><span class="line"># field数据使用内存限制，默认为JVM 堆的60%。</span><br><span class="line">indices.breaker.fielddata.limit: 30% # default 60%</span><br><span class="line"># request数量使用内存限制，默认为JVM堆的40%。</span><br><span class="line"># 允许elasticsearch防止每个请求的数据结构超过了一定量的内存。</span><br><span class="line">indices.breaker.request.limit: 6% # default 60%</span><br><span class="line"># 字段数据缓存主要用于排序字段和计算聚合。将所有的字段值加载到内存中，以便提供基于文档快速访问这些值。</span><br><span class="line">indices.fielddata.cache.size: 20% # default unbonded</span><br><span class="line"># 分片请求缓存是在节点级别进行管理的，并有一个默认的值是JVM堆内存大小的1%</span><br><span class="line">indices.requests.cache.size: 2% # default 1%</span><br><span class="line"># 调小查询使用的cache，避免cache占用过多的jvm内存</span><br><span class="line">indices.queries.cache.count: 500</span><br><span class="line">indices.queries.cache.size: 5% # default 10%</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/07/ES%E8%BF%81%E7%A7%BB%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/07/ES%E8%BF%81%E7%A7%BB%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">ES迁移方案</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-07 23:37:10" itemprop="dateCreated datePublished" datetime="2021-09-07T23:37:10+08:00">2021-09-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="一、迁移方案"><a href="#一、迁移方案" class="headerlink" title="一、迁移方案"></a>一、迁移方案</h2><h3 id="使用-snapshot-进行存量迁移"><a href="#使用-snapshot-进行存量迁移" class="headerlink" title="使用 snapshot 进行存量迁移"></a>使用 snapshot 进行存量迁移</h3><p>需求：</p>
<p>有hdfs集群 且大于1T的空间</p>
<ol>
<li>拷贝 HDFS 集群配置文件:</li>
</ol>
<p>hdfsip、hdfs 端口、hdfs配置文件根据需求修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -P&lt;36000&gt; -r &lt;HDFS 一台机器ip&gt;:/usr/local/services/hadoop-3.2.1/etc/hadoop/*  /data/tmp/hadoop/</span><br></pre></td></tr></table></figure>
<ol>
<li>创建共享 HDFS 仓库</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &quot;&lt;新es ip&gt;:9200/_snapshot/my_backup&quot; -H &#x27;Content-Type: application/json&#x27; -d &#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;type&quot;: &quot;hdfs&quot;,</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;uri&quot;: &quot;hdfs://&lt;hdfs IP&gt;:9000&quot;,</span><br><span class="line">    &quot;path&quot;: &quot;/es_backup/data&quot;,</span><br><span class="line">    &quot;conf_location&quot;: &quot;/itcast/hadoop-2.2.0/etc/hadoop/hdfs-site.xml&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; &#x27;</span><br></pre></td></tr></table></figure>
<p>重新拉起ES集群</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pid=$(ps -ef | grep -v grep | grep elasticsearch | awk &#x27;&#123;print $2&#125;&#x27;) &amp;&amp; [ -n &quot;$pid&quot; ] &amp;&amp; kill -15 $pid</span><br></pre></td></tr></table></figure>
<ol>
<li>备份数据到 HDFS 仓库：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &quot;localhost:9200/_snapshot/my_backup/snapshot_1?wait_for_completion=true&quot; -H &#x27;Content-Type: application/json&#x27; -d &#x27;</span><br><span class="line"> &#123;</span><br><span class="line">   &quot;ignore_unavailable&quot;:true,</span><br><span class="line">  &quot;include_global_state&quot;:false</span><br><span class="line"> &#125; &#x27;</span><br></pre></td></tr></table></figure>
<ol>
<li>检查备份，返回结果中的state字段为SUCCESS则说明快照已经备份成功：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &#x27;localhost:9201/_snapshot/my_backup/snapshot_1?pretty&#x27;</span><br></pre></td></tr></table></figure>
<ol>
<li>登录目标 ES 集群，拷贝 HDFS 配置</li>
</ol>
<p>scp -P36000 -r HDFS 一台机器 ip:/usr/local/services/hadoop-3.2.1/etc/hadoop/*  /itcast/hadoop-2.2.0/etc/hadoop/ll itcast/hadoop-2.2.0/etc/hadoop/</p>
<ol>
<li>登录目标集群，配置和源 ES 集群同一个 HDFS 仓库，如果实例不是 9200 需换对应实例端口</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &quot;localhost:9200/_snapshot/my_backup&quot; -H &#x27;Content-Type: application/json&#x27; -d </span><br><span class="line">&#x27;&#123;</span><br><span class="line">  &quot;type&quot;: &quot;hdfs&quot;,</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;uri&quot;: &quot;hdfs://&lt;hdfs IP&gt;:9000&quot;,</span><br><span class="line">    &quot;path&quot;: &quot;/es_backup/data&quot;,</span><br><span class="line">    &quot;conf_location&quot;: &quot;/itcast/hadoop-2.2.0/etc/hadoop/hdfs-site.xml&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; &#x27;</span><br></pre></td></tr></table></figure>
<ol>
<li>重启目标 ES 集群进程</li>
<li>登录目标集群，灌输数据到目标 ES 集群：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST &#x27;http://&lt;新ES IP&gt;:9200/_snapshot/my_backup/snapshot_1/_restore?wait_for_completion=true&#x27;</span><br></pre></td></tr></table></figure>
<p>查询更新状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST &#x27;http://&lt;新ES IP&gt;:9200/_snapshot/my_backup/snapshot_1/_status</span><br></pre></td></tr></table></figure>
<h3 id="少量增量数据使用-elasticdump进行增量迁移"><a href="#少量增量数据使用-elasticdump进行增量迁移" class="headerlink" title="少量增量数据使用 elasticdump进行增量迁移"></a>少量增量数据使用 elasticdump进行增量迁移</h3><p>需求：</p>
<p>提前准备镜像并导入到用户环境</p>
<p>docker pull elasticdump/elasticsearch-dump</p>
<p>docker save -o elasticsearch-dump.tar.gz elasticdump/elasticsearch-dump</p>
<p>docker load -i elasticsearch-dump.tar.gz</p>
<p>全部索引同步</p>
<p>同步mapping</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -ti elasticdump/elasticsearch-dump \</span><br><span class="line">  --input=http://&lt;旧es ip&gt;:9200 \</span><br><span class="line">  --output=http://&lt;新es ip&gt; \</span><br><span class="line">  --type=mapping</span><br></pre></td></tr></table></figure>
<p>单个索引同步</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Copy an index from production to staging with analyzer and mapping: </span><br><span class="line">elasticdump  --input=http://&lt;旧es ip&gt;:9200/&lt;index_name&gt;  --output=http://&lt;新es ip&gt;:9200/my_index   --type=analyzer </span><br><span class="line"></span><br><span class="line">elasticdump  --input=http://&lt;旧es ip&gt;:9200/&lt;index_name&gt;  --output=http://&lt;新es ip&gt;:9200/my_index --type=mapping </span><br><span class="line"></span><br><span class="line">elasticdump  --input=http://&lt;旧es ip&gt;:9200/&lt;index_name&gt;  --output=http://&lt;新es ip&gt;:9200/my_index --type=data</span><br></pre></td></tr></table></figure>
<h3 id="大量增量数据实时同步es方案"><a href="#大量增量数据实时同步es方案" class="headerlink" title="大量增量数据实时同步es方案"></a>大量增量数据实时同步es方案</h3><p>需求</p>
<p>准备与es同版本的logstash</p>
<p>logstash 支持从一个 ES 集群中读取数据然后写入到另一个 ES 集群，因此可以使用 logstash 进行数据迁移，使用 logstash 进行迁移前，需要注意以下几点：</p>
<p>需要在和ES 集群相同的 VPC 下创建 CVM，部署 logstash，同时保证该 CVM 能够访问到源 ES 集群。</p>
<p>用于部署 logstash 的 CVM 最好选择比较高的配置，例如 CPU 为16核，内存为32GB。</p>
<p>logstash 应该和目标 ES 集群的主版本号相同，例如目标 ES 集群为6.8.2版本，则 logstash 也需要使用6.8版本。</p>
<p>需要特别注意索引 type 的问题，因为 ES 的不同版本对索引 type 的约束不同，跨大版本迁移 ES 集群时可能出现因为索引的 type 而导致写入目标集群失败等的问题。具体可参考 logstash-output-elasticsearch 插件中对 document_type 参数的说明。</p>
<p>一个常用的使用 logstash 进行跨集群数据迁移的配置文件如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">   elasticsearch &#123;</span><br><span class="line">       hosts =&gt; &quot;1.1.1.1:9200&quot;</span><br><span class="line">       index =&gt; &quot;*&quot;</span><br><span class="line">       docinfo =&gt; true</span><br><span class="line">       size =&gt; 5000</span><br><span class="line">       scroll =&gt; &quot;5m&quot;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">   elasticsearch &#123;</span><br><span class="line">       hosts =&gt; [&quot;http://2.2.2.2:9200&quot;]</span><br><span class="line">       user =&gt; &quot;elastic&quot;</span><br><span class="line">       password =&gt; &quot;your_password&quot;</span><br><span class="line">       index =&gt; &quot;%&#123;[@metadata][_index]&#125;&quot;</span><br><span class="line">       document_type =&gt; &quot;%&#123;[@metadata][_type]&#125;&quot;</span><br><span class="line">       document_id =&gt; &quot;%&#123;[@metadata][_id]&#125;&quot;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述配置文件将源 ES 集群的所有索引同步到目标集群中，同时也可以设置只同步指定的索引</p>
<p>备注：</p>
<p>logstash 多次使用后，需要清理游标，否则会导致数据写入不进去。</p>
<p>清理sincedb_path</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](https://docimg10.docs.qq.com/image/I00JlBYKqhjSH09icv2o5w.png?w=1280&amp;h=337.54569190600523)</span><br></pre></td></tr></table></figure>
<p>sincedb_path ：表示文件读取进度的记录，每行表示一个文件，每行有两个数字</p>
<p>清理logstash/data/ 目录下隐藏文件 .lock</p>
<p>确认新es集群存在以下psg索引及最新日期</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">psg-ids_block </span><br><span class="line">psg-external_block_api</span><br><span class="line">psg-flow_sum</span><br><span class="line">psg-flow_log</span><br><span class="line">psg-http_log</span><br><span class="line">psg-ip_log</span><br><span class="line">psg-dns_log</span><br><span class="line">psg-*</span><br><span class="line">threat_alarm_repress_raw_log</span><br><span class="line">threat_block_repress_log</span><br></pre></td></tr></table></figure>
<h2 id="二、切换psg的es集群配置"><a href="#二、切换psg的es集群配置" class="headerlink" title="二、切换psg的es集群配置"></a>二、切换psg的es集群配置</h2><p>更新iplist，重新出包渲染</p>
<h2 id="三、es相关命令"><a href="#三、es相关命令" class="headerlink" title="三、es相关命令"></a>三、es相关命令</h2><p>查询集群状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/health?v</span><br></pre></td></tr></table></figure>
<p>查询集群节点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/nodes</span><br></pre></td></tr></table></figure>
<p>查询ES集群机器详细 信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /search/clusters|python -m json.tool</span><br></pre></td></tr></table></figure>
<p>查询节点存储相关信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/allocation?v</span><br></pre></td></tr></table></figure>
<p>查询集群分片</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/shards?v</span><br></pre></td></tr></table></figure>
<p>查询doc条数</p>
<p><code>curl -s 10.29.1.6:9200/_cat/shards?v|awk &#39;&#123;count=$5+count&#125;END&#123;print count&#125;&#39;</code></p>
<p>查询索引数量</p>
<p><code>curl -s 10.29.1.6:9200/_cat/indices|wc -l</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/07/k8s-1-1-%E5%8D%B8%E8%BD%BD%E6%9C%AC%E5%9C%B0k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/07/k8s-1-1-%E5%8D%B8%E8%BD%BD%E6%9C%AC%E5%9C%B0k8s/" class="post-title-link" itemprop="url">k8s-1.1 卸载本地k8s</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-09-07 23:34:01 / Modified: 23:34:02" itemprop="dateCreated datePublished" datetime="2021-09-07T23:34:01+08:00">2021-09-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># kubeadm reset  --force</span><br><span class="line">W0925 22:53:24.283211    2683 removeetcdmember.go:79] [reset] No kubeadm config, using etcd pod spec to get data directory</span><br><span class="line">[reset] No etcd config found. Assuming external etcd</span><br><span class="line">[reset] Please, manually reset etcd to prevent further issues</span><br><span class="line">[reset] Stopping the kubelet service</span><br><span class="line">[reset] Unmounting mounted directories in &quot;/var/lib/kubelet&quot;</span><br><span class="line">[reset] Deleting contents of config directories: [/etc/kubernetes/manifests /etc/kubernetes/pki]</span><br><span class="line">[reset] Deleting files: [/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf]</span><br><span class="line">[reset] Deleting contents of stateful directories: [/var/lib/kubelet /var/lib/dockershim /var/run/kubernetes /var/lib/cni]</span><br><span class="line"></span><br><span class="line">The reset process does not clean CNI configuration. To do so, you must remove /etc/cni/net.d</span><br><span class="line"></span><br><span class="line">The reset process does not reset or clean up iptables rules or IPVS tables.</span><br><span class="line">If you wish to reset iptables, you must do so manually by using the &quot;iptables&quot; command.</span><br><span class="line"></span><br><span class="line">If your cluster was setup to utilize IPVS, run ipvsadm --clear (or similar)</span><br><span class="line">to reset your system&#x27;s IPVS tables.</span><br><span class="line"></span><br><span class="line">The reset process does not clean your kubeconfig files and you must remove them manually.</span><br><span class="line">Please, check the contents of the $HOME/.kube/config file.</span><br><span class="line"></span><br><span class="line"># rm -fr /etc/kubernetes</span><br><span class="line"># rm -fr .kube</span><br><span class="line"># rm -fr /etc/cni/</span><br><span class="line"># iptables -F</span><br><span class="line"># iptables -X</span><br><span class="line"># iptables -Z</span><br><span class="line"># for app in $(rpm -qa|grep kube);do echo $app;yum remove -y $app;done</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/07/k8s-5-DaemonSet-%E7%B3%BB%E7%BB%9F%E5%8A%9F%E8%83%BD%E5%BA%94%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/07/k8s-5-DaemonSet-%E7%B3%BB%E7%BB%9F%E5%8A%9F%E8%83%BD%E5%BA%94%E7%94%A8/" class="post-title-link" itemprop="url">k8s-5 DaemonSet/系统功能应用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-07 23:33:31" itemprop="dateCreated datePublished" datetime="2021-09-07T23:33:31+08:00">2021-09-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>DaemonSet保证在每个Node上都运行一个容器副本，常用来部署一些集群的日志、监控或者其他系统管理应用。典型的应用包括：</p>
<ul>
<li>日志收集，比如fluentd，logstash等</li>
<li>系统监控，比如Prometheus Node Exporter，collectd，New Relic agent，Ganglia gmond等</li>
<li>系统程序，比如kube-proxy, kube-dns, glusterd, ceph等<br>使用Fluentd收集日志的例子：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: logging</span><br><span class="line">        id: fluentd</span><br><span class="line">      name: fluentd</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: fluentd-es</span><br><span class="line">        image: gcr.io/google_containers/fluentd-elasticsearch:1.3</span><br><span class="line">        env:</span><br><span class="line">         - name: FLUENTD_ARGS</span><br><span class="line">           value: -qq</span><br><span class="line">        volumeMounts:</span><br><span class="line">         - name: containers</span><br><span class="line">           mountPath: /var/lib/docker/containers</span><br><span class="line">         - name: varlog</span><br><span class="line">           mountPath: /varlog</span><br><span class="line">      volumes:</span><br><span class="line">         - hostPath:</span><br><span class="line">             path: /var/lib/docker/containers</span><br><span class="line">           name: containers</span><br><span class="line">         - hostPath:</span><br><span class="line">             path: /var/log</span><br><span class="line">           name: varlog</span><br></pre></td></tr></table></figure>
<h4 id="指定Node节点"><a href="#指定Node节点" class="headerlink" title="指定Node节点"></a>指定Node节点</h4><p>DaemonSet会忽略Node的unschedulable状态，有两种方式来指定Pod只运行在指定的Node节点上：</p>
<ul>
<li>nodeSelector：只调度到匹配指定label的Node上</li>
<li>nodeAffinity：功能更丰富的Node选择器，比如支持集合操作</li>
<li>podAffinity：调度到满足条件的Pod所在的Node上</li>
</ul>
<h4 id="nodeSelector示例"><a href="#nodeSelector示例" class="headerlink" title="nodeSelector示例"></a>nodeSelector示例</h4><p>首先给Node打上标签</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label nodes node-01 disktype=ssd</span><br></pre></td></tr></table></figure>
<p>然后在daemonset中指定nodeSelector为disktype=ssd：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  nodeSelector:</span><br><span class="line">    disktype: ssd</span><br></pre></td></tr></table></figure>
<h4 id="nodeAffinity示例"><a href="#nodeAffinity示例" class="headerlink" title="nodeAffinity示例"></a>nodeAffinity示例</h4><p>nodeAffinity目前支持两种：requiredDuringSchedulingIgnoredDuringExecution和preferredDuringSchedulingIgnoredDuringExecution，分别代表必须满足条件和优选条件。比如下面的例子代表调度到包含标签kubernetes.io/e2e-az-name并且值为e2e-az1或e2e-az2的Node上，并且优选还带有标签another-node-label-key=another-node-label-value的Node。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: with-node-affinity</span><br><span class="line">spec:</span><br><span class="line">  affinity:</span><br><span class="line">    nodeAffinity:</span><br><span class="line">      requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">        nodeSelectorTerms:</span><br><span class="line">        - matchExpressions:</span><br><span class="line">          - key: kubernetes.io/e2e-az-name</span><br><span class="line">            operator: In</span><br><span class="line">            values:</span><br><span class="line">            - e2e-az1</span><br><span class="line">            - e2e-az2</span><br><span class="line">      preferredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">      - weight: 1</span><br><span class="line">        preference:</span><br><span class="line">          matchExpressions:</span><br><span class="line">          - key: another-node-label-key</span><br><span class="line">            operator: In</span><br><span class="line">            values:</span><br><span class="line">            - another-node-label-value</span><br><span class="line">  containers:</span><br><span class="line">  - name: with-node-affinity</span><br><span class="line">    image: gcr.io/google_containers/pause:2.0</span><br></pre></td></tr></table></figure>
<h4 id="podAffinity示例"><a href="#podAffinity示例" class="headerlink" title="podAffinity示例"></a>podAffinity示例</h4><p>podAffinity基于Pod的标签来选择Node，仅调度到满足条件Pod所在的Node上，支持podAffinity和podAntiAffinity。这个功能比较绕，以下面的例子为例：</p>
<ul>
<li>如果一个“Node所在Zone中包含至少一个带有security=S1标签且运行中的Pod”，那么可以调度到该Node</li>
<li>不调度到“包含至少一个带有security=S2标签且运行中Pod”的Node上</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: with-pod-affinity</span><br><span class="line">spec:</span><br><span class="line">  affinity:</span><br><span class="line">    podAffinity:</span><br><span class="line">      requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">      - labelSelector:</span><br><span class="line">          matchExpressions:</span><br><span class="line">          - key: security</span><br><span class="line">            operator: In</span><br><span class="line">            values:</span><br><span class="line">            - S1</span><br><span class="line">        topologyKey: failure-domain.beta.kubernetes.io/zone</span><br><span class="line">    podAntiAffinity:</span><br><span class="line">      preferredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">      - weight: 100</span><br><span class="line">        podAffinityTerm:</span><br><span class="line">          labelSelector:</span><br><span class="line">            matchExpressions:</span><br><span class="line">            - key: security</span><br><span class="line">              operator: In</span><br><span class="line">              values:</span><br><span class="line">              - S2</span><br><span class="line">          topologyKey: kubernetes.io/hostname</span><br><span class="line">  containers:</span><br><span class="line">  - name: with-pod-affinity</span><br><span class="line">    image: gcr.io/google_containers/pause:2.0</span><br></pre></td></tr></table></figure>
<h4 id="静态Pod"><a href="#静态Pod" class="headerlink" title="静态Pod"></a>静态Pod</h4><p>除了DaemonSet，还可以使用静态Pod来在每台机器上运行指定的Pod，这需要kubelet在启动的时候指定manifest目录：</p>
<p><code>kubelet --pod-manifest-path=/etc/kubernetes/manifests</code></p>
<p>然后将所需要的Pod定义文件放到指定的manifest目录中。</p>
<p>注意：静态Pod不能通过API Server来删除，但可以通过删除manifest文件来自动删除对应的Pod。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/07/k8s-4-StatefulSet-%E6%9C%89%E7%8A%B6%E6%80%81%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/07/k8s-4-StatefulSet-%E6%9C%89%E7%8A%B6%E6%80%81%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">k8s-4 StatefulSet/有状态服务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-09-07 23:32:28 / Modified: 23:32:29" itemprop="dateCreated datePublished" datetime="2021-09-07T23:32:28+08:00">2021-09-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>StatefulSet是为了解决有状态服务的问题（对应Deployments和ReplicaSets是为无状态服务而设计），其应用场景包括</p>
<ul>
<li>稳定的持久化存储，即Pod重新调度后还是能访问到相同的持久化数据，基于PVC来实现</li>
<li>稳定的网络标志，即Pod重新调度后其PodName和HostName不变，基于Headless Service（即没有Cluster IP的Service）来实现</li>
<li>有序部署，有序扩展，即Pod是有顺序的，在部署或者扩展的时候要依据定义的顺序依次依次进行（即从0到N-1，在下一个Pod运行之前所有之前的Pod必须都是Running和Ready状态），基于init containers来实现</li>
<li>有序收缩，有序删除（即从N-1到0）</li>
</ul>
<p>从上面的应用场景可以发现，StatefulSet由以下几个部分组成：</p>
<ul>
<li>用于定义网络标志（DNS domain）的<strong>Headless Service</strong></li>
<li>用于创建PersistentVolumes的<strong>volumeClaimTemplates</strong></li>
<li>定义具体应用的<strong>StatefulSet</strong></li>
</ul>
<p>StatefulSet中每个Pod的DNS格式为<code>statefulSetName-&#123;0..N-1&#125;.serviceName.namespace.svc.cluster.local</code>，其中</p>
<ul>
<li><code>serviceName</code>为Headless Service的名字<br>0..N-1为Pod所在的序号，从0开始到N-1</li>
<li><code>statefulSetName</code>为StatefulSet的名字</li>
<li><code>namespace</code>为服务所在的namespace，Headless Servic和StatefulSet必须在相同的namespace</li>
<li><code>.cluster.local</code>为Cluster Domain，</li>
</ul>
<h2 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h2><p>以一个简单的nginx服务web.yaml为例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    name: web</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: web</span><br><span class="line">spec:</span><br><span class="line">  serviceName: &quot;nginx&quot;</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: gcr.io/google_containers/nginx-slim:0.8</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: web</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: www</span><br><span class="line">          mountPath: /usr/share/nginx/html</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: www</span><br><span class="line">      annotations:</span><br><span class="line">        volume.alpha.kubernetes.io/storage-class: anything</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ &quot;ReadWriteOnce&quot; ]</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 1Gi</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f web.yaml</span><br><span class="line">service &quot;nginx&quot; created</span><br><span class="line">statefulset &quot;web&quot; created</span><br><span class="line"></span><br><span class="line"># 查看创建的headless service和statefulset</span><br><span class="line">$ kubectl get service nginx</span><br><span class="line">NAME      CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">nginx     None         &lt;none&gt;        80/TCP    1m</span><br><span class="line">$ kubectl get statefulset web</span><br><span class="line">NAME      DESIRED   CURRENT   AGE</span><br><span class="line">web       2         2         2m</span><br><span class="line"></span><br><span class="line"># 根据volumeClaimTemplates自动创建PVC（在GCE中会自动创建kubernetes.io/gce-pd类型的volume）</span><br><span class="line">$ kubectl get pvc</span><br><span class="line">NAME        STATUS    VOLUME                                     CAPACITY   ACCESSMODES   AGE</span><br><span class="line">www-web-0   Bound     pvc-d064a004-d8d4-11e6-b521-42010a800002   1Gi        RWO           16s</span><br><span class="line">www-web-1   Bound     pvc-d06a3946-d8d4-11e6-b521-42010a800002   1Gi        RWO           16s</span><br><span class="line"></span><br><span class="line"># 查看创建的Pod，他们都是有序的</span><br><span class="line">$ kubectl get pods -l app=nginx</span><br><span class="line">NAME      READY     STATUS    RESTARTS   AGE</span><br><span class="line">web-0     1/1       Running   0          5m</span><br><span class="line">web-1     1/1       Running   0          4m</span><br><span class="line"></span><br><span class="line"># 使用nslookup查看这些Pod的DNS</span><br><span class="line">$ kubectl run -i --tty --image busybox dns-test --restart=Never --rm /bin/sh</span><br><span class="line">/ # nslookup web-0.nginx</span><br><span class="line">Server:    10.0.0.10</span><br><span class="line">Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      web-0.nginx</span><br><span class="line">Address 1: 10.244.2.10</span><br><span class="line">/ # nslookup web-1.nginx</span><br><span class="line">Server:    10.0.0.10</span><br><span class="line">Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      web-1.nginx</span><br><span class="line">Address 1: 10.244.3.12</span><br><span class="line">/ # nslookup web-0.nginx.default.svc.cluster.local</span><br><span class="line">Server:    10.0.0.10</span><br><span class="line">Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      web-0.nginx.default.svc.cluster.local</span><br><span class="line">Address 1: 10.244.2.10</span><br></pre></td></tr></table></figure>
<p><strong>为什么需要 headless service 无头服务？</strong><br>在用Deployment时，每一个Pod名称是没有顺序的，是随机字符串，因此是Pod名称是无序的，但是在statefulset中要求必须是有序 ，每一个pod不能被随意取代，pod重建后pod名称还是一样的。而pod IP是变化的，所以是以Pod名称来识别。pod名称是pod唯一性的标识符，必须持久稳定有效。这时候要用到无头服务，它可以给每个Pod一个唯一的名称 。</p>
<p><strong>为什么需要volumeClaimTemplate？</strong><br>对于有状态的副本集都会用到持久存储，对于分布式系统来讲，它的最大特点是数据是不一样的，所以各个节点不能使用同一存储卷，每个节点有自已的专用存储，但是如果在Deployment中的Pod template里定义的存储卷，是所有副本集共用一个存储卷，数据是相同的，因为是基于模板来的 ，而statefulset中每个Pod都要自已的专有存储卷，所以statefulset的存储卷就不能再用Pod模板来创建了，于是statefulSet使用volumeClaimTemplate，称为卷申请模板，它会为每个Pod生成不同的pvc，并绑定pv， 从而实现各pod有专用存储。这就是为什么要用volumeClaimTemplate的原因。</p>
<p>还可以进行其他的操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 扩容</span><br><span class="line">$ kubectl scale statefulset web --replicas=5</span><br><span class="line"></span><br><span class="line"># 缩容</span><br><span class="line">$ kubectl patch statefulset web -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;replicas&quot;:3&#125;&#125;&#x27;</span><br><span class="line"></span><br><span class="line"># 镜像更新（目前还不支持直接更新image，需要patch来间接实现）</span><br><span class="line">$ kubectl patch statefulset web --type=&#x27;json&#x27; -p=&#x27;[&#123;&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/image&quot;, &quot;value&quot;:&quot;gcr.io/google_containers/nginx-slim:0.7&quot;&#125;]&#x27;</span><br><span class="line"></span><br><span class="line"># 删除StatefulSet和Headless Service</span><br><span class="line">$ kubectl delete statefulset web</span><br><span class="line">$ kubectl delete service nginx</span><br><span class="line"></span><br><span class="line"># StatefulSet删除后PVC还会保留着，数据不再使用的话也需要删除</span><br><span class="line">$ kubectl delete pvc www-web-0 www-web-1</span><br></pre></td></tr></table></figure>
<h4 id="zookeeper"><a href="#zookeeper" class="headerlink" title="zookeeper"></a>zookeeper</h4><p>另外一个更能说明StatefulSet强大功能的示例为zookeeper.yaml。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-headless</span><br><span class="line">  labels:</span><br><span class="line">    app: zk-headless</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 2888</span><br><span class="line">    name: server</span><br><span class="line">  - port: 3888</span><br><span class="line">    name: leader-election</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: zk</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-config</span><br><span class="line">data:</span><br><span class="line">  ensemble: &quot;zk-0;zk-1;zk-2&quot;</span><br><span class="line">  jvm.heap: &quot;2G&quot;</span><br><span class="line">  tick: &quot;2000&quot;</span><br><span class="line">  init: &quot;10&quot;</span><br><span class="line">  sync: &quot;5&quot;</span><br><span class="line">  client.cnxns: &quot;60&quot;</span><br><span class="line">  snap.retain: &quot;3&quot;</span><br><span class="line">  purge.interval: &quot;1&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: policy/v1beta1</span><br><span class="line">kind: PodDisruptionBudget</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-budget</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: zk</span><br><span class="line">  minAvailable: 2</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: zk</span><br><span class="line">spec:</span><br><span class="line">  serviceName: zk-headless</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: zk</span><br><span class="line">      annotations:</span><br><span class="line">        pod.alpha.kubernetes.io/initialized: &quot;true&quot;</span><br><span class="line">        scheduler.alpha.kubernetes.io/affinity: &gt;</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;podAntiAffinity&quot;: &#123;</span><br><span class="line">                &quot;requiredDuringSchedulingRequiredDuringExecution&quot;: [&#123;</span><br><span class="line">                  &quot;labelSelector&quot;: &#123;</span><br><span class="line">                    &quot;matchExpressions&quot;: [&#123;</span><br><span class="line">                      &quot;key&quot;: &quot;app&quot;,</span><br><span class="line">                      &quot;operator&quot;: &quot;In&quot;,</span><br><span class="line">                      &quot;values&quot;: [&quot;zk-headless&quot;]</span><br><span class="line">                    &#125;]</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &quot;topologyKey&quot;: &quot;kubernetes.io/hostname&quot;</span><br><span class="line">                &#125;]</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: k8szk</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        image: gcr.io/google_samples/k8szk:v1</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: &quot;4Gi&quot;</span><br><span class="line">            cpu: &quot;1&quot;</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 2181</span><br><span class="line">          name: client</span><br><span class="line">        - containerPort: 2888</span><br><span class="line">          name: server</span><br><span class="line">        - containerPort: 3888</span><br><span class="line">          name: leader-election</span><br><span class="line">        env:</span><br><span class="line">        - name : ZK_ENSEMBLE</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">              name: zk-config</span><br><span class="line">              key: ensemble</span><br><span class="line">        - name : ZK_HEAP_SIZE</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-config</span><br><span class="line">                key: jvm.heap</span><br><span class="line">        - name : ZK_TICK_TIME</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-config</span><br><span class="line">                key: tick</span><br><span class="line">        - name : ZK_INIT_LIMIT</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-config</span><br><span class="line">                key: init</span><br><span class="line">        - name : ZK_SYNC_LIMIT</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-config</span><br><span class="line">                key: tick</span><br><span class="line">        - name : ZK_MAX_CLIENT_CNXNS</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-config</span><br><span class="line">                key: client.cnxns</span><br><span class="line">        - name: ZK_SNAP_RETAIN_COUNT</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-config</span><br><span class="line">                key: snap.retain</span><br><span class="line">        - name: ZK_PURGE_INTERVAL</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">                name: zk-config</span><br><span class="line">                key: purge.interval</span><br><span class="line">        - name: ZK_CLIENT_PORT</span><br><span class="line">          value: &quot;2181&quot;</span><br><span class="line">        - name: ZK_SERVER_PORT</span><br><span class="line">          value: &quot;2888&quot;</span><br><span class="line">        - name: ZK_ELECTION_PORT</span><br><span class="line">          value: &quot;3888&quot;</span><br><span class="line">        command:</span><br><span class="line">        - sh</span><br><span class="line">        - -c</span><br><span class="line">        - zkGenConfig.sh &amp;&amp; zkServer.sh start-foreground</span><br><span class="line">        readinessProbe:</span><br><span class="line">          exec:</span><br><span class="line">            command:</span><br><span class="line">            - &quot;zkOk.sh&quot;</span><br><span class="line">          initialDelaySeconds: 15</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        livenessProbe:</span><br><span class="line">          exec:</span><br><span class="line">            command:</span><br><span class="line">            - &quot;zkOk.sh&quot;</span><br><span class="line">          initialDelaySeconds: 15</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: datadir</span><br><span class="line">          mountPath: /var/lib/zookeeper</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 1000</span><br><span class="line">        fsGroup: 1000</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: datadir</span><br><span class="line">      annotations:</span><br><span class="line">        volume.alpha.kubernetes.io/storage-class: anything</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ &quot;ReadWriteOnce&quot; ]</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 20Gi</span><br></pre></td></tr></table></figure>
<p><code>kubectl create -f zookeeper.yaml</code></p>
<h4 id="StatefulSet注意事项"><a href="#StatefulSet注意事项" class="headerlink" title="StatefulSet注意事项"></a>StatefulSet注意事项</h4><ol>
<li>还在beta状态，需要kubernetes v1.5版本以上才支持</li>
<li>所有Pod的Volume必须使用PersistentVolume或者是管理员事先创建好</li>
<li>为了保证数据安全，删除StatefulSet时不会删除Volume</li>
<li>StatefulSet需要一个Headless Service来定义DNS domain，需要在StatefulSet之前创建好</li>
<li>目前StatefulSet还没有feature complete，比如更新操作还需要手动patch。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/07/k8s-3-secret-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/07/k8s-3-secret-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/" class="post-title-link" itemprop="url">k8s-3 secret/环境变量</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-07 23:30:58" itemprop="dateCreated datePublished" datetime="2021-09-07T23:30:58+08:00">2021-09-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h2><hr>
<p>Secret解决了密码、token、密钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者Pod Spec中。Secret可以以Volume或者环境变量的方式使用。</p>
<p>Secret有三种类型：</p>
<ul>
<li>Service Account<blockquote>
<p>用来访问Kubernetes API，由Kubernetes自动创建，并且会自动挂载到Pod的/run/secrets/kubernetes.io/serviceaccount目录中；</p>
</blockquote>
</li>
<li>Opaque<blockquote>
<p>base64编码格式的Secret，用来存储密码、密钥等；</p>
</blockquote>
</li>
<li>kubernetes.io/dockerconfigjson<blockquote>
<p>用来存储私有docker registry的认证信息。</p>
</blockquote>
</li>
</ul>
<h2 id="Opaque-Secret"><a href="#Opaque-Secret" class="headerlink" title="Opaque Secret"></a>Opaque Secret</h2><p>Opaque类型的数据是一个map类型，要求value是base64编码格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ echo -n &quot;admin&quot; | base64</span><br><span class="line">YWRtaW4=</span><br><span class="line">$ echo -n &quot;1f2d1e2e67df&quot; | base64</span><br><span class="line">MWYyZDFlMmU2N2Rm</span><br></pre></td></tr></table></figure>
<p>secrets.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: mysecret</span><br><span class="line">type: Opaque</span><br><span class="line">data:</span><br><span class="line">  password: MWYyZDFlMmU2N2Rm</span><br><span class="line">  username: YWRtaW4=</span><br></pre></td></tr></table></figure>
<p>接着，就可以创建secret了：kubectl create -f secrets.yml。</p>
<p>创建好secret之后，有两种方式来使用它：</p>
<ul>
<li>以Volume方式</li>
<li>以环境变量方式</li>
</ul>
<h4 id="将Secret挂载到Volume中"><a href="#将Secret挂载到Volume中" class="headerlink" title="将Secret挂载到Volume中"></a>将Secret挂载到Volume中</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    name: db</span><br><span class="line">  name: db</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">  - name: secrets</span><br><span class="line">    secret:</span><br><span class="line">      secretName: mysecret</span><br><span class="line">  containers:</span><br><span class="line">  - image: gcr.io/my_project_id/pg:v1</span><br><span class="line">    name: db</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: secrets</span><br><span class="line">      mountPath: &quot;/etc/secrets&quot;</span><br><span class="line">      readOnly: true</span><br><span class="line">    ports:</span><br><span class="line">    - name: cp</span><br><span class="line">      containerPort: 5432</span><br><span class="line">      hostPort: 5432</span><br></pre></td></tr></table></figure>
<h4 id="将Secret导出到环境变量中"><a href="#将Secret导出到环境变量中" class="headerlink" title="将Secret导出到环境变量中"></a>将Secret导出到环境变量中</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: wordpress-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  strategy:</span><br><span class="line">      type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: wordpress</span><br><span class="line">        visualize: &quot;true&quot;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: &quot;wordpress&quot;</span><br><span class="line">        image: &quot;wordpress&quot;</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        env:</span><br><span class="line">        - name: WORDPRESS_DB_USER</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              name: mysecret</span><br><span class="line">              key: username</span><br><span class="line">        - name: WORDPRESS_DB_PASSWORD</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              name: mysecret</span><br><span class="line">              key: password</span><br></pre></td></tr></table></figure>
<h4 id="kubernetes-io-dockerconfigjson"><a href="#kubernetes-io-dockerconfigjson" class="headerlink" title="kubernetes.io/dockerconfigjson"></a>kubernetes.io/dockerconfigjson</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create secret docker-registry myregistrykey --docker-server=DOCKER_REGISTRY_SERVER --docker-username=DOCKER_USER --docker-password=DOCKER_PASSWORD --docker-email=DOCKER_EMAIL</span><br><span class="line">secret &quot;myregistrykey&quot; created.</span><br></pre></td></tr></table></figure>
<p>也可以直接读取~/.docker/config.json的内容来创建：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ cat ~/.docker/config.json | base64</span><br><span class="line">$ cat &gt; myregistrykey.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: myregistrykey</span><br><span class="line">data:</span><br><span class="line">  .dockerconfigjson: UmVhbGx5IHJlYWxseSByZWVlZWVlZWVlZWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGx5eXl5eXl5eXl5eXl5eXl5eXl5eSBsbGxsbGxsbGxsbGxsbG9vb29vb29vb29vb29vb29vb29vb29vb29vb25ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubmdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2cgYXV0aCBrZXlzCg==</span><br><span class="line">type: kubernetes.io/dockerconfigjson</span><br><span class="line">EOF</span><br><span class="line">$ kubectl create -f myregistrykey.yaml</span><br></pre></td></tr></table></figure></p>
<p>在创建Pod的时候，通过imagePullSecrets来引用刚创建的myregistrykey:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: foo</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: foo</span><br><span class="line">      image: janedoe/awesomeapp:v1</span><br><span class="line">  imagePullSecrets:</span><br><span class="line">    - name: myregistrykey</span><br></pre></td></tr></table></figure>
<h4 id="Service-Account"><a href="#Service-Account" class="headerlink" title="Service Account"></a>Service Account</h4><p>Service Account用来访问Kubernetes API，由Kubernetes自动创建，并且会自动挂载到Pod的/run/secrets/kubernetes.io/serviceaccount目录中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run nginx --image nginx</span><br><span class="line">deployment &quot;nginx&quot; created</span><br><span class="line">$ kubectl get pods</span><br><span class="line">NAME                     READY     STATUS    RESTARTS   AGE</span><br><span class="line">nginx-3137573019-md1u2   1/1       Running   0          13s</span><br><span class="line">$ kubectl exec nginx-3137573019-md1u2 ls /run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">ca.crt</span><br><span class="line">namespace</span><br><span class="line">token</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/07/k8s-2-%E6%97%A0%E7%8A%B6%E6%80%81%E5%BA%94%E7%94%A8-deployment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/07/k8s-2-%E6%97%A0%E7%8A%B6%E6%80%81%E5%BA%94%E7%94%A8-deployment/" class="post-title-link" itemprop="url">k8s-2 无状态应用/deployment</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-07 23:29:19" itemprop="dateCreated datePublished" datetime="2021-09-07T23:29:19+08:00">2021-09-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="使Master节点变为可以调度的node"><a href="#使Master节点变为可以调度的node" class="headerlink" title="使Master节点变为可以调度的node"></a>使Master节点变为可以调度的node</h2><h5 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h5><p><a target="_blank" rel="noopener" href="http://b.hank.im/2020/08/18/k8s-2-%E6%97%A0%E7%8A%B6%E6%80%81%E5%BA%94%E7%94%A8-deployment/#https://kubernetes.io/zh/docs/concepts/scheduling-eviction/taint-and-toleration/">https://kubernetes.io/zh/docs/concepts/scheduling-eviction/taint-and-toleration/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 查看主节点名称</span><br><span class="line">[root@k8s1 ~]# kubectl get nodes -A</span><br><span class="line">NAME           STATUS   ROLES    AGE     VERSION</span><br><span class="line">k8s1.hank.im   Ready    master   4d12h   v1.18.6</span><br><span class="line"># 查看主节点Taint状态</span><br><span class="line">[root@k8s1 ~]# kubectl describe  node k8s1.hank.im|grep Tain</span><br><span class="line">Taints:             node-role.kubernetes.io/master:NoSchedule</span><br></pre></td></tr></table></figure>
<p>主节点为不可调度模式,更改为可调度模式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# kubectl taint node k8s1.hank.im node-role.kubernetes.io/master-</span><br><span class="line">node/k8s1.hank.im untainted</span><br><span class="line">[root@k8s1 ~]# kubectl describe  node k8s1.hank.im|grep Tain</span><br><span class="line">Taints:             &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h2 id="启动无状态应用nginx"><a href="#启动无状态应用nginx" class="headerlink" title="启动无状态应用nginx"></a>启动无状态应用nginx</h2><p>Kubernetes 跟 Docker 等很多项目最大的不同，就在于它不推荐你使用命令行的方式直接运行容器（虽然 Kubernetes 项目也支持这种方式，比如：kubectl run），而是希望你用 YAML 文件的方式，即：把容器的定义、参数、配置，统统记录在一个 YAML 文件中，然后用这样一句指令把它运行起来：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f 我的配置文件</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># application/nginx-deployment.yml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment      # deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment </span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx      # label slector</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx    # labels 必须在matchlabels存在</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.7.9 </span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# kubectl create -f application/nginx-deployment.yml</span><br><span class="line">[root@k8s1 application]# kubectl get pods -l app=nginx</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-5bf87f5f59-5t5gj   1/1     Running   0          30m</span><br><span class="line">nginx-deployment-5bf87f5f59-7t74w   1/1     Running   0          30m</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# kubectl get pods -l app=nginx</span><br></pre></td></tr></table></figure>
<p>-l 是什么参数呢</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 application]# kubectl get pods -h|grep  &quot;\-l&quot;</span><br><span class="line">-l, --selector=&#x27;&#x27;: Selector (label query) to filter on, supports &#x27;=&#x27;, &#x27;==&#x27;, and &#x27;!=&#x27;.(e.g. -l key1=value1,key2=value2)</span><br></pre></td></tr></table></figure>
<p>是yml文件中的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">selector:</span><br><span class="line">  matchLabels:</span><br><span class="line">    app: nginx      # label slector</span><br></pre></td></tr></table></figure>
<p>更改nginx版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">     containers:</span><br><span class="line">     - name: nginx</span><br><span class="line">       #image: nginx:1.7.9 </span><br><span class="line">       image: nginx:1.8</span><br><span class="line">       ports:</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 application]#  kubectl replace -f deployment.yaml</span><br><span class="line">deployment.apps/nginx-deployment replaced</span><br></pre></td></tr></table></figure>
<p>使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f</span><br></pre></td></tr></table></figure>
<p>就不用create/replace，如果配置文件有改动，apply会自动处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 application]# kubectl get pods</span><br><span class="line">NAME                                READY   STATUS              RESTARTS   AGE</span><br><span class="line">nginx-deployment-5f8c6846ff-59khf   0/1     ContainerCreating   0          3m20s</span><br><span class="line">nginx-deployment-5f8c6846ff-qzcr7   0/1     ContainerCreating   0          3m20s</span><br><span class="line">nginx-deployment-5f8c6846ff-xtzkq   0/1     ContainerCreating   0          3m20s</span><br></pre></td></tr></table></figure>
<p>发现一直在ContainerCreating</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 application]# kubectl describe pod nginx-deployment-5f8c6846ff-59khf</span><br><span class="line">Name:           nginx-deployment-5f8c6846ff-59khf</span><br><span class="line">Namespace:      default</span><br><span class="line">Priority:       0</span><br><span class="line">Node:           k8s1.hank.im/192.168.232.201</span><br><span class="line">Start Time:     Mon, 17 Aug 2020 11:39:46 +0800</span><br><span class="line">Labels:         app=nginx</span><br><span class="line">                pod-template-hash=5f8c6846ff</span><br><span class="line">Annotations:    cni.projectcalico.org/podIP: 192.169.250.80/32</span><br><span class="line">                cni.projectcalico.org/podIPs: 192.169.250.80/32</span><br><span class="line">Status:         Pending</span><br><span class="line">IP:</span><br><span class="line">IPs:            &lt;none&gt;</span><br><span class="line">Controlled By:  ReplicaSet/nginx-deployment-5f8c6846ff</span><br><span class="line">Containers:</span><br><span class="line">  nginx:</span><br><span class="line">    Container ID:</span><br><span class="line">    Image:          nginx:1.8</span><br><span class="line">    Image ID:</span><br><span class="line">    Port:           80/TCP</span><br><span class="line">    Host Port:      0/TCP</span><br><span class="line">    State:          Waiting</span><br><span class="line">      Reason:       ContainerCreating</span><br><span class="line">    Ready:          False</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-jcdm4 (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">  Ready             False</span><br><span class="line">  ContainersReady   False</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  default-token-jcdm4:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-jcdm4</span><br><span class="line">    Optional:    false</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason       Age    From                   Message</span><br><span class="line">  ----     ------       ----   ----                   -------</span><br><span class="line">  Normal   Scheduled    4m14s  default-scheduler      Successfully assigned default/nginx-deployment-5f8c6846ff-59khf to k8s1.hank.im</span><br><span class="line">  Warning  FailedMount  4m13s  kubelet, k8s1.hank.im  MountVolume.SetUp failed for volume &quot;default-token-jcdm4&quot; : failed to sync secret cache: timed out waiting for the condition</span><br><span class="line">  Normal   Pulling      4m11s  kubelet, k8s1.hank.im  Pulling image &quot;nginx:1.8&quot;</span><br></pre></td></tr></table></figure>
<p>Pulling 4m11s kubelet, k8s1.hank.im Pulling image “nginx:1.8”<br>感情是nginx1.8下不来，那么我们用</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/07/k8s-1-18-%E5%9B%BD%E6%9C%8D%E5%AE%89%E8%A3%85%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/07/k8s-1-18-%E5%9B%BD%E6%9C%8D%E5%AE%89%E8%A3%85%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">k8s 1.18 国服安装笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-09-07 23:21:19 / Modified: 23:22:09" itemprop="dateCreated datePublished" datetime="2021-09-07T23:21:19+08:00">2021-09-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-系统准备"><a href="#1-系统准备" class="headerlink" title="1 系统准备"></a>1 系统准备</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# cat /etc/centos-release</span><br><span class="line">CentOS Linux release 7.8.2003 (Core)</span><br></pre></td></tr></table></figure>
<h2 id="2-配置固定ip"><a href="#2-配置固定ip" class="headerlink" title="2 配置固定ip"></a>2 配置固定ip</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# cat /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">#BOOTPROTO=dhcp</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens33</span><br><span class="line">UUID=2cb41960-5518-4366-8aa9-3b387ab22468</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=192.168.232.201</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=192.168.232.2</span><br></pre></td></tr></table></figure>
<h2 id="3-添加阿里源"><a href="#3-添加阿里源" class="headerlink" title="3 添加阿里源"></a>3 添加阿里源</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# rm -rfv /etc/yum.repos.d/*</span><br><span class="line">[root@k8s1 ~]# curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br></pre></td></tr></table></figure>
<h2 id="4-配置主机名"><a href="#4-配置主机名" class="headerlink" title="4 配置主机名"></a>4 配置主机名</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# cat /etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.232.201 k8s1.hank.im</span><br><span class="line">192.168.232.202 k8s2.hank.im</span><br></pre></td></tr></table></figure>
<h2 id="5-关闭swap，注释swap分区"><a href="#5-关闭swap，注释swap分区" class="headerlink" title="5 关闭swap，注释swap分区"></a>5 关闭swap，注释swap分区</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# swapoff -a</span><br><span class="line">[root@k8s1 ~]# sed -i &#x27;/swap/d&#x27; /etc/fstab</span><br></pre></td></tr></table></figure>
<h2 id="6-配置内核参数，将桥接的IPv4流量传递到iptables的链"><a href="#6-配置内核参数，将桥接的IPv4流量传递到iptables的链" class="headerlink" title="6 配置内核参数，将桥接的IPv4流量传递到iptables的链"></a>6 配置内核参数，将桥接的IPv4流量传递到iptables的链</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">sysctl --system</span><br><span class="line">[root@k8s1 ~]# setenforce 0</span><br><span class="line">[root@k8s1 ~]# sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27;  /etc/selinux/config</span><br></pre></td></tr></table></figure>
<h2 id="7-安装常用包"><a href="#7-安装常用包" class="headerlink" title="7 安装常用包"></a>7 安装常用包</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# yum install vim bash-completion net-tools gcc -y</span><br><span class="line">[root@k8s1 ~]# yum group install Development Tools -y</span><br></pre></td></tr></table></figure>
<h2 id="7-5-插入一条-ulimit-修改"><a href="#7-5-插入一条-ulimit-修改" class="headerlink" title="7.5 插入一条 ulimit 修改"></a>7.5 插入一条 ulimit 修改</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 重启后生效</span><br><span class="line">[root@k8s1 ~]# cat &gt;&gt; /etc/security/limits.conf &lt;&lt; EOF</span><br><span class="line">*             soft    nofile         204800</span><br><span class="line">*             hard    nofile         204800</span><br><span class="line">*             soft    nproc          204800</span><br><span class="line">*             hard    nproc          204800</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[root@k8s1 ~]# cat &gt; /etc/security/limits.d/20-nproc.conf &lt;&lt; EOF</span><br><span class="line">*          soft    nproc     204800</span><br><span class="line">root       soft    nproc     unlimited</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 立即生效</span><br><span class="line">[root@k8s1 ~]# ulimit -SHn 204800</span><br><span class="line">[root@k8s1 ~]# ulimit -SHq 819200</span><br><span class="line">[root@k8s1 ~]# ulimit -SHu 204800</span><br><span class="line"></span><br><span class="line"># 查看</span><br><span class="line">[root@k8s2 ~]# ulimit -a </span><br><span class="line"></span><br><span class="line"># cat /proc/$PID/limits  如果看到Max open files 65535 65535 files 则说明配置已生效</span><br></pre></td></tr></table></figure>
<h2 id="8-查看时间是否正确"><a href="#8-查看时间是否正确" class="headerlink" title="8 查看时间是否正确"></a>8 查看时间是否正确</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# yum install ntpdate -y</span><br><span class="line">[root@k8s1 ~]# ntpdate -u time1.cloud.tencent.com </span><br><span class="line">[root@k8s1 ~]# echo &quot;*/20 * * * * /usr/sbin/ntpdate -u time1.cloud.tencent.com  &gt;/dev/null &amp;&quot; &gt;&gt; /var/spool/cron/root</span><br><span class="line">16 Aug 08:48:33 ntpdate[109431]: step time server 114.118.7.161 offset 352572.538751 sec</span><br></pre></td></tr></table></figure>
<h2 id="9-使用aliyun源安装docker-ce"><a href="#9-使用aliyun源安装docker-ce" class="headerlink" title="9 使用aliyun源安装docker-ce"></a>9 使用aliyun源安装docker-ce</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">[root@k8s1 ~]# yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docke</span><br><span class="line">r-ce.repo</span><br><span class="line">[root@k8s1 ~]# yum -y install docker-ce</span><br><span class="line">[root@k8s1 ~]# mkdir -p /etc/docker</span><br><span class="line">[root@k8s1 ~]# cat /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;graph&quot;: &quot;/data/docker&quot;,</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://x9o4p9lt.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">[root@k8s1 ~]# systemctl daemon-reload</span><br><span class="line">[root@k8s1 ~]# systemctl restart docker</span><br><span class="line">[root@k8s1 ~]# systemctl enable docker</span><br><span class="line">[root@k8s1 ~]# systemctl stop firewalld</span><br><span class="line">[root@k8s1 ~]# systemctl disable firewalld</span><br></pre></td></tr></table></figure>
<h2 id="10-装kubectl、kubelet、kubeadm"><a href="#10-装kubectl、kubelet、kubeadm" class="headerlink" title="10 装kubectl、kubelet、kubeadm"></a>10 装kubectl、kubelet、kubeadm</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line">[root@k8s1 ~]# yum install -y kubectl-1.18.6 kubelet-1.18.6 kubeadm-1.18.6</span><br><span class="line">[root@k8s1 ~]# systemctl enable kubelet</span><br></pre></td></tr></table></figure>
<h2 id="11-初始化安装集群"><a href="#11-初始化安装集群" class="headerlink" title="11 初始化安装集群"></a>11 初始化安装集群</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># --apiserver-advertise-address 本机地址</span><br><span class="line">kubeadm init --kubernetes-version=1.18.0  --apiserver-advertise-address=192.168.232.201  --image-repository registry.aliyuncs.com/google_containers  </span><br><span class="line">  --service-cidr=192.168.0.0/16 --pod-network-cidr=192.169.0.0/16   # 互无联系</span><br><span class="line">...</span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line">[root@k8s1 ~]# mkdir -p $HOME/.kube</span><br><span class="line">[root@k8s1 ~]# sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">[root@k8s1 ~]# sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line">[root@k8s1 ~]# source &lt;(kubectl completion bash)</span><br></pre></td></tr></table></figure>
<h2 id="12-查看节点-pod"><a href="#12-查看节点-pod" class="headerlink" title="12 查看节点 pod"></a>12 查看节点 pod</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">NAME                STATUS     ROLES    AGE     VERSION</span><br><span class="line">master01.paas.com   NotReady   master   2m29s   v1.18.0</span><br><span class="line">[root@master01 ~]# kubectl get pod --all-namespaces</span><br><span class="line">NAMESPACE     NAME                                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   coredns-7ff77c879f-fsj9l                    0/1     Pending   0          2m12s</span><br><span class="line">kube-system   coredns-7ff77c879f-q5ll2                    0/1     Pending   0          2m12s</span><br><span class="line">kube-system   etcd-master01.paas.com                      1/1     Running   0          2m22s</span><br><span class="line">kube-system   kube-apiserver-master01.paas.com            1/1     Running   0          2m22s</span><br><span class="line">kube-system   kube-controller-manager-master01.paas.com   1/1     Running   0          2m22s</span><br><span class="line">kube-system   kube-proxy-th472                            1/1     Running   0          2m12s</span><br><span class="line">kube-system   kube-scheduler-master01.paas.com            1/1     Running   0          2m22s</span><br></pre></td></tr></table></figure>
<h2 id="13-安装calico网络"><a href="#13-安装calico网络" class="headerlink" title="13 安装calico网络"></a>13 安装calico网络</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml</span><br></pre></td></tr></table></figure>
<h2 id="14-再次查看node"><a href="#14-再次查看node" class="headerlink" title="14 再次查看node"></a>14 再次查看node</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# kubectl get pod --all-namespaces</span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   calico-kube-controllers-578894d4cd-8p9xr   1/1     Running   0          5m18s</span><br><span class="line">kube-system   calico-node-czgqs                          1/1     Running   0          5m19s</span><br><span class="line">kube-system   coredns-7ff77c879f-f6p5r                   1/1     Running   0          4d10h</span><br><span class="line">kube-system   coredns-7ff77c879f-p2xl8                   1/1     Running   0          4d10h</span><br><span class="line">kube-system   etcd-k8s1.hank.im                          1/1     Running   0          4d10h</span><br><span class="line">kube-system   kube-apiserver-k8s1.hank.im                1/1     Running   0          4d10h</span><br><span class="line">kube-system   kube-controller-manager-k8s1.hank.im       1/1     Running   0          4d10h</span><br><span class="line">kube-system   kube-proxy-qjczn                           1/1     Running   0          4d10h</span><br><span class="line">kube-system   kube-scheduler-k8s1.hank.im                1/1     Running   0          4d10h</span><br><span class="line">[root@k8s1 ~]#</span><br></pre></td></tr></table></figure>
<h2 id="15-如果报错，查看日志"><a href="#15-如果报错，查看日志" class="headerlink" title="15 如果报错，查看日志"></a>15 如果报错，查看日志</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查日志				</span><br><span class="line">kubectl describe pod/calico-node-28fwk -n kube-system</span><br></pre></td></tr></table></figure>
<h2 id="16-添加dashboard"><a href="#16-添加dashboard" class="headerlink" title="16 添加dashboard"></a>16 添加dashboard</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# wget  https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-rc7/aio/deploy/recommended.yaml</span><br><span class="line">[root@master01 ~]# vim recommended.yaml</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort   # add</span><br><span class="line">  ports:</span><br><span class="line">    - port: 443</span><br><span class="line">      targetPort: 8443</span><br><span class="line">      nodePort: 30000  # add</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl create -f recommended.yaml</span><br><span class="line">namespace/kubernetes-dashboard created</span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">secret/kubernetes-dashboard-csrf created</span><br><span class="line">secret/kubernetes-dashboard-key-holder created</span><br><span class="line">configmap/kubernetes-dashboard-settings created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/dashboard-metrics-scraper created</span><br><span class="line">deployment.apps/dashboard-metrics-scraper created</span><br></pre></td></tr></table></figure>
<h2 id="17-查看状态"><a href="#17-查看状态" class="headerlink" title="17 查看状态"></a>17 查看状态</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]#  kubectl get pods -A</span><br><span class="line">NAMESPACE              NAME                                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system            calico-kube-controllers-578894d4cd-8p9xr    1/1     Running   0          11m</span><br><span class="line">kube-system            calico-node-czgqs                           1/1     Running   0          11m</span><br><span class="line">kube-system            coredns-7ff77c879f-f6p5r                    1/1     Running   0          4d10h</span><br><span class="line">kube-system            coredns-7ff77c879f-p2xl8                    1/1     Running   0          4d10h</span><br><span class="line">kube-system            etcd-k8s1.hank.im                           1/1     Running   0          4d10h</span><br><span class="line">kube-system            kube-apiserver-k8s1.hank.im                 1/1     Running   0          4d10h</span><br><span class="line">kube-system            kube-controller-manager-k8s1.hank.im        1/1     Running   0          4d10h</span><br><span class="line">kube-system            kube-proxy-qjczn                            1/1     Running   0          4d10h</span><br><span class="line">kube-system            kube-scheduler-k8s1.hank.im                 1/1     Running   0          4d10h</span><br><span class="line">kubernetes-dashboard   dashboard-metrics-scraper-dc6947fbf-4ghbd   1/1     Running   0          2m4s</span><br><span class="line">kubernetes-dashboard   kubernetes-dashboard-5d4dc8b976-67lkz       1/1     Running   0          2m4s</span><br><span class="line">[root@k8s1 ~]# kubectl get svc -n kubernetes-dashboard</span><br><span class="line">NAME                        TYPE        CLUSTER-IP        EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">dashboard-metrics-scraper   ClusterIP   192.168.178.170   &lt;none&gt;        8000/TCP        104s</span><br><span class="line">kubernetes-dashboard        NodePort    192.168.26.221    &lt;none&gt;        443:30000/TCP   104s</span><br></pre></td></tr></table></figure>
<h2 id="18-绑定密钥"><a href="#18-绑定密钥" class="headerlink" title="18 绑定密钥"></a>18 绑定密钥</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# kubectl -n kubernetes-dashboard get secret</span><br><span class="line">NAME                               TYPE                                  DATA   AGE</span><br><span class="line">default-token-v7k99                kubernetes.io/service-account-token   3      2m50s</span><br><span class="line">kubernetes-dashboard-certs         Opaque                                0      2m50s</span><br><span class="line">kubernetes-dashboard-csrf          Opaque                                1      2m50s</span><br><span class="line">kubernetes-dashboard-key-holder    Opaque                                2      2m50s</span><br><span class="line">kubernetes-dashboard-token-rz9mn   kubernetes.io/service-account-token   3      2m50s</span><br><span class="line">[root@k8s1 ~]# kubectl describe secrets -n kubernetes-dashboard  kubernetes-dashboard-token-rz9mn  | grep token | awk &#x27;NR==3&#123;print $2&#125;&#x27;</span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IlFyaXppQ1JTYV82TDhoM2N6RjgtS05QeGdlLXc2TURxZFFCdnQ5YmtoV0UifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi1yejltbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjczZjU0YTdmLTU4NWYtNGIwOS1iNTAwLTZlOGIyODlhNGQ0YiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.gNfY2Jysj3o7klavdHzcd055D6E3lAiYwmE8-ldAWKBo7jVX4CsjjJuwXgMAudCJheEILx52TcgDnvh-kwqUH1xQuTR9z4PWGTGAoE58TEnMJFVRc6c3-CB5hX5zJ_gs0knEmrocWx1HADfWQ82KFH-zdUUPiio7osMgEmEE0FcY3hIP62CvQ6URMFiJ9MeOBODKeUijAjYj4qxh11IcnpaDqlkkUfhba7G05Jn__A_xKnbqQ9-ljM0Q3fCrMPCD-60gbzXUO7b7svus1KlP8uQKNUHSQOKzVvK17C89WqWwIqjGhs3SZ9ar1hlwHi0SlpHNGrZeMqryhHVoYhm00g</span><br></pre></td></tr></table></figure>
<h2 id="19-绑定用户资源"><a href="#19-绑定用户资源" class="headerlink" title="19 绑定用户资源"></a>19 绑定用户资源</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# kubectl create clusterrolebinding serviceaccount-cluster-admin --clusterrole=cluster-admin --user=system:serviceaccount:kubernetes-dashboard:kubernetes-dashboard</span><br></pre></td></tr></table></figure>
<p>打开<a href="https://:30000">https://:30000</a><br>输入token 上方一大堆串的字符<br><code>eyJhbGciOiJSUzI1NiIsImtpZCI6IlFyaXppQ1JTYV82TDhoM2N6RjgtS05QeGdlLXc2TURxZFFCdnQ5YmtoV0UifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi1yejltbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjczZjU0YTdmLTU4NWYtNGIwOS1iNTAwLTZlOGIyODlhNGQ0YiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.gNfY2Jysj3o7klavdHzcd055D6E3lAiYwmE8-ldAWKBo7jVX4CsjjJuwXgMAudCJheEILx52TcgDnvh-kwqUH1xQuTR9z4PWGTGAoE58TEnMJFVRc6c3-CB5hX5zJ_gs0knEmrocWx1HADfWQ82KFH-zdUUPiio7osMgEmEE0FcY3hIP62CvQ6URMFiJ9MeOBODKeUijAjYj4qxh11IcnpaDqlkkUfhba7G05Jn__A_xKnbqQ9-ljM0Q3fCrMPCD-60gbzXUO7b7svus1KlP8uQKNUHSQOKzVvK17C89WqWwIqjGhs3SZ9ar1hlwHi0SlpHNGrZeMqryhHVoYhm00g</code></p>
<h4 id="主节点搭建完成"><a href="#主节点搭建完成" class="headerlink" title="主节点搭建完成"></a>主节点搭建完成</h4><h2 id="20-其他节点加入主节点"><a href="#20-其他节点加入主节点" class="headerlink" title="20 其他节点加入主节点"></a>20 其他节点加入主节点</h2><p>其他主机同步到本机的第10点</p>
<h3 id="1-导出config"><a href="#1-导出config" class="headerlink" title="1 导出config"></a>1 导出config</h3><p>master中的节点认证信息24小时会失效，可以重新生成（master端操作）<br>重新生成用于节点加入集群的认证命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# cat ~/.kube/config</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN5RENDQWJDZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJd01Ea3lOREUxTXpVME1Wb1hEVE13TURreU1qRTFNelUwTVZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTUJtCjZrTDUwUFdRMExyUDhPZ2RTaGdzblNiWCttckcveUZrR2Vxa2cyRE9MeExuUElmcFBrcm9zOCtMZ2ZNbGRKK28KNUtZL1dJQmhpeWtydHQ0RVNqRGJUQXZKbWljTjZnSndQOGRzUVJOUHJCUlpGd0VEZU5jMWp3WXZETmRodU1EZAprVE9UT3N0aEhBaG1qVXJPVENLT3A4Z2VOK05zRm9DcjFQV2Z4MmVUQnpCNU56bXllRENiWG50eWViQ1hiYnVwCmlrS3p0cDBTTUpUSVlMUEUvRTIrTm91UlZiMCs3MXpHTzRJQXcyYVZTa25KOFNHSktVQm1WdWo5Y3FlcWRqQ1AKekphZnlRZ2dUSXcyZkl3aUxtYnNBY210WVhKUmh5VUQzZ2tNSzRDSGcydzczZ3FoaUFHRlc5bWtiVjJuTzRNNgpyZmRmSERXTWpjdjhubzJTakRzQ0F3RUFBYU1qTUNFd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFFbkdtelpvZXE4dVpaRHZZZGVuVURiQnk0T1gKTXVUSlZCbEcvYmNua2tsQ2RKUGtjcmsyMFBqNkxjSmptNXJkVjZlZmJ3ZXlNSjU0ZjZJdEhmSHIrcFBlMitQNgo2NEZRMENlTlRRT0krN1hGSmZHQnJzMERTdGs1OG5uQ3dHVEwzRVI3NlN4Q1BUaTMvM3BzM3MzcGZhNldTSVQ2CjN5eDZYMVRkaFFjcWp4YTJ0eEdpUjVCODd1WkUzMFlYNGIwR2JGNElsNDFNemZpSTVwRGtXNXl0a2xHZVhFdzMKQUxXUHpOaytPOVZsSmtOMTFXQzZoSjBvWTNGUGJXYzQzWTAxWkcyQUhNOEVHNEVCTUxBbzM2RFFkMXQwQUwzTQpsbk00cjdXSE5wWXZyRTgyazhQRHBkVllyRERrYnJrMVpHbkk0K2NGSEhhNVN6YnFKa0xOZHNUVHhTcz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><br><span class="line">    server: https://192.168.232.201:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM4akNDQWRxZ0F3SUJBZ0lJVEdkOXhUU29za013RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TURBNU1qUXhOVE0xTkRGYUZ3MHlNVEE1TWpReE5UTTFORE5hTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXVGWmp1Z2EvWUxkenMvVFAKR3NiZExKaFd3QUFRWG83b1pQNGt5T2dlTnNkQ2pPTkplcWYrTTNnN010TnVoM20xS0VKRmt0KzhRaFEzV0FRQQpCRThObE05SWQwY2pUT053ME90cElURVJBVVoyamhxcmtMeDJLamRVK3Nra1UwWUhTc3hYN0ZVdHJTNzUyM2hCCnZPUkROSlJKdkU2RzZKbVowL3M5cE5XY0NVTDFleUlTejd1UDFTZE0vUWt4S0tqcTFHT2tWS1JtV01oWXhWMzIKb2RMaXQrMTltb2xhdU1KWU8wZ3FiL3lyMXY0MFZ6WjdoVzJCN29KMHVCSXBsQXJhYUtncGoyNXBDbVEzRHZCTApTajZ0bmZvUi9vdCtaeFJ4MUJqNUpmTWpPQnBvTHcvZXhLL2U5STlaUG84THBEWlltMkRIaXptaU1VdTZ5Uks1CktscEQvUUlEQVFBQm95Y3dKVEFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFBT2JiajRmTDYzQ3kzelJHTFZrdW1maWF1RHM2bzk4Z3NpMworcmp5blo3RTJFcHpWeG9uNFFTdlArd0FBckE1aGJVL3hPWXR0WFIxME9nSTkralJFMnBsTy95TUwxcXF1THdZCndqR28wSXRvYloyb1NFdzBQSG5wYzhPWVAxUldJWjVpV0tpK3ZFTCt5d1lZWGwxaHc2V3R5ckJWbVRLejNIRkYKdjNsM3lKa1RBSVV3LzBFNEdiKzg1c3B3VGFxeG1IZDRJQUtqTXErVURCdVNOa2JNUUU4Q1JFMEFUQmswSWpLWQo2UE4zTWRHT3NKdmVZNjViVVVQeGIwVjQwWmExOEZ6cm15R0FCZ1lmQUE2OXhrNXcyQUtQMm4xaC9TRnNkaFR2Ck02ZEZUZEJJUFZBQVJjVWtlRU1HMm1ZQmhRVVBlMjVvbmdqUUV0SFRyVXFqajNXT1hwST0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><br><span class="line">    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBdUZaanVnYS9ZTGR6cy9UUEdzYmRMSmhXd0FBUVhvN29aUDRreU9nZU5zZENqT05KCmVxZitNM2c3TXROdWgzbTFLRUpGa3QrOFFoUTNXQVFBQkU4TmxNOUlkMGNqVE9OdzBPdHBJVEVSQVVaMmpocXIKa0x4MktqZFUrc2trVTBZSFNzeFg3RlV0clM3NTIzaEJ2T1JETkpSSnZFNkc2Sm1aMC9zOXBOV2NDVUwxZXlJUwp6N3VQMVNkTS9Ra3hLS2pxMUdPa1ZLUm1XTWhZeFYzMm9kTGl0KzE5bW9sYXVNSllPMGdxYi95cjF2NDBWelo3CmhXMkI3b0owdUJJcGxBcmFhS2dwajI1cENtUTNEdkJMU2o2dG5mb1Ivb3QrWnhSeDFCajVKZk1qT0Jwb0x3L2UKeEsvZTlJOVpQbzhMcERaWW0yREhpem1pTVV1NnlSSzVLbHBEL1FJREFRQUJBb0lCQUZFWCtERmJUSS9neEs3VApNTlVuelI4VU9YMm55WXUvdEs3Uk94K0ROZCtGVTFxbGxxcTJBdGRqdWk5RzRtWUkvZEFqTDNaSXBRb3cySlFJCjFuVU96ZnU4SUxZUWZwQVJzb3pHTTI2ZHBreDRVaWw3eENRZE5LS255dU8wM3gwZlBwQUNTMSsxclMxMThBZEQKNVMrUy81bSs3cDAvc292Ykh0Z3B1OW1xKzBUN0I5N25ZU2RLWXFQS1JQSlNVZ0JOeE9FeVozZTZKOGRmMVFLWgoxZFVHeXpOSFVjMU5jRlZ2bHdINFZGTlhoaHBLTE1JZStuYWtoTkoxbEJkdmhldVEyY2tEVmZ3YmFRc2lqb1BIClV1ZkN2OUdkQ29VWE5od05nU3pFOTFTUWVQNEF4SDJDREJoWmZxeVZiSnJnKzRMUU9sZVFzV2dKdGdsYkl4a0YKNTdHcTZXRUNnWUVBMklnYllVTE4zckpnd2llNk9yV1RWQTE2YW83VUIzLzROVmJnejZlYkJnR0ZwSEU0MVFDSApmYVVPd1NjS2RPRVE2WVBVT1cvbklFaG05SGlIUDl3a3dOWWJBWlZobE45emNyMHg0WjBsWEZ0NURkVG9zQ01iCk5qeE05Q1B5em5jTTBxaFNvMjZGL2ZSOWwxQTNoajVEeXRKZDN1c3FiS3A0aEt6b0s0QmhkQWtDZ1lFQTJmQUYKMEdIcGh6VEJ5MUdOOTdJc2pKNk5UUW9wV0lVbnlyQU9JNVkwYWpzTW81cklDRkZtSjRlMllwNldzUVNCR3lpcAp5ekYxbnp4d21IaU5KYnVqbVhaeWZkWUJZY25KVWJGcmh1eUc2ektSR3J1VU82T0hDSitIazZpUHdRUDgwd3g3CjJSREVNVTNqRHprUXEyQi9kV1ZBYzV0ZXZaZkt1a0o3QXZJcUZWVUNnWUVBcTR1QkxaZndZOXNzSHdXOFc2RFkKM01GazE2RGFTQ3JSS09qd2FITmZ0TzFseEhiUzBLVi9za0lmSTFWYnltYzRyOWY2UFpyeklEZGNJWmlQaGo5UgpldGpsUW1ibmpUdE9TbnVyVmhQYXNvWGhyTnlka0ZYdnpCTVA0R2ZPaUZYMitiblM1cG04WEFyanFRb3JReFozClBPdFc1VEdvUmJqMGpDQTBPNnFWQ29rQ2dZQVhVK2piYUUrZDZGakNFYVczbUx2S0JZS3NkMlQ3azYweHRleWQKaEl0eHY0WlgwTTZPalYvNDVUN3hpWFlwMW9pWFJwLytIdm92SkVJTklBSkR3clQ5VFQ5dUZzVXBHWGRTSmtLVApPNmdwYnMwM1psSzBtNGx0czkzSVFXZTV5bHA2b01CMCtLVjNmWlhMWUZsWGJzblY0Qk9wREQxMDM5V1VZRjlZCmJtRnd6UUtCZ0FMdWsxSVNFam94TXlvaWdqODQydU9WUU1BMU1rdHdTOFN2SnBya0V5SllOcmZyeWU1NzFaRUoKL1Bhb21nU0I1Tnd4ZzQ4K20vNW5aaWtJS1IyUm1aS2I5ZEI4Uko4ZHBld05GS3BScFZvMHpnN2dwZFFFMmtpNwpoVFI1S3JYTXE3bm4rYmZKRm5RbnZxeUlzMDZHVFB3eG9McFFxOVRuNGRzODR6NEFOakhDCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==</span><br></pre></td></tr></table></figure>
<p>复制到从节点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s2 ~]# mkdir -p $HOME/.kube</span><br><span class="line">[root@k8s2 ~]# vim .kube/config   # 粘贴到这里</span><br><span class="line">[root@k8s2 ~]# sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line">[root@k8s2 ~]# source &lt;(kubectl completion bash)</span><br></pre></td></tr></table></figure>
<h3 id="2-创建token"><a href="#2-创建token" class="headerlink" title="2 创建token"></a>2 创建token</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# kubeadm token create</span><br><span class="line">W0925 23:27:24.185638   44148 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]</span><br><span class="line">90u07f.em5awzxwxkrk5j5t</span><br><span class="line">[root@k8s1 ~]# openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null |openssl dgst -sha256 -hex| sed &#x27;s/^.* //&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="3-加入集群"><a href="#3-加入集群" class="headerlink" title="3 加入集群"></a>3 加入集群</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s2 ~]# kubeadm join 192.168.232.201:6443 --token a941el.3psezyof2fi00bma --discovery-token-ca-cert-hash sha256:91c1c19df2c2abcaf0a98a6b02d4a7c1a56dbb514e18a5bc6267739edb3ad5a0</span><br></pre></td></tr></table></figure>
<h3 id="4-查看nodes"><a href="#4-查看nodes" class="headerlink" title="4 查看nodes"></a>4 查看nodes</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s2 ~]# kubectl get nodes</span><br><span class="line">NAME           STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s1.hank.im   Ready    master   23h   v1.18.6</span><br><span class="line">k8s2.hank.im   Ready    &lt;none&gt;   19s   v1.18.6</span><br></pre></td></tr></table></figure>
<h2 id="21-设置节点标签"><a href="#21-设置节点标签" class="headerlink" title="21 设置节点标签"></a>21 设置节点标签</h2><p>设置标签</p>
<p><code>kubectl label node k8s2.hank.im type=nginx</code></p>
<p>删除标签</p>
<p><code>kubectl label nodes k8s2.hank.im type-</code></p>
<p>查看标签</p>
<p><code>kubectl get node k8s2.hank.im --show-labels</code></p>
<p>修改覆盖标签</p>
<p><code>kubectl label nodes k8s2.hank.im &lt;key&gt;=&lt;value&gt; --overwrite</code></p>
<h2 id="22-设置污点-以标签"><a href="#22-设置污点-以标签" class="headerlink" title="22 设置污点 - 以标签"></a>22 设置污点 - 以标签</h2><ul>
<li>NoSchedule:node 添加这个effect类型污点，新的不能容忍的pod，不能再调度过来，但是老的运行在node上不受影响</li>
<li>NoExecute：node 添加这个effect类型污点，新的不能容忍的pod，不能调度过来，老的pod也会被驱逐</li>
<li>PreferNoSchedule：pod会尝试将pod分配到该节点</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes node1 key=value:NoSchedule</span><br><span class="line">kubectl taint nodes node1 key=value:NoExecute</span><br><span class="line">kubectl taint nodes node1 key=value:PreferNoSchedule</span><br></pre></td></tr></table></figure>
<p><em>添加污点</em></p>
<blockquote>
<p>必须配合标签使用</p>
</blockquote>
<p><code>kubectl taint node xxx.xxx.xxx.xxx key=nginx:NoSchedule</code></p>
<p><em>查看污点</em></p>
<p><code>kubectl describe node xxx.xxx.xxx.xxx|grep -E &quot;Name:|Taint&quot;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s2 ~]#  kubectl taint node k8s1.hank.im  key=nginx:NoSchedule</span><br><span class="line">[root@k8s2 ~]#  kubectl taint node k8s2.hank.im  key=mysql:NoSchedule</span><br><span class="line"></span><br><span class="line">[root@k8s2 ~]# kubectl describe nodes |grep -E &quot;Name:|Taint&quot;</span><br><span class="line">Name:               k8s1.hank.im</span><br><span class="line">Taints:             key=nginx:NoSchedule</span><br><span class="line">Name:               k8s2.hank.im</span><br><span class="line">Taints:             key=mysql:NoSchedule</span><br><span class="line"></span><br><span class="line">[root@k8s2 ~]# kubectl taint node k8s2.hank.im  key=mysql:NoSchedule-</span><br><span class="line">node/k8s2.hank.im untainted</span><br><span class="line">[root@k8s2 ~]# kubectl taint node k8s1.hank.im  key=nginx:NoSchedule-</span><br><span class="line">node/k8s1.hank.im untainted</span><br><span class="line"></span><br><span class="line">[root@k8s2 ~]# kubectl describe nodes |grep -E &quot;Name:|Taint&quot;</span><br><span class="line">Name:               k8s1.hank.im</span><br><span class="line">Taints:             &lt;none&gt;</span><br><span class="line">Name:               k8s2.hank.im</span><br><span class="line">Taints:             &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2021/09/07/a23d7f20-0587-46cc-a51d-59eed3dd37a0.png" alt="Image.jpg"></p>
<h2 id="23-master-单机使用"><a href="#23-master-单机使用" class="headerlink" title="23 master 单机使用"></a>23 master 单机使用</h2><p>查看master的污点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# kubectl describe node k8s1.hank.im</span><br><span class="line">...</span><br><span class="line">Taints:             node-role.kubernetes.io/master:NoSchedule</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>所以主节点模式是不接受新pod调度<br>那么我们可以让master接受调度，成为单机模式</p>
<p><code>kubectl taint node k8s1.hank.im node-role.kubernetes.io/master-</code></p>
<p>那么我们如何恢复主节点master only的状态</p>
<p><code>kubectl taint node k8s1.hank.im node-role.kubernetes.io/master=&quot;&quot;:NoSchedule</code></p>
<h2 id="24-停止调度"><a href="#24-停止调度" class="headerlink" title="24 停止调度"></a>24 停止调度</h2><blockquote>
<p>影响最小，只会将node调为SchedulingDisabled<br>之后再发创建pod，不会被调度到该节点<br>旧有的pod不会受到影响，仍正常对外提供服务</p>
</blockquote>
<p>停止调度</p>
<p><code>kubectl cordon k8s2.hank.im</code></p>
<p>取消停止调度</p>
<p><code>kubectl uncordon k8s2.hank.im</code></p>
<p>查看停止调度</p>
<p><code>kubectl describe nodes|grep -E &quot;Name:|Unschedulable&quot;</code></p>
<h2 id="25-驱逐节点"><a href="#25-驱逐节点" class="headerlink" title="25 驱逐节点"></a>25 驱逐节点</h2><blockquote>
<p>首先，驱逐node上的pod，其他节点重新创建<br>接着，将节点调为<strong> SchedulingDisabled</strong></p>
</blockquote>
<p>驱逐pod</p>
<p><code>kubectl drain k8s2.hank.im</code><br><code>kubectl drain k8s2.hank.im --ignore-daemonsets</code></p>
<p>恢复驱逐pod</p>
<p><code>kubectl uncordon k8s2.hank.im</code></p>
<p>查看驱逐调度</p>
<p><code>kubectl describe nodes|grep -E &quot;Name:|Unschedulable&quot;</code></p>
<h2 id="26-在指定节点部署"><a href="#26-在指定节点部署" class="headerlink" title="26 在指定节点部署"></a>26 在指定节点部署</h2><h3 id="1-查看节点信息"><a href="#1-查看节点信息" class="headerlink" title="1. 查看节点信息"></a>1. 查看节点信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s2 ~]# kubectl get nodes</span><br><span class="line">NAME           STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s1.hank.im   Ready    master   24h   v1.18.6</span><br><span class="line">k8s2.hank.im   Ready    &lt;none&gt;   56m   v1.18.6</span><br></pre></td></tr></table></figure>
<h3 id="2-选择一个节点，给这个节点添加一个标签"><a href="#2-选择一个节点，给这个节点添加一个标签" class="headerlink" title="2. 选择一个节点，给这个节点添加一个标签"></a>2. 选择一个节点，给这个节点添加一个标签</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s2 ~]#  kubectl label nodes k8s2.hank.im app=nginx</span><br><span class="line">node/k8s2.hank.im labeled</span><br></pre></td></tr></table></figure>
<h3 id="3-查看标签信息"><a href="#3-查看标签信息" class="headerlink" title="3. 查看标签信息"></a>3. 查看标签信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s2 ~]# kubectl get node k8s2.hank.im --show-labels</span><br><span class="line">NAME           STATUS   ROLES    AGE   VERSION   LABELS</span><br><span class="line">k8s2.hank.im   Ready    &lt;none&gt;   58m   v1.18.6   app=nginx,beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s2.hank.im,kubernetes.io/os=linux</span><br></pre></td></tr></table></figure>
<h3 id="4-nginx-部署"><a href="#4-nginx-部署" class="headerlink" title="4. nginx 部署"></a>4. nginx 部署</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s2 ~]# cat &gt; ~/nginx-dp.yaml&lt;&lt; EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:              # pod spec</span><br><span class="line">      nodeSelector:    # 选 择在 app=nginx标签的node</span><br><span class="line">        app: nginx</span><br><span class="line">      containers:</span><br><span class="line">        - image: nginx</span><br><span class="line">          imagePullPolicy: Always</span><br><span class="line">          name: nginx</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">        - name: default-secret</span><br><span class="line">EOF</span><br><span class="line">[root@k8s2 ~]# kubectl apply -f nginx-dp.yaml</span><br><span class="line">[root@k8s2 ~]# kubectl get pods -o wide</span><br><span class="line"></span><br><span class="line"># 查看pod状态</span><br><span class="line">[root@k8s2 ~]# kubectl describe pod nginx-764bc788c-kb8xv</span><br><span class="line"></span><br><span class="line"># 查看部署状态</span><br><span class="line">[root@k8s2 ~]# kubectl get pods -o wide</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE     IP               NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-764bc788c-7n8lm   1/1     Running   0          4m19s   192.169.62.128   k8s2.hank.im   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-764bc788c-7rd7g   1/1     Running   0          2m23s   192.169.62.129   k8s2.hank.im   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-764bc788c-kb8xv   1/1     Running   0          2m23s   192.169.62.130   k8s2.hank.im   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到全部node都创建在k8s2.hank.im</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/07/%E6%8A%80%E6%9C%AF%E8%BF%90%E7%BB%B4%E5%9F%BA%E7%A1%80%E6%8A%80%E8%83%BD%E9%9D%A2%E8%AF%95%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/07/%E6%8A%80%E6%9C%AF%E8%BF%90%E7%BB%B4%E5%9F%BA%E7%A1%80%E6%8A%80%E8%83%BD%E9%9D%A2%E8%AF%95%E9%A2%98/" class="post-title-link" itemprop="url">技术运维基础技能面试题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-07 23:12:59" itemprop="dateCreated datePublished" datetime="2021-09-07T23:12:59+08:00">2021-09-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9D%A2%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">面试</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-shell"><a href="#1-shell" class="headerlink" title="1.shell"></a>1.shell</h2><h3 id="1-1-脚本编程"><a href="#1-1-脚本编程" class="headerlink" title="1.1 脚本编程"></a>1.1 脚本编程</h3><h4 id="1-常用的shell解释器-中"><a href="#1-常用的shell解释器-中" class="headerlink" title="1. 常用的shell解释器 中"></a>1. 常用的shell解释器 中</h4><p>sh 在linux下是低版本的bash做的连接<br>bash 较于sh版本会高一些。 centos sh bash3.+ bash5.+<br>zsh<br>ksh work on AIX</p>
<h4 id="2-如何检查之前的命令是否运行成功-低"><a href="#2-如何检查之前的命令是否运行成功-低" class="headerlink" title="2. 如何检查之前的命令是否运行成功? 低"></a>2. 如何检查之前的命令是否运行成功? 低</h4><p>$?</p>
<h4 id="3-字符串的截取？-高"><a href="#3-字符串的截取？-高" class="headerlink" title="3. 字符串的截取？ 高"></a>3. 字符串的截取？ 高</h4><p>${string: start :length} 字符串截取</p>
<p>${string: 0-start :length} 从右边截取.</p>
<p>${url#*:} 截取冒号右边的字符串</p>
<p>${url#*/} 截取/右边的字符串，遇到/就结束</p>
<p>${str##<em>aa} 截取最后</em>aa的字符串，直到最后<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">url=&quot;http://c.biancheng.net/index.html&quot;</span><br><span class="line">echo $&#123;url#*/&#125;    #结果为 /c.biancheng.net/index.html</span><br><span class="line">echo $&#123;url##*/&#125;   #结果为 index.html</span><br><span class="line">str=&quot;---aa+++aa@@@&quot;</span><br><span class="line">echo $&#123;str#*aa&#125;   #结果为 +++aa@@@</span><br><span class="line">echo $&#123;str##*aa&#125;  #结果为 @@@</span><br></pre></td></tr></table></figure></p>
<h4 id="4-与-区别-中"><a href="#4-与-区别-中" class="headerlink" title="4. $* 与 $@区别 中"></a>4. $* 与 $@区别 中</h4><p>未加引号,二者相同<br>$* 一个字符串整体<br>$@ 是一个字符串列表</p>
<h4 id="5-如何移除第一个变量？"><a href="#5-如何移除第一个变量？" class="headerlink" title="5. 如何移除第一个变量？"></a>5. 如何移除第一个变量？</h4><p>shift</p>
<h4 id="6-如何在-bash-shell-中更改标准的域分隔符为-“-”-中"><a href="#6-如何在-bash-shell-中更改标准的域分隔符为-“-”-中" class="headerlink" title="6. 如何在 bash shell 中更改标准的域分隔符为 “:” ? 中"></a>6. 如何在 bash shell 中更改标准的域分隔符为 “:” ? 中</h4><p>IFS=”:”</p>
<h4 id="7-列表操作-中-高"><a href="#7-列表操作-中-高" class="headerlink" title="7. 列表操作 中-高"></a>7. 列表操作 中-高</h4><p>如何打印数组的第一个元素<br>echo ${array[0]}</p>
<p>如何打印数组的所有元素 ?<br>echo ${array[@]}</p>
<p>如何输出所有数组索引 ?<br>echo ${!array[@]}</p>
<p>如何移除数组中索引为 2 的元素 ?<br>unset array[2]</p>
<h4 id="8-与-的区别-中"><a href="#8-与-的区别-中" class="headerlink" title="8. [ 与 [[ 的区别 中"></a>8. [ 与 [[ 的区别 中</h4><p>[ ] 是test命令，他可以工作在posix shell下。<br>[[ ]] 是范匹配test命令的泛匹配模式。不能在posix shells下工作</p>
<h4 id="9-如何调试-bash-脚本-高"><a href="#9-如何调试-bash-脚本-高" class="headerlink" title="9. 如何调试 bash 脚本 高"></a>9. 如何调试 bash 脚本 高</h4><h1 id="bin-bash-–xv"><a href="#bin-bash-–xv" class="headerlink" title="!/bin/bash –xv"></a>!/bin/bash –xv</h1><h3 id="1-2-命令掌握"><a href="#1-2-命令掌握" class="headerlink" title="1.2 命令掌握"></a>1.2 命令掌握</h3><h4 id="1-读取键盘输入-中"><a href="#1-读取键盘输入-中" class="headerlink" title="1. 读取键盘输入 中"></a>1. 读取键盘输入 中</h4><p>read -p “Destination backup Server : “ desthost</p>
<h4 id="2-什么是-expect-高"><a href="#2-什么是-expect-高" class="headerlink" title="2. 什么是 expect 高"></a>2. 什么是 expect 高</h4><p>send 用于向进程发送字符串</p>
<p>expect 从进程接收字符串</p>
<p>spawn 启动新的进程</p>
<p>interact 允许用户交互</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">expect &#123;</span><br><span class="line">    &quot;password&quot; &#123;</span><br><span class="line">        send &quot;$password\r&quot;</span><br><span class="line">        exp_continue</span><br><span class="line">    &#125;</span><br><span class="line">    eof</span><br><span class="line">    &#123;</span><br><span class="line">        send &quot;eof&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-如何去除字符串中的所有空格-中"><a href="#3-如何去除字符串中的所有空格-中" class="headerlink" title="3. 如何去除字符串中的所有空格 ? 中"></a>3. 如何去除字符串中的所有空格 ? 中</h4><p>echo $string|tr -d “ “</p>
<p>echo $string|sed “s/ //g”.</p>
<p>echo $string|awk ‘{gsub(/ /,””,$0);print $0}’</p>
<h4 id="4-vim如何上下翻页，到最后一行，跳到上、下一个单词，删除两行-如何插入-中-高"><a href="#4-vim如何上下翻页，到最后一行，跳到上、下一个单词，删除两行-如何插入-中-高" class="headerlink" title="4. vim如何上下翻页，到最后一行，跳到上、下一个单词，删除两行, 如何插入 中-高"></a>4. vim如何上下翻页，到最后一行，跳到上、下一个单词，删除两行, 如何插入 中-高</h4><p>ctrl f b 上下半页<br>ctrl u d 上下整页<br>b w 上下个单词<br>2dd 删除两行</p>
<p>a 在光标后插入文本<br>A 在当前行末插入文本<br>i 在光标前插入文本<br>I 在当前行前插入文本<br>o 在当前行的下边插入新行<br>O 在当前行的上边插入新行</p>
<h4 id="5-查询进程-中"><a href="#5-查询进程-中" class="headerlink" title="5. 查询进程 中"></a>5. 查询进程 中</h4><p>ps -A | grep java<br>USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND</p>
<p>root 12368 5.1 1.6 3065312 815148 ? Sl Jun30 745:28 /usr/lib/virtualbox</p>
<p>USER 进程的用户</p>
<p>pid 进程的ID</p>
<p>%CPU 进程占用的CPU百分比；</p>
<p>%MEM 占用内存的百分比；</p>
<p>VSZ 该进程使用的虚拟内存量（KB）；</p>
<p>RSS 该进程占用的固定内存量（KB）；</p>
<p><strong>STAT</strong>状态位常见的状态字符</p>
<p>D 无法中断的休眠状态（通常 IO 的进程）；</p>
<p>R 正在运行可中在队列中可过行的；</p>
<p>S 处于休眠状态；</p>
<p>T 停止或被追踪；</p>
<p>W 进入内存交换 （从内核2.6开始无效）；</p>
<p>X 死掉的进程 （基本很少见）；</p>
<p>Z 僵尸进程；</p>
<h4 id="6-获取CPU内存等硬件信息-高"><a href="#6-获取CPU内存等硬件信息-高" class="headerlink" title="6. 获取CPU内存等硬件信息 高"></a>6. 获取CPU内存等硬件信息 高</h4><p>cat /proc/cpuinfo | grep name | cut -f2 -d: |uniq -c cpu型号</p>
<p>grep ‘physical id’ /proc/cpuinfo | sort | uniq | wc -l cpu逻辑核个数</p>
<p>工具dmidecode</p>
<p>sudo dmidecode -t memory</p>
<p>看内存的插槽数,已经使用多少插槽.每条内存多大</p>
<p>sudo dmidecode -t memory | grep Size</p>
<p>查看服务器型号、序列号</p>
<p>sudo dmidecode | grep “System Information” -A9 | egrep “Manufacturer|Product|Serial”</p>
<p>cat /proc/meminfo | grep MemTotal 内存</p>
<p>lspci</p>
<h4 id="7-查看内存资源-中"><a href="#7-查看内存资源-中" class="headerlink" title="7. 查看内存资源 中"></a>7. 查看内存资源 中</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#内存</span><br><span class="line">free -m </span><br><span class="line">              total        used        free      shared     buffers       cache   available&lt;br&gt; </span><br><span class="line">Mem:       49256832    37623856     2793324      512860           0     8839652    10623008&lt;br&gt; </span><br><span class="line">Swap:      12504060     1671468    10832592&lt;br&gt;</span><br></pre></td></tr></table></figure>
<p>used：已使用的内存大小，这个值包括了 cached 和 应用程序实际使用的内存</p>
<p>free：未被使用的内存大小</p>
<p>shared：共享内存大小，是进程间通信的一种方式</p>
<p>buffers：被<strong>缓冲区</strong>占用的内存大小（硬盘）</p>
<p>cached：被<strong>缓存占</strong>用的内存大小 （程序）</p>
<h4 id="8-什么是cpu负载和使用率，怎么查看？高"><a href="#8-什么是cpu负载和使用率，怎么查看？高" class="headerlink" title="8. 什么是cpu负载和使用率，怎么查看？高"></a>8. 什么是cpu负载和使用率，怎么查看？高</h4><p>load average/使用率 一定时间内系统的平均负荷 单核0-100%</p>
<p>负载 显示的是一段时间内正在使用和等待使用CPU的平均任务数，使用率100%，同时处理两个程序，那么负载为2</p>
<p>uptime</p>
<p>top</p>
<h4 id="9-查看硬盘读写状态-中-高"><a href="#9-查看硬盘读写状态-中-高" class="headerlink" title="9. 查看硬盘读写状态 中-高"></a>9. 查看硬盘读写状态 中-高</h4><p>iostat -x<br>rrqm/s: 每秒进行 merge 的读操作数目。即 delta(rmerge)/s</p>
<p>wrqm/s: 每秒进行 merge 的写操作数目。即 delta(wmerge)/s</p>
<p>r/s: 每秒完成的读 I/O 设备次数。即 delta(rio)/s</p>
<p>w/s: 每秒完成的写 I/O 设备次数。即 delta(wio)/s</p>
<p>rsec/s: 每秒读扇区数。即 delta(rsect)/s</p>
<p>wsec/s: 每秒写扇区数。即 delta(wsect)/s</p>
<p>rkB/s: 每秒读K字节数。是 rsect/s 的一半，因为每扇区大小为512字节。(需要计算)</p>
<p>wkB/s: 每秒写K字节数。是 wsect/s 的一半。(需要计算)</p>
<p>%util: 一秒中有百分之多少的时间用于 I/O 操作</p>
<h4 id="10-其他命令-低-中"><a href="#10-其他命令-低-中" class="headerlink" title="10. 其他命令 低-中"></a>10. 其他命令 低-中</h4><p>检查网络</p>
<p>nc</p>
<p>telnet</p>
<p>查看网卡</p>
<p>ifconfig</p>
<p>ip a</p>
<h4 id="11-添加eth1-网卡-10-0-0-0-16-到10-0-0-1-的路由"><a href="#11-添加eth1-网卡-10-0-0-0-16-到10-0-0-1-的路由" class="headerlink" title="11. 添加eth1 网卡 10.0.0.0/16 到10.0.0.1 的路由"></a>11. 添加eth1 网卡 10.0.0.0/16 到10.0.0.1 的路由</h4><p>route add -net 203.208.39.104 netmask 255.255.255.255 gw 192.168.1.1 dev eth1</p>
<p>total：物理内存大小，就是机器实际的内存</p>
<h3 id="2-Python"><a href="#2-Python" class="headerlink" title="2. Python"></a>2. Python</h3><h4 id="1-python如何获取执行shell命令"><a href="#1-python如何获取执行shell命令" class="headerlink" title="1. python如何获取执行shell命令"></a>1. python如何获取执行shell命令</h4><p><code>os.system()</code></p>
<p>原理</p>
<p>1 fork一个子进程；</p>
<p>2 在子进程中调用exec函数去执行命令；</p>
<p>3 在父进程中调用wait（阻塞）去等待子进程结束</p>
<p><code>os.popen()</code><br>这种调用方式是通过管道的方式来实现，函数返回是 file read 的对象，对其进行读取read、readlines等操作可以看到执行的输出。</p>
<p>推荐使用</p>
<p><code>subprocess.Popen()</code></p>
<h4 id="2-python如何优雅的退出"><a href="#2-python如何优雅的退出" class="headerlink" title="2. python如何优雅的退出"></a>2. python如何优雅的退出</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 子进程退出后向父进程发送的信号</span><br><span class="line"> signal.signal(signal.SIGCHLD, onSigChld)</span><br><span class="line"># 主进程退出信号</span><br><span class="line"> signal.signal(signal.SIGINT, onSigInt)</span><br></pre></td></tr></table></figure>
<h4 id="3-如何拼接字符串"><a href="#3-如何拼接字符串" class="headerlink" title="3. 如何拼接字符串"></a>3. 如何拼接字符串</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">str_list=[&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;]</span><br><span class="line">&#x27;&#x27;.join(str_list)</span><br></pre></td></tr></table></figure>
<h4 id="4-python的构造函数"><a href="#4-python的构造函数" class="headerlink" title="4. python的构造函数"></a>4. python的构造函数</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">per = Person（）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def  __ init__(self,arg1,arg2,...):</span><br><span class="line">函数体</span><br></pre></td></tr></table></figure>
<h4 id="5-json和字典的区别"><a href="#5-json和字典的区别" class="headerlink" title="5. json和字典的区别"></a>5. json和字典的区别</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">d = &#123;&#x27;s&#x27;:&#x27;you&#x27;,&#x27;d&#x27;:&#x27;are&#x27;&#125;   #给一个字典</span><br><span class="line">j = json.dumps(d)</span><br><span class="line">type(j)</span><br><span class="line">str   #已经转化为json字符串</span><br><span class="line">d1 = json.loads(j)</span><br><span class="line">type(d1)</span><br><span class="line">dic  #已经将json字符串转化为字典了</span><br></pre></td></tr></table></figure>
<p>字典是一个数据的结构，而json只是一个具有一定规则的字符串，方便在不同平台上处理其中包含的数据。</p>
<h2 id="3-Docker面试题"><a href="#3-Docker面试题" class="headerlink" title="3. Docker面试题"></a>3. Docker面试题</h2><h4 id="1-如何理解docker-中"><a href="#1-如何理解docker-中" class="headerlink" title="1. 如何理解docker 中"></a>1. 如何理解docker 中</h4><p>docker的本质是进程</p>
<p>PID Namespace</p>
<p>Mount Namespace</p>
<p>Network Namespace</p>
<p>cgroup, namespace和unionFS<br>组成的类似于虚拟机的容器</p>
<h4 id="2-DevOps有哪些优势？-高"><a href="#2-DevOps有哪些优势？-高" class="headerlink" title="2. DevOps有哪些优势？ 高"></a>2. DevOps有哪些优势？ 高</h4><p>技术优势：</p>
<p>持续的软件交付<br>修复不太复杂的问题<br>更快地解决问题<br>商业利益：</p>
<p>更快速地传递功能<br>更稳定的操作环境<br>有更多时间可以增加价值（而不是修复/维护）</p>
<p>CI（持续集成）服务器的功能是什么？</p>
<p>CI服务器功能是不断地集成所有正在进行的更改并由不同的开发人员提交到存储库，并检查编译错误。它需要每天多次构建代码，最好是在每次提交之后，以便它可以检测在问题发生时是哪个提交Bug了。</p>
<h4 id="3-Docker内的服务使用的内核在哪"><a href="#3-Docker内的服务使用的内核在哪" class="headerlink" title="3. Docker内的服务使用的内核在哪"></a>3. Docker内的服务使用的内核在哪</h4><p>内核直接使用宿主机的docker，开发和生产之间要保持内核的一致性<br>windows服务器上的内核，必须支持虚拟化。否则需要使用vitrualbox的linux虚拟机</p>
<h4 id="4-如何停止并删除一个docker"><a href="#4-如何停止并删除一个docker" class="headerlink" title="4. 如何停止并删除一个docker"></a>4. 如何停止并删除一个docker</h4><p>|</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker ps |grep docker-server-name</span><br><span class="line">docker stop docker-server-name</span><br><span class="line">docker rm docker-server-name</span><br></pre></td></tr></table></figure>
<h4 id="5-如何清理docker数据目录"><a href="#5-如何清理docker数据目录" class="headerlink" title="5. 如何清理docker数据目录"></a>5. 如何清理docker数据目录</h4><p>sudo docker system prune -af</p>
<p>会清理不用的镜像、容器</p>
<h3 id="kubernets"><a href="#kubernets" class="headerlink" title="kubernets"></a>kubernets</h3><h4 id="1-什么是-Kubernetes？"><a href="#1-什么是-Kubernetes？" class="headerlink" title="1. 什么是 Kubernetes？"></a>1. 什么是 Kubernetes？</h4><p>Kubernetes 是一个开源容器管理工具，负责容器部署，容器扩缩容以及负载平衡。</p>
<h4 id="2-什么是-Kubelet？"><a href="#2-什么是-Kubelet？" class="headerlink" title="2. 什么是 Kubelet？"></a>2. 什么是 Kubelet？</h4><p>这是一个代理服务，它在每个节点上运行，并使从服务器与主服务器通信。因此，Kubelet 处理 PodSpec 中提供给它的容器的描述，并确保 PodSpec 中描述的容器运行正常</p>
<h4 id="3-什么是pod"><a href="#3-什么是pod" class="headerlink" title="3. 什么是pod"></a>3. 什么是pod</h4><p>一个Pod（就像一群鲸鱼，或者一个豌豆夹）相当于一个共享context的配置组，在同一个context下，应用可能还会有独立的cgroup隔离机制，一个Pod是一个容器环境下的“逻辑主机”，它可能包含一个或者多个紧密相连的应用，这些应用可能是在同一个物理主机或虚拟机上。</p>
<p>Pod 的context可以理解成多个linux命名空间的联合</p>
<p>PID 命名空间（同一个Pod中应用可以看到其它进程）<br>网络 命名空间（同一个Pod的中的应用对相同的IP地址和端口有权限）<br>IPC 命名空间（同一个Pod中的应用可以通过VPC或者POSIX进行通信）<br>UTS 命名空间（同一个Pod中的应用共享一个主机名称）</p>
<h4 id="4-pod的生命周期"><a href="#4-pod的生命周期" class="headerlink" title="4. pod的生命周期"></a>4. pod的生命周期</h4><p>od被安排到结点上，并且保持在这个节点上直到被终止（根据重启的设定）或者被删除，当一个节点死掉之后，上面的所有Pod均会被删除。特殊的Pod永远不会被转移到的其他的节点，作为替代，他们必须被replace.</p>
<h4 id="5-k8s的跨主机通信原理是什么"><a href="#5-k8s的跨主机通信原理是什么" class="headerlink" title="5. k8s的跨主机通信原理是什么"></a>5. k8s的跨主机通信原理是什么</h4><p>node network：承载kubernetes集群中各个“物理”Node(master和minion)通信的网络；<br>service network：由kubernetes集群中的Services所组成的“网络”；<br>flannel network： 即Pod网络，集群中承载各个Pod相互通信的网络。</p>
<p>flannel 是二层的，那么三层网络使用什么<br>Calico 是一个三层的数据中心网络方案，而且方便集成 OpenStack 这种 IaaS 云架构，能够提供高效可控的 VM、容器、裸机之间的通信。<br>缺点是什么？<br>每台机器都配所有服务器路由，当大于（规定）100台，网络负载会非常高<br>那么使用 BGP Client(BIRD)<br>大规模部署时使用，摒弃所有节点互联的 mesh 模式，通过一个或者多个BGP Route Reflector来完成集中式的路由分发</p>
<h4 id="6-Replica-Set-和-Replication-Controller之间有什么区别？"><a href="#6-Replica-Set-和-Replication-Controller之间有什么区别？" class="headerlink" title="6. Replica Set 和 Replication Controller之间有什么区别？"></a>6. Replica Set 和 Replication Controller之间有什么区别？</h4><p>Replica Set 和 Replication Controller几乎完全相同。它们都确保在任何给定时间运行指定数量的pod副本。不同之处在于复制pod使用的选择器。Replica Set使用基于集合的选择器，而Replication Controller使用基于权限的选择器。</p>
<h2 id="4-中间件集群"><a href="#4-中间件集群" class="headerlink" title="4. 中间件集群"></a>4. 中间件集群</h2><p>哨兵至少需要 3 个实例，来保证自己的健壮性。<br>哨兵 + redis 主从的部署架构，是不保证数据零丢失的，只能保证 redis 集群的高可用性。<br>对于哨兵 + redis 主从这种复杂的部署架构，尽量在测试环境和生产环境，都进行充足的测试和演</p>
<h4 id="6-官方Redis-Cluster-方案-服务端路由查询"><a href="#6-官方Redis-Cluster-方案-服务端路由查询" class="headerlink" title="6 官方Redis Cluster 方案(服务端路由查询)"></a>6 官方Redis Cluster 方案(服务端路由查询)</h4><p>方案说明</p>
<ul>
<li>通过哈希的方式，将数据分片，每个节点均分存储一定哈希槽(哈希值)区间的数据，默认分配了16384 个槽位</li>
<li>每份数据分片会存储在多个互为主从的多节点上</li>
<li>数据写入先写主节点，再同步到从节点(支持配置为阻塞同步)</li>
<li>同一分片多个节点间的数据不保持一致性</li>
<li>读取数据时，当客户端操作的key没有分配在该节点上时，redis会返回转向指令，指向正确的节点</li>
<li>扩容时时需要需要把旧节点的数据迁移一部分到新节点</li>
</ul>
<h4 id="7-Redis-主从架构"><a href="#7-Redis-主从架构" class="headerlink" title="7 Redis 主从架构"></a>7 Redis 主从架构</h4><h4 id="8-Redis是单线程的，如何提高多核CPU的利用率？"><a href="#8-Redis是单线程的，如何提高多核CPU的利用率？" class="headerlink" title="8. Redis是单线程的，如何提高多核CPU的利用率？"></a>8. Redis是单线程的，如何提高多核CPU的利用率？</h4><h4 id="1-什么是Redis"><a href="#1-什么是Redis" class="headerlink" title="1 什么是Redis"></a>1 什么是Redis</h4><p>Redis 可以存储键和五种不同类型的值之间的映射。键的类型只能为字符串，值支持五种数据类型：字符串、列表、集合、散列表、有序集合。</p>
<h4 id="2-Redis有哪些优缺点"><a href="#2-Redis有哪些优缺点" class="headerlink" title="2 Redis有哪些优缺点"></a>2 Redis有哪些优缺点</h4><p>优点</p>
<p>读写性能优异， Redis能读的速度是110000次/s，写的速度是81000次/s。<br>支持数据持久化，支持AOF和RDB两种持久化方式。<br>支持事务，Redis的所有操作都是原子性的，同时Redis还支持对几个操作合并后的原子性执行。<br>数据结构丰富，除了支持string类型的value外还支持hash、set、zset、list等数据结构。<br>支持主从复制，主机会自动将数据同步到从机，可以进行读写分离。<br>缺点</p>
<p>数据库容量受到物理内存的限制，不能用作海量数据的高性能读写，因此Redis适合的场景主要局限在较小数据量的高性能操作和运算上。<br>Redis 不具备自动容错和恢复功能，主机从机的宕机都会导致前端部分读写请求失败，需要等待机器重启或者手动切换前端的IP才能恢复。<br>主机宕机，宕机前有部分数据未能及时同步到从机，切换IP后还会引入数据不一致的问题，降低了系统的可用性。<br>Redis 较难支持在线扩容，在集群容量达到上限时在线扩容会变得很复杂。为避免这一问题，运维人员在系统上线时必须确保有足够的空间，这对资源造成了很大的浪费。</p>
<h4 id="3-为什么要用-Redis-为什么要用缓存"><a href="#3-为什么要用-Redis-为什么要用缓存" class="headerlink" title="3 为什么要用 Redis /为什么要用缓存"></a>3 为什么要用 Redis /为什么要用缓存</h4><p>主要从“高性能”和“高并发”这两点来看待这个问题。<br>高性能：<br>假如用户第一次访问数据库中的某些数据。这个过程会比较慢，因为是从硬盘上读取的。将该用户访问的数据存在数缓存中，这样下一次再访问这些数据的时候就可以直接从缓存中获取了。操作缓存就是直接操作内存，所以速度相当快。<br>高并发：<br>直接操作缓存能够承受的请求是远远大于直接访问数据库的，所以我们可以考虑把数据库中的部分数据转移到缓存中去，这样用户的一部分请求会直接到缓存这里而不用经过数据库。</p>
<h4 id="4-MySQL里有2000w数据，redis中只存20w的数据，如何保证redis中的数据都是热点数据"><a href="#4-MySQL里有2000w数据，redis中只存20w的数据，如何保证redis中的数据都是热点数据" class="headerlink" title="4 MySQL里有2000w数据，redis中只存20w的数据，如何保证redis中的数据都是热点数据"></a>4 MySQL里有2000w数据，redis中只存20w的数据，如何保证redis中的数据都是热点数据</h4><p>Redis的内存淘汰策略有哪些<br>Redis的内存淘汰策略是指在Redis的用于缓存的内存不足时，怎么处理需要新写入且需要申请额外空间的数据。</p>
<p>全局的键空间选择性移除<br>noeviction：当内存不足以容纳新写入数据时，新写入操作会报错。<br>allkeys-lru：当内存不足以容纳新写入数据时，在键空间中，移除最近最少使用的key。（这个是最常用的）<br>allkeys-random：当内存不足以容纳新写入数据时，在键空间中，随机移除某个key。<br>设置过期时间的键空间选择性移除<br>volatile-lru：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，移除最近最少使用的key。<br>volatile-random：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，随机移除某个key。<br>volatile-ttl：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，有更早过期时间的key优先移除。</p>
<h4 id="5-哨兵模式"><a href="#5-哨兵模式" class="headerlink" title="5 哨兵模式"></a>5 哨兵模式</h4><p>哨兵的介绍<br>sentinel，中文名是哨兵。哨兵是 redis 集群机构中非常重要的一个组件，主要有以下功能：</p>
<ul>
<li>集群监控：负责监控 redis master 和 slave 进程是否正常工作。</li>
<li>消息通知：如果某个 redis 实例有故障，那么哨兵负责发送消息作为报警通知给管理员。</li>
<li>故障转移：如果 master node 挂掉了，会自动转移到 slave node 上。</li>
<li>配置中心：如果故障转移发生了，通知 client 客户端新的 master 地址。<br>哨兵用于实现 redis 集群的高可用，本身也是分布式的，作为一个哨兵集群去运行，互相协同工作。</li>
</ul>
<p>故障转移时，判断一个 master node 是否宕机了，需要大部分的哨兵都同意才行，涉及到了分布式选举的问题。<br>即使部分哨兵节点挂掉了，哨兵集群还是能正常工作的，因为如果一个作为高可用机制重要组成部分的故障转移系统本身是单点的，那就很坑爹了。<br>哨兵的核心知识</p>
<p>哨兵至少需要 3 个实例，来保证自己的健壮性。<br>哨兵 + redis 主从的部署架构，是不保证数据零丢失的，只能保证 redis 集群的高可用性。<br>对于哨兵 + redis 主从这种复杂的部署架构，尽量在测试环境和生产环境，都进行充足的测试和演</p>
<h4 id="6-官方Redis-Cluster-方案-服务端路由查询-1"><a href="#6-官方Redis-Cluster-方案-服务端路由查询-1" class="headerlink" title="6 官方Redis Cluster 方案(服务端路由查询)"></a>6 官方Redis Cluster 方案(服务端路由查询)</h4><p>方案说明</p>
<ul>
<li>通过哈希的方式，将数据分片，每个节点均分存储一定哈希槽(哈希值)区间的数据，默认分配了16384 个槽位</li>
<li>每份数据分片会存储在多个互为主从的多节点上</li>
<li>数据写入先写主节点，再同步到从节点(支持配置为阻塞同步)</li>
<li>同一分片多个节点间的数据不保持一致性</li>
<li>读取数据时，当客户端操作的key没有分配在该节点上时，redis会返回转向指令，指向正确的节点</li>
<li>扩容时时需要需要把旧节点的数据迁移一部分到新节点</li>
</ul>
<h4 id="7-Redis-主从架构-1"><a href="#7-Redis-主从架构-1" class="headerlink" title="7 Redis 主从架构"></a>7 Redis 主从架构</h4><h4 id="8-Redis是单线程的，如何提高多核CPU的利用率？-1"><a href="#8-Redis是单线程的，如何提高多核CPU的利用率？-1" class="headerlink" title="8. Redis是单线程的，如何提高多核CPU的利用率？"></a>8. Redis是单线程的，如何提高多核CPU的利用率？</h4><p>可以在同一个服务器部署多个Redis的实例，并把他们当作不同的服务器来使用，在某些时候，无论如何一个服务器是不够的， 所以，如果你想使用多个CPU，你可以考虑一下分片（shard）</p>
<h1 id="sl版-融合中"><a href="#sl版-融合中" class="headerlink" title="sl版 融合中"></a>sl版 融合中</h1><p>环境部分</p>
<ol>
<li>当前公司主要业务是什么？</li>
<li>上家公司负责那部分？团队人数多少？</li>
</ol>
<p>基础部分</p>
<ol>
<li>sh与bash区别；</li>
<li>如果只有root用户权限，但无root密码，如何做到服务器之间的文件拷贝？</li>
<li>top中的各项是意思？</li>
<li>如何做到机器重启自动挂载磁盘？</li>
<li>TCP的交互过程，UDP与TCP的区别是什么？</li>
<li>如何测试TCP端口是否正常？如何测试UDP端口是否正常？</li>
<li>nfs的工作原理是什么？</li>
</ol>
<p>应用部分</p>
<ol>
<li>keepalived的工作原理，如何做健康检查？</li>
<li>HAProxy的工作原理是什么？与nginx的区别是什么？</li>
<li>nginx的功能是什么？描述下反向代理的过程；</li>
<li>MySQL的主从同步过程是什么样的，常见的MySQL的高可用有几种方案，描述原理；</li>
<li>redis高可用方案是什么？如何做到redis重启数据不丢失；</li>
</ol>
<p>docker部分</p>
<ol>
<li>Docker与虚拟机有何不同？</li>
<li>docker镜像是什么？描述下拉取镜像的过程；</li>
<li>容器是什么？容器状态有几种？查看容器状态的命令是什么？如何进入容器内部？</li>
<li>docker-compose是什么？</li>
<li>容器内时间与外部时间不一致怎么办？</li>
<li>docker内部用户与外部用户的关系是什么？</li>
</ol>
<p>SIP部分</p>
<ol>
<li>SIP信令常见的响应消息有几种？一个完整的通话过程中，信令交互的过程是什么样的？</li>
<li>SDP是什么？</li>
<li>RTP是如何工作的？RTCP是什么？通话中的单通现象是怎么产生的？通话断续什么什么原因？</li>
<li>如何利用wireshark分析呼叫是否正常？</li>
</ol>
<p>职业部分</p>
<ol>
<li>离职原因？</li>
<li>你认为运维工程师的职责是什么？</li>
<li>升级某个服务时，是保障升级过程可回滚的？</li>
</ol>
<p>运维的挑战</p>
<p>我们聊下运维岗位面临的一些挑战。</p>
<p>一是基础资源从集中式向云化转变。</p>
<p>传统的集中式基础资源，讲求的是单体的性能和稳定性，思考问题的方式是纵向的。但是在基于分布式的云化基础设施下，运维人员需要考虑的是云资源池的故障域要如何划分、云资源池的规模要如何设计、不同环境的资源池要如何隔离、资源的超售比设置为多少、资源的标准化要如何设计、云化资源池中不同范围的故障发生后，如何保证继续提供可靠的服务，这些都是云化以后运维人员需要考虑的。</p>
<p>二是运维前置。</p>
<p>笔者发现，有些公司运维人员做的事情太过于底层，只负责OS层及以下的部分，对应用层的运维完全不懂，以致于在应用出现问题的时候，看起来都是开发在排查问题，给领导的感觉会比较差。同时，随着云计算的普及，OS层以下的内容，后续很可能直接被云服务商托管掉，就类似现在很多公司使用的托管机房，以及很多创业公司直接使用公有云，极端情况下，就可能导致运维人员下岗。</p>
<p>因此，运维人员应该让自己的技能前置，例如，对于java技术栈为主的公司，对于运维人员而言最好是要学习java虚拟机的相关知识和技能，这样在java程序出现问题的时候能够快速定位问题，而不是强依赖开发人员。</p>
<p>三是容器运维。</p>
<p>容器平台在被大量使用以后，一定会带来运维问题，但是容器平台的运维模式和基于虚拟机的运维模式是完全不同的，这就需要运维人员能够熟悉容器平台的运行机制，对容器有理论上的知识储备以及实际的运维能力，而这项技能对传统运维人员而言基本就是全新的领域。</p>
<p>四是开源软件的运维。</p>
<p>前文提到了架构师需要对开源软件的引入进行专业的评估和把控，那么对于引入进来的开源软件的运维工作就落到了运维人员头上。传统的公司的运维，一般都会买一些外部的运维服务，而这些运维服务大多数也都是针对传统的商用软件而不是开源软件。因此在引入开源软件以后，对于运维人员而言，原来可以依靠的外部服务没有了，自己就需要去能够具备运维开源软件的能力，这里要投入的学习成本是相当高的，并且没有一个所谓的“掌握”标准。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Chenhan Hank</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">76</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">79</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chenhan Hank</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
