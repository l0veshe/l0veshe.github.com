<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="止乎于静">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="止乎于静">
<meta property="og:locale">
<meta property="article:author" content="Chenhan Hank">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'default'
  };
</script>

  <title>止乎于静</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">止乎于静</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/07/k8s-1-18-%E5%9B%BD%E6%9C%8D%E5%AE%89%E8%A3%85%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/07/k8s-1-18-%E5%9B%BD%E6%9C%8D%E5%AE%89%E8%A3%85%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">k8s 1.18 国服安装笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-07 23:21:19" itemprop="dateCreated datePublished" datetime="2021-09-07T23:21:19+08:00">2021-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-02-23 00:01:54" itemprop="dateModified" datetime="2022-02-23T00:01:54+08:00">2022-02-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-系统准备"><a href="#1-系统准备" class="headerlink" title="1 系统准备"></a>1 系统准备</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# cat /etc/centos-release</span><br><span class="line">CentOS Linux release 7.8.2003 (Core)</span><br></pre></td></tr></table></figure>
<h2 id="2-配置固定ip"><a href="#2-配置固定ip" class="headerlink" title="2 配置固定ip"></a>2 配置固定ip</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# cat /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">#BOOTPROTO=dhcp</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens33</span><br><span class="line">UUID=2cb41960-5518-4366-8aa9-3b387ab22468</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=192.168.232.201</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=192.168.232.2</span><br></pre></td></tr></table></figure>
<h2 id="3-添加阿里源"><a href="#3-添加阿里源" class="headerlink" title="3 添加阿里源"></a>3 添加阿里源</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# rm -rfv /etc/yum.repos.d/*</span><br><span class="line">[root@k8s1 ~]# curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br></pre></td></tr></table></figure>
<h2 id="4-配置主机名"><a href="#4-配置主机名" class="headerlink" title="4 配置主机名"></a>4 配置主机名</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# cat /etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.232.201 k8s1.hank.im</span><br><span class="line">192.168.232.202 k8s2.hank.im</span><br></pre></td></tr></table></figure>
<h2 id="5-关闭swap，注释swap分区"><a href="#5-关闭swap，注释swap分区" class="headerlink" title="5 关闭swap，注释swap分区"></a>5 关闭swap，注释swap分区</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# swapoff -a</span><br><span class="line">[root@k8s1 ~]# sed -i &#x27;/swap/d&#x27; /etc/fstab</span><br></pre></td></tr></table></figure>
<h2 id="6-配置内核参数，将桥接的IPv4流量传递到iptables的链"><a href="#6-配置内核参数，将桥接的IPv4流量传递到iptables的链" class="headerlink" title="6 配置内核参数，将桥接的IPv4流量传递到iptables的链"></a>6 配置内核参数，将桥接的IPv4流量传递到iptables的链</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">sysctl --system</span><br><span class="line">[root@k8s1 ~]# setenforce 0</span><br><span class="line">[root@k8s1 ~]# sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27;  /etc/selinux/config</span><br></pre></td></tr></table></figure>
<h2 id="7-安装常用包"><a href="#7-安装常用包" class="headerlink" title="7 安装常用包"></a>7 安装常用包</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# yum install vim bash-completion net-tools gcc -y</span><br><span class="line">[root@k8s1 ~]# yum group install Development Tools -y</span><br></pre></td></tr></table></figure>
<h2 id="7-5-插入一条-ulimit-修改"><a href="#7-5-插入一条-ulimit-修改" class="headerlink" title="7.5 插入一条 ulimit 修改"></a>7.5 插入一条 ulimit 修改</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 重启后生效</span><br><span class="line">[root@k8s1 ~]# cat &gt;&gt; /etc/security/limits.conf &lt;&lt; EOF</span><br><span class="line">*             soft    nofile         204800</span><br><span class="line">*             hard    nofile         204800</span><br><span class="line">*             soft    nproc          204800</span><br><span class="line">*             hard    nproc          204800</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[root@k8s1 ~]# cat &gt; /etc/security/limits.d/20-nproc.conf &lt;&lt; EOF</span><br><span class="line">*          soft    nproc     204800</span><br><span class="line">root       soft    nproc     unlimited</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 立即生效</span><br><span class="line">[root@k8s1 ~]# ulimit -SHn 204800</span><br><span class="line">[root@k8s1 ~]# ulimit -SHq 819200</span><br><span class="line">[root@k8s1 ~]# ulimit -SHu 204800</span><br><span class="line"></span><br><span class="line"># 查看</span><br><span class="line">[root@k8s2 ~]# ulimit -a </span><br><span class="line"></span><br><span class="line"># cat /proc/$PID/limits  如果看到Max open files 65535 65535 files 则说明配置已生效</span><br></pre></td></tr></table></figure>
<h2 id="8-查看时间是否正确"><a href="#8-查看时间是否正确" class="headerlink" title="8 查看时间是否正确"></a>8 查看时间是否正确</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# yum install ntpdate -y</span><br><span class="line">[root@k8s1 ~]# ntpdate -u time1.cloud.tencent.com </span><br><span class="line">[root@k8s1 ~]# echo &quot;*/20 * * * * /usr/sbin/ntpdate -u time1.cloud.tencent.com  &gt;/dev/null &amp;&quot; &gt;&gt; /var/spool/cron/root</span><br><span class="line">16 Aug 08:48:33 ntpdate[109431]: step time server 114.118.7.161 offset 352572.538751 sec</span><br></pre></td></tr></table></figure>
<h2 id="9-使用aliyun源安装docker-ce"><a href="#9-使用aliyun源安装docker-ce" class="headerlink" title="9 使用aliyun源安装docker-ce"></a>9 使用aliyun源安装docker-ce</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">[root@k8s1 ~]# yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docke</span><br><span class="line">r-ce.repo</span><br><span class="line">[root@k8s1 ~]# yum -y install docker-ce</span><br><span class="line">[root@k8s1 ~]# mkdir -p /etc/docker</span><br><span class="line">[root@k8s1 ~]# cat /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;graph&quot;: &quot;/data/docker&quot;,</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://x9o4p9lt.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">[root@k8s1 ~]# systemctl daemon-reload</span><br><span class="line">[root@k8s1 ~]# systemctl restart docker</span><br><span class="line">[root@k8s1 ~]# systemctl enable docker</span><br><span class="line">[root@k8s1 ~]# systemctl stop firewalld</span><br><span class="line">[root@k8s1 ~]# systemctl disable firewalld</span><br></pre></td></tr></table></figure>
<h2 id="10-装kubectl、kubelet、kubeadm"><a href="#10-装kubectl、kubelet、kubeadm" class="headerlink" title="10 装kubectl、kubelet、kubeadm"></a>10 装kubectl、kubelet、kubeadm</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line">[root@k8s1 ~]# yum install -y kubectl-1.18.6 kubelet-1.18.6 kubeadm-1.18.6</span><br><span class="line">[root@k8s1 ~]# systemctl enable kubelet</span><br></pre></td></tr></table></figure>
<h2 id="11-初始化安装集群"><a href="#11-初始化安装集群" class="headerlink" title="11 初始化安装集群"></a>11 初始化安装集群</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># --apiserver-advertise-address 本机地址</span><br><span class="line">kubeadm init --kubernetes-version=1.18.0  --apiserver-advertise-address=192.168.232.201  --image-repository registry.aliyuncs.com/google_containers  </span><br><span class="line">  --service-cidr=192.168.0.0/16 --pod-network-cidr=192.169.0.0/16   # 互无联系</span><br><span class="line">...</span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line">[root@k8s1 ~]# mkdir -p $HOME/.kube</span><br><span class="line">[root@k8s1 ~]# sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">[root@k8s1 ~]# sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line">[root@k8s1 ~]# source &lt;(kubectl completion bash)</span><br></pre></td></tr></table></figure>
<h2 id="12-查看节点-pod"><a href="#12-查看节点-pod" class="headerlink" title="12 查看节点 pod"></a>12 查看节点 pod</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">NAME                STATUS     ROLES    AGE     VERSION</span><br><span class="line">master01.paas.com   NotReady   master   2m29s   v1.18.0</span><br><span class="line">[root@master01 ~]# kubectl get pod --all-namespaces</span><br><span class="line">NAMESPACE     NAME                                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   coredns-7ff77c879f-fsj9l                    0/1     Pending   0          2m12s</span><br><span class="line">kube-system   coredns-7ff77c879f-q5ll2                    0/1     Pending   0          2m12s</span><br><span class="line">kube-system   etcd-master01.paas.com                      1/1     Running   0          2m22s</span><br><span class="line">kube-system   kube-apiserver-master01.paas.com            1/1     Running   0          2m22s</span><br><span class="line">kube-system   kube-controller-manager-master01.paas.com   1/1     Running   0          2m22s</span><br><span class="line">kube-system   kube-proxy-th472                            1/1     Running   0          2m12s</span><br><span class="line">kube-system   kube-scheduler-master01.paas.com            1/1     Running   0          2m22s</span><br></pre></td></tr></table></figure>
<h2 id="13-安装calico网络"><a href="#13-安装calico网络" class="headerlink" title="13 安装calico网络"></a>13 安装calico网络</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml</span><br></pre></td></tr></table></figure>
<h2 id="14-再次查看node"><a href="#14-再次查看node" class="headerlink" title="14 再次查看node"></a>14 再次查看node</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# kubectl get pod --all-namespaces</span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   calico-kube-controllers-578894d4cd-8p9xr   1/1     Running   0          5m18s</span><br><span class="line">kube-system   calico-node-czgqs                          1/1     Running   0          5m19s</span><br><span class="line">kube-system   coredns-7ff77c879f-f6p5r                   1/1     Running   0          4d10h</span><br><span class="line">kube-system   coredns-7ff77c879f-p2xl8                   1/1     Running   0          4d10h</span><br><span class="line">kube-system   etcd-k8s1.hank.im                          1/1     Running   0          4d10h</span><br><span class="line">kube-system   kube-apiserver-k8s1.hank.im                1/1     Running   0          4d10h</span><br><span class="line">kube-system   kube-controller-manager-k8s1.hank.im       1/1     Running   0          4d10h</span><br><span class="line">kube-system   kube-proxy-qjczn                           1/1     Running   0          4d10h</span><br><span class="line">kube-system   kube-scheduler-k8s1.hank.im                1/1     Running   0          4d10h</span><br><span class="line">[root@k8s1 ~]#</span><br></pre></td></tr></table></figure>
<h2 id="15-如果报错，查看日志"><a href="#15-如果报错，查看日志" class="headerlink" title="15 如果报错，查看日志"></a>15 如果报错，查看日志</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查日志				</span><br><span class="line">kubectl describe pod/calico-node-28fwk -n kube-system</span><br></pre></td></tr></table></figure>
<h2 id="16-添加dashboard"><a href="#16-添加dashboard" class="headerlink" title="16 添加dashboard"></a>16 添加dashboard</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@master01 ~]# wget  https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-rc7/aio/deploy/recommended.yaml</span><br><span class="line">[root@master01 ~]# vim recommended.yaml</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort   # add</span><br><span class="line">  ports:</span><br><span class="line">    - port: 443</span><br><span class="line">      targetPort: 8443</span><br><span class="line">      nodePort: 30000  # add</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">[root@master01 ~]# kubectl create -f recommended.yaml</span><br><span class="line">namespace/kubernetes-dashboard created</span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">secret/kubernetes-dashboard-csrf created</span><br><span class="line">secret/kubernetes-dashboard-key-holder created</span><br><span class="line">configmap/kubernetes-dashboard-settings created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/dashboard-metrics-scraper created</span><br><span class="line">deployment.apps/dashboard-metrics-scraper created</span><br></pre></td></tr></table></figure>
<h2 id="17-查看状态"><a href="#17-查看状态" class="headerlink" title="17 查看状态"></a>17 查看状态</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]#  kubectl get pods -A</span><br><span class="line">NAMESPACE              NAME                                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system            calico-kube-controllers-578894d4cd-8p9xr    1/1     Running   0          11m</span><br><span class="line">kube-system            calico-node-czgqs                           1/1     Running   0          11m</span><br><span class="line">kube-system            coredns-7ff77c879f-f6p5r                    1/1     Running   0          4d10h</span><br><span class="line">kube-system            coredns-7ff77c879f-p2xl8                    1/1     Running   0          4d10h</span><br><span class="line">kube-system            etcd-k8s1.hank.im                           1/1     Running   0          4d10h</span><br><span class="line">kube-system            kube-apiserver-k8s1.hank.im                 1/1     Running   0          4d10h</span><br><span class="line">kube-system            kube-controller-manager-k8s1.hank.im        1/1     Running   0          4d10h</span><br><span class="line">kube-system            kube-proxy-qjczn                            1/1     Running   0          4d10h</span><br><span class="line">kube-system            kube-scheduler-k8s1.hank.im                 1/1     Running   0          4d10h</span><br><span class="line">kubernetes-dashboard   dashboard-metrics-scraper-dc6947fbf-4ghbd   1/1     Running   0          2m4s</span><br><span class="line">kubernetes-dashboard   kubernetes-dashboard-5d4dc8b976-67lkz       1/1     Running   0          2m4s</span><br><span class="line">[root@k8s1 ~]# kubectl get svc -n kubernetes-dashboard</span><br><span class="line">NAME                        TYPE        CLUSTER-IP        EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">dashboard-metrics-scraper   ClusterIP   192.168.178.170   &lt;none&gt;        8000/TCP        104s</span><br><span class="line">kubernetes-dashboard        NodePort    192.168.26.221    &lt;none&gt;        443:30000/TCP   104s</span><br></pre></td></tr></table></figure>
<h2 id="18-绑定密钥"><a href="#18-绑定密钥" class="headerlink" title="18 绑定密钥"></a>18 绑定密钥</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# kubectl -n kubernetes-dashboard get secret</span><br><span class="line">NAME                               TYPE                                  DATA   AGE</span><br><span class="line">default-token-v7k99                kubernetes.io/service-account-token   3      2m50s</span><br><span class="line">kubernetes-dashboard-certs         Opaque                                0      2m50s</span><br><span class="line">kubernetes-dashboard-csrf          Opaque                                1      2m50s</span><br><span class="line">kubernetes-dashboard-key-holder    Opaque                                2      2m50s</span><br><span class="line">kubernetes-dashboard-token-rz9mn   kubernetes.io/service-account-token   3      2m50s</span><br><span class="line">[root@k8s1 ~]# kubectl describe secrets -n kubernetes-dashboard  kubernetes-dashboard-token-rz9mn  | grep token | awk &#x27;NR==3&#123;print $2&#125;&#x27;</span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IlFyaXppQ1JTYV82TDhoM2N6RjgtS05QeGdlLXc2TURxZFFCdnQ5YmtoV0UifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi1yejltbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjczZjU0YTdmLTU4NWYtNGIwOS1iNTAwLTZlOGIyODlhNGQ0YiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.gNfY2Jysj3o7klavdHzcd055D6E3lAiYwmE8-ldAWKBo7jVX4CsjjJuwXgMAudCJheEILx52TcgDnvh-kwqUH1xQuTR9z4PWGTGAoE58TEnMJFVRc6c3-CB5hX5zJ_gs0knEmrocWx1HADfWQ82KFH-zdUUPiio7osMgEmEE0FcY3hIP62CvQ6URMFiJ9MeOBODKeUijAjYj4qxh11IcnpaDqlkkUfhba7G05Jn__A_xKnbqQ9-ljM0Q3fCrMPCD-60gbzXUO7b7svus1KlP8uQKNUHSQOKzVvK17C89WqWwIqjGhs3SZ9ar1hlwHi0SlpHNGrZeMqryhHVoYhm00g</span><br></pre></td></tr></table></figure>
<h2 id="19-绑定用户资源"><a href="#19-绑定用户资源" class="headerlink" title="19 绑定用户资源"></a>19 绑定用户资源</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# kubectl create clusterrolebinding serviceaccount-cluster-admin --clusterrole=cluster-admin --user=system:serviceaccount:kubernetes-dashboard:kubernetes-dashboard</span><br></pre></td></tr></table></figure>
<p>打开<a href="https://:30000">https://:30000</a><br>输入token 上方一大堆串的字符<br><code>eyJhbGciOiJSUzI1NiIsImtpZCI6IlFyaXppQ1JTYV82TDhoM2N6RjgtS05QeGdlLXc2TURxZFFCdnQ5YmtoV0UifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi1yejltbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjczZjU0YTdmLTU4NWYtNGIwOS1iNTAwLTZlOGIyODlhNGQ0YiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.gNfY2Jysj3o7klavdHzcd055D6E3lAiYwmE8-ldAWKBo7jVX4CsjjJuwXgMAudCJheEILx52TcgDnvh-kwqUH1xQuTR9z4PWGTGAoE58TEnMJFVRc6c3-CB5hX5zJ_gs0knEmrocWx1HADfWQ82KFH-zdUUPiio7osMgEmEE0FcY3hIP62CvQ6URMFiJ9MeOBODKeUijAjYj4qxh11IcnpaDqlkkUfhba7G05Jn__A_xKnbqQ9-ljM0Q3fCrMPCD-60gbzXUO7b7svus1KlP8uQKNUHSQOKzVvK17C89WqWwIqjGhs3SZ9ar1hlwHi0SlpHNGrZeMqryhHVoYhm00g</code></p>
<h4 id="主节点搭建完成"><a href="#主节点搭建完成" class="headerlink" title="主节点搭建完成"></a>主节点搭建完成</h4><h2 id="20-其他节点加入主节点"><a href="#20-其他节点加入主节点" class="headerlink" title="20 其他节点加入主节点"></a>20 其他节点加入主节点</h2><p>其他主机同步到本机的第10点</p>
<h3 id="1-导出config"><a href="#1-导出config" class="headerlink" title="1 导出config"></a>1 导出config</h3><p>master中的节点认证信息24小时会失效，可以重新生成（master端操作）<br>重新生成用于节点加入集群的认证命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# cat ~/.kube/config</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN5RENDQWJDZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJd01Ea3lOREUxTXpVME1Wb1hEVE13TURreU1qRTFNelUwTVZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTUJtCjZrTDUwUFdRMExyUDhPZ2RTaGdzblNiWCttckcveUZrR2Vxa2cyRE9MeExuUElmcFBrcm9zOCtMZ2ZNbGRKK28KNUtZL1dJQmhpeWtydHQ0RVNqRGJUQXZKbWljTjZnSndQOGRzUVJOUHJCUlpGd0VEZU5jMWp3WXZETmRodU1EZAprVE9UT3N0aEhBaG1qVXJPVENLT3A4Z2VOK05zRm9DcjFQV2Z4MmVUQnpCNU56bXllRENiWG50eWViQ1hiYnVwCmlrS3p0cDBTTUpUSVlMUEUvRTIrTm91UlZiMCs3MXpHTzRJQXcyYVZTa25KOFNHSktVQm1WdWo5Y3FlcWRqQ1AKekphZnlRZ2dUSXcyZkl3aUxtYnNBY210WVhKUmh5VUQzZ2tNSzRDSGcydzczZ3FoaUFHRlc5bWtiVjJuTzRNNgpyZmRmSERXTWpjdjhubzJTakRzQ0F3RUFBYU1qTUNFd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFFbkdtelpvZXE4dVpaRHZZZGVuVURiQnk0T1gKTXVUSlZCbEcvYmNua2tsQ2RKUGtjcmsyMFBqNkxjSmptNXJkVjZlZmJ3ZXlNSjU0ZjZJdEhmSHIrcFBlMitQNgo2NEZRMENlTlRRT0krN1hGSmZHQnJzMERTdGs1OG5uQ3dHVEwzRVI3NlN4Q1BUaTMvM3BzM3MzcGZhNldTSVQ2CjN5eDZYMVRkaFFjcWp4YTJ0eEdpUjVCODd1WkUzMFlYNGIwR2JGNElsNDFNemZpSTVwRGtXNXl0a2xHZVhFdzMKQUxXUHpOaytPOVZsSmtOMTFXQzZoSjBvWTNGUGJXYzQzWTAxWkcyQUhNOEVHNEVCTUxBbzM2RFFkMXQwQUwzTQpsbk00cjdXSE5wWXZyRTgyazhQRHBkVllyRERrYnJrMVpHbkk0K2NGSEhhNVN6YnFKa0xOZHNUVHhTcz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><br><span class="line">    server: https://192.168.232.201:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: LS...EUtLS0tLQo=</span><br><span class="line">    client-key-data: LS0tL...NqRHpr..0tCg==</span><br></pre></td></tr></table></figure>
<p>复制到从节点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s2 ~]# mkdir -p $HOME/.kube</span><br><span class="line">[root@k8s2 ~]# vim .kube/config   # 粘贴到这里</span><br><span class="line">[root@k8s2 ~]# sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line">[root@k8s2 ~]# source &lt;(kubectl completion bash)</span><br></pre></td></tr></table></figure>
<h3 id="2-创建token"><a href="#2-创建token" class="headerlink" title="2 创建token"></a>2 创建token</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# kubeadm token create</span><br><span class="line">W0925 23:27:24.185638   44148 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]</span><br><span class="line">90u07f.em5awzxwxkrk5j5t</span><br><span class="line">[root@k8s1 ~]# openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null |openssl dgst -sha256 -hex| sed &#x27;s/^.* //&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="3-加入集群"><a href="#3-加入集群" class="headerlink" title="3 加入集群"></a>3 加入集群</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s2 ~]# kubeadm join 192.168.232.201:6443 --token a941el.3psezyof2fi00bma --discovery-token-ca-cert-hash sha256:91c1c19df2c2abcaf0a98a6b02d4a7c1a56dbb514e18a5bc6267739edb3ad5a0</span><br></pre></td></tr></table></figure>
<h3 id="4-查看nodes"><a href="#4-查看nodes" class="headerlink" title="4 查看nodes"></a>4 查看nodes</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s2 ~]# kubectl get nodes</span><br><span class="line">NAME           STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s1.hank.im   Ready    master   23h   v1.18.6</span><br><span class="line">k8s2.hank.im   Ready    &lt;none&gt;   19s   v1.18.6</span><br></pre></td></tr></table></figure>
<h2 id="21-设置节点标签"><a href="#21-设置节点标签" class="headerlink" title="21 设置节点标签"></a>21 设置节点标签</h2><p>设置标签</p>
<p><code>kubectl label node k8s2.hank.im type=nginx</code></p>
<p>删除标签</p>
<p><code>kubectl label nodes k8s2.hank.im type-</code></p>
<p>查看标签</p>
<p><code>kubectl get node k8s2.hank.im --show-labels</code></p>
<p>修改覆盖标签</p>
<p><code>kubectl label nodes k8s2.hank.im &lt;key&gt;=&lt;value&gt; --overwrite</code></p>
<h2 id="22-设置污点-以标签"><a href="#22-设置污点-以标签" class="headerlink" title="22 设置污点 - 以标签"></a>22 设置污点 - 以标签</h2><ul>
<li>NoSchedule:node 添加这个effect类型污点，新的不能容忍的pod，不能再调度过来，但是老的运行在node上不受影响</li>
<li>NoExecute：node 添加这个effect类型污点，新的不能容忍的pod，不能调度过来，老的pod也会被驱逐</li>
<li>PreferNoSchedule：pod会尝试将pod分配到该节点</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes node1 key=value:NoSchedule</span><br><span class="line">kubectl taint nodes node1 key=value:NoExecute</span><br><span class="line">kubectl taint nodes node1 key=value:PreferNoSchedule</span><br></pre></td></tr></table></figure>
<p><em>添加污点</em></p>
<blockquote>
<p>必须配合标签使用</p>
</blockquote>
<p><code>kubectl taint node xxx.xxx.xxx.xxx key=nginx:NoSchedule</code></p>
<p><em>查看污点</em></p>
<p><code>kubectl describe node xxx.xxx.xxx.xxx|grep -E &quot;Name:|Taint&quot;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s2 ~]#  kubectl taint node k8s1.hank.im  key=nginx:NoSchedule</span><br><span class="line">[root@k8s2 ~]#  kubectl taint node k8s2.hank.im  key=mysql:NoSchedule</span><br><span class="line"></span><br><span class="line">[root@k8s2 ~]# kubectl describe nodes |grep -E &quot;Name:|Taint&quot;</span><br><span class="line">Name:               k8s1.hank.im</span><br><span class="line">Taints:             key=nginx:NoSchedule</span><br><span class="line">Name:               k8s2.hank.im</span><br><span class="line">Taints:             key=mysql:NoSchedule</span><br><span class="line"></span><br><span class="line">[root@k8s2 ~]# kubectl taint node k8s2.hank.im  key=mysql:NoSchedule-</span><br><span class="line">node/k8s2.hank.im untainted</span><br><span class="line">[root@k8s2 ~]# kubectl taint node k8s1.hank.im  key=nginx:NoSchedule-</span><br><span class="line">node/k8s1.hank.im untainted</span><br><span class="line"></span><br><span class="line">[root@k8s2 ~]# kubectl describe nodes |grep -E &quot;Name:|Taint&quot;</span><br><span class="line">Name:               k8s1.hank.im</span><br><span class="line">Taints:             &lt;none&gt;</span><br><span class="line">Name:               k8s2.hank.im</span><br><span class="line">Taints:             &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2021/09/07/a23d7f20-0587-46cc-a51d-59eed3dd37a0.png" alt="Image.jpg"></p>
<h2 id="23-master-单机使用"><a href="#23-master-单机使用" class="headerlink" title="23 master 单机使用"></a>23 master 单机使用</h2><p>查看master的污点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ~]# kubectl describe node k8s1.hank.im</span><br><span class="line">...</span><br><span class="line">Taints:             node-role.kubernetes.io/master:NoSchedule</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>所以主节点模式是不接受新pod调度<br>那么我们可以让master接受调度，成为单机模式</p>
<p><code>kubectl taint node k8s1.hank.im node-role.kubernetes.io/master-</code></p>
<p>那么我们如何恢复主节点master only的状态</p>
<p><code>kubectl taint node k8s1.hank.im node-role.kubernetes.io/master=&quot;&quot;:NoSchedule</code></p>
<h2 id="24-停止调度"><a href="#24-停止调度" class="headerlink" title="24 停止调度"></a>24 停止调度</h2><blockquote>
<p>影响最小，只会将node调为SchedulingDisabled<br>之后再发创建pod，不会被调度到该节点<br>旧有的pod不会受到影响，仍正常对外提供服务</p>
</blockquote>
<p>停止调度</p>
<p><code>kubectl cordon k8s2.hank.im</code></p>
<p>取消停止调度</p>
<p><code>kubectl uncordon k8s2.hank.im</code></p>
<p>查看停止调度</p>
<p><code>kubectl describe nodes|grep -E &quot;Name:|Unschedulable&quot;</code></p>
<h2 id="25-驱逐节点"><a href="#25-驱逐节点" class="headerlink" title="25 驱逐节点"></a>25 驱逐节点</h2><blockquote>
<p>首先，驱逐node上的pod，其他节点重新创建<br>接着，将节点调为<strong> SchedulingDisabled</strong></p>
</blockquote>
<p>驱逐pod</p>
<p><code>kubectl drain k8s2.hank.im</code><br><code>kubectl drain k8s2.hank.im --ignore-daemonsets</code></p>
<p>恢复驱逐pod</p>
<p><code>kubectl uncordon k8s2.hank.im</code></p>
<p>查看驱逐调度</p>
<p><code>kubectl describe nodes|grep -E &quot;Name:|Unschedulable&quot;</code></p>
<h2 id="26-在指定节点部署"><a href="#26-在指定节点部署" class="headerlink" title="26 在指定节点部署"></a>26 在指定节点部署</h2><h3 id="1-查看节点信息"><a href="#1-查看节点信息" class="headerlink" title="1. 查看节点信息"></a>1. 查看节点信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s2 ~]# kubectl get nodes</span><br><span class="line">NAME           STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s1.hank.im   Ready    master   24h   v1.18.6</span><br><span class="line">k8s2.hank.im   Ready    &lt;none&gt;   56m   v1.18.6</span><br></pre></td></tr></table></figure>
<h3 id="2-选择一个节点，给这个节点添加一个标签"><a href="#2-选择一个节点，给这个节点添加一个标签" class="headerlink" title="2. 选择一个节点，给这个节点添加一个标签"></a>2. 选择一个节点，给这个节点添加一个标签</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s2 ~]#  kubectl label nodes k8s2.hank.im app=nginx</span><br><span class="line">node/k8s2.hank.im labeled</span><br></pre></td></tr></table></figure>
<h3 id="3-查看标签信息"><a href="#3-查看标签信息" class="headerlink" title="3. 查看标签信息"></a>3. 查看标签信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s2 ~]# kubectl get node k8s2.hank.im --show-labels</span><br><span class="line">NAME           STATUS   ROLES    AGE   VERSION   LABELS</span><br><span class="line">k8s2.hank.im   Ready    &lt;none&gt;   58m   v1.18.6   app=nginx,beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s2.hank.im,kubernetes.io/os=linux</span><br></pre></td></tr></table></figure>
<h3 id="4-nginx-部署"><a href="#4-nginx-部署" class="headerlink" title="4. nginx 部署"></a>4. nginx 部署</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s2 ~]# cat &gt; ~/nginx-dp.yaml&lt;&lt; EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:              # pod spec</span><br><span class="line">      nodeSelector:    # 选 择在 app=nginx标签的node</span><br><span class="line">        app: nginx</span><br><span class="line">      containers:</span><br><span class="line">        - image: nginx</span><br><span class="line">          imagePullPolicy: Always</span><br><span class="line">          name: nginx</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">        - name: default-secret</span><br><span class="line">EOF</span><br><span class="line">[root@k8s2 ~]# kubectl apply -f nginx-dp.yaml</span><br><span class="line">[root@k8s2 ~]# kubectl get pods -o wide</span><br><span class="line"></span><br><span class="line"># 查看pod状态</span><br><span class="line">[root@k8s2 ~]# kubectl describe pod nginx-764bc788c-kb8xv</span><br><span class="line"></span><br><span class="line"># 查看部署状态</span><br><span class="line">[root@k8s2 ~]# kubectl get pods -o wide</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE     IP               NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-764bc788c-7n8lm   1/1     Running   0          4m19s   192.169.62.128   k8s2.hank.im   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-764bc788c-7rd7g   1/1     Running   0          2m23s   192.169.62.129   k8s2.hank.im   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-764bc788c-kb8xv   1/1     Running   0          2m23s   192.169.62.130   k8s2.hank.im   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到全部node都创建在k8s2.hank.im</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/07/%E6%8A%80%E6%9C%AF%E8%BF%90%E7%BB%B4%E5%9F%BA%E7%A1%80%E6%8A%80%E8%83%BD%E9%9D%A2%E8%AF%95%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/07/%E6%8A%80%E6%9C%AF%E8%BF%90%E7%BB%B4%E5%9F%BA%E7%A1%80%E6%8A%80%E8%83%BD%E9%9D%A2%E8%AF%95%E9%A2%98/" class="post-title-link" itemprop="url">技术运维基础技能面试题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-07 23:12:59" itemprop="dateCreated datePublished" datetime="2021-09-07T23:12:59+08:00">2021-09-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9D%A2%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">面试</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-shell"><a href="#1-shell" class="headerlink" title="1.shell"></a>1.shell</h2><h3 id="1-1-脚本编程"><a href="#1-1-脚本编程" class="headerlink" title="1.1 脚本编程"></a>1.1 脚本编程</h3><h4 id="1-常用的shell解释器-中"><a href="#1-常用的shell解释器-中" class="headerlink" title="1. 常用的shell解释器 中"></a>1. 常用的shell解释器 中</h4><p>sh 在linux下是低版本的bash做的连接<br>bash 较于sh版本会高一些。 centos sh bash3.+ bash5.+<br>zsh<br>ksh work on AIX</p>
<h4 id="2-如何检查之前的命令是否运行成功-低"><a href="#2-如何检查之前的命令是否运行成功-低" class="headerlink" title="2. 如何检查之前的命令是否运行成功? 低"></a>2. 如何检查之前的命令是否运行成功? 低</h4><p>$?</p>
<h4 id="3-字符串的截取？-高"><a href="#3-字符串的截取？-高" class="headerlink" title="3. 字符串的截取？ 高"></a>3. 字符串的截取？ 高</h4><p>${string: start :length} 字符串截取</p>
<p>${string: 0-start :length} 从右边截取.</p>
<p>${url#*:} 截取冒号右边的字符串</p>
<p>${url#*/} 截取/右边的字符串，遇到/就结束</p>
<p>${str##<em>aa} 截取最后</em>aa的字符串，直到最后<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">url=&quot;http://c.biancheng.net/index.html&quot;</span><br><span class="line">echo $&#123;url#*/&#125;    #结果为 /c.biancheng.net/index.html</span><br><span class="line">echo $&#123;url##*/&#125;   #结果为 index.html</span><br><span class="line">str=&quot;---aa+++aa@@@&quot;</span><br><span class="line">echo $&#123;str#*aa&#125;   #结果为 +++aa@@@</span><br><span class="line">echo $&#123;str##*aa&#125;  #结果为 @@@</span><br></pre></td></tr></table></figure></p>
<h4 id="4-与-区别-中"><a href="#4-与-区别-中" class="headerlink" title="4. $* 与 $@区别 中"></a>4. $* 与 $@区别 中</h4><p>未加引号,二者相同<br>$* 一个字符串整体<br>$@ 是一个字符串列表</p>
<h4 id="5-如何移除第一个变量？"><a href="#5-如何移除第一个变量？" class="headerlink" title="5. 如何移除第一个变量？"></a>5. 如何移除第一个变量？</h4><p>shift</p>
<h4 id="6-如何在-bash-shell-中更改标准的域分隔符为-“-”-中"><a href="#6-如何在-bash-shell-中更改标准的域分隔符为-“-”-中" class="headerlink" title="6. 如何在 bash shell 中更改标准的域分隔符为 “:” ? 中"></a>6. 如何在 bash shell 中更改标准的域分隔符为 “:” ? 中</h4><p>IFS=”:”</p>
<h4 id="7-列表操作-中-高"><a href="#7-列表操作-中-高" class="headerlink" title="7. 列表操作 中-高"></a>7. 列表操作 中-高</h4><p>如何打印数组的第一个元素<br>echo ${array[0]}</p>
<p>如何打印数组的所有元素 ?<br>echo ${array[@]}</p>
<p>如何输出所有数组索引 ?<br>echo ${!array[@]}</p>
<p>如何移除数组中索引为 2 的元素 ?<br>unset array[2]</p>
<h4 id="8-与-的区别-中"><a href="#8-与-的区别-中" class="headerlink" title="8. [ 与 [[ 的区别 中"></a>8. [ 与 [[ 的区别 中</h4><p>[ ] 是test命令，他可以工作在posix shell下。<br>[[ ]] 是范匹配test命令的泛匹配模式。不能在posix shells下工作</p>
<h4 id="9-如何调试-bash-脚本-高"><a href="#9-如何调试-bash-脚本-高" class="headerlink" title="9. 如何调试 bash 脚本 高"></a>9. 如何调试 bash 脚本 高</h4><h1 id="bin-bash-–xv"><a href="#bin-bash-–xv" class="headerlink" title="!/bin/bash –xv"></a>!/bin/bash –xv</h1><h3 id="1-2-命令掌握"><a href="#1-2-命令掌握" class="headerlink" title="1.2 命令掌握"></a>1.2 命令掌握</h3><h4 id="1-读取键盘输入-中"><a href="#1-读取键盘输入-中" class="headerlink" title="1. 读取键盘输入 中"></a>1. 读取键盘输入 中</h4><p>read -p “Destination backup Server : “ desthost</p>
<h4 id="2-什么是-expect-高"><a href="#2-什么是-expect-高" class="headerlink" title="2. 什么是 expect 高"></a>2. 什么是 expect 高</h4><p>send 用于向进程发送字符串</p>
<p>expect 从进程接收字符串</p>
<p>spawn 启动新的进程</p>
<p>interact 允许用户交互</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">expect &#123;</span><br><span class="line">    &quot;password&quot; &#123;</span><br><span class="line">        send &quot;$password\r&quot;</span><br><span class="line">        exp_continue</span><br><span class="line">    &#125;</span><br><span class="line">    eof</span><br><span class="line">    &#123;</span><br><span class="line">        send &quot;eof&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-如何去除字符串中的所有空格-中"><a href="#3-如何去除字符串中的所有空格-中" class="headerlink" title="3. 如何去除字符串中的所有空格 ? 中"></a>3. 如何去除字符串中的所有空格 ? 中</h4><p>echo $string|tr -d “ “</p>
<p>echo $string|sed “s/ //g”.</p>
<p>echo $string|awk ‘{gsub(/ /,””,$0);print $0}’</p>
<h4 id="4-vim如何上下翻页，到最后一行，跳到上、下一个单词，删除两行-如何插入-中-高"><a href="#4-vim如何上下翻页，到最后一行，跳到上、下一个单词，删除两行-如何插入-中-高" class="headerlink" title="4. vim如何上下翻页，到最后一行，跳到上、下一个单词，删除两行, 如何插入 中-高"></a>4. vim如何上下翻页，到最后一行，跳到上、下一个单词，删除两行, 如何插入 中-高</h4><p>ctrl f b 上下半页<br>ctrl u d 上下整页<br>b w 上下个单词<br>2dd 删除两行</p>
<p>a 在光标后插入文本<br>A 在当前行末插入文本<br>i 在光标前插入文本<br>I 在当前行前插入文本<br>o 在当前行的下边插入新行<br>O 在当前行的上边插入新行</p>
<h4 id="5-查询进程-中"><a href="#5-查询进程-中" class="headerlink" title="5. 查询进程 中"></a>5. 查询进程 中</h4><p>ps -A | grep java<br>USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND</p>
<p>root 12368 5.1 1.6 3065312 815148 ? Sl Jun30 745:28 /usr/lib/virtualbox</p>
<p>USER 进程的用户</p>
<p>pid 进程的ID</p>
<p>%CPU 进程占用的CPU百分比；</p>
<p>%MEM 占用内存的百分比；</p>
<p>VSZ 该进程使用的虚拟内存量（KB）；</p>
<p>RSS 该进程占用的固定内存量（KB）；</p>
<p><strong>STAT</strong>状态位常见的状态字符</p>
<p>D 无法中断的休眠状态（通常 IO 的进程）；</p>
<p>R 正在运行可中在队列中可过行的；</p>
<p>S 处于休眠状态；</p>
<p>T 停止或被追踪；</p>
<p>W 进入内存交换 （从内核2.6开始无效）；</p>
<p>X 死掉的进程 （基本很少见）；</p>
<p>Z 僵尸进程；</p>
<h4 id="6-获取CPU内存等硬件信息-高"><a href="#6-获取CPU内存等硬件信息-高" class="headerlink" title="6. 获取CPU内存等硬件信息 高"></a>6. 获取CPU内存等硬件信息 高</h4><p>cat /proc/cpuinfo | grep name | cut -f2 -d: |uniq -c cpu型号</p>
<p>grep ‘physical id’ /proc/cpuinfo | sort | uniq | wc -l cpu逻辑核个数</p>
<p>工具dmidecode</p>
<p>sudo dmidecode -t memory</p>
<p>看内存的插槽数,已经使用多少插槽.每条内存多大</p>
<p>sudo dmidecode -t memory | grep Size</p>
<p>查看服务器型号、序列号</p>
<p>sudo dmidecode | grep “System Information” -A9 | egrep “Manufacturer|Product|Serial”</p>
<p>cat /proc/meminfo | grep MemTotal 内存</p>
<p>lspci</p>
<h4 id="7-查看内存资源-中"><a href="#7-查看内存资源-中" class="headerlink" title="7. 查看内存资源 中"></a>7. 查看内存资源 中</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#内存</span><br><span class="line">free -m </span><br><span class="line">              total        used        free      shared     buffers       cache   available&lt;br&gt; </span><br><span class="line">Mem:       49256832    37623856     2793324      512860           0     8839652    10623008&lt;br&gt; </span><br><span class="line">Swap:      12504060     1671468    10832592&lt;br&gt;</span><br></pre></td></tr></table></figure>
<p>used：已使用的内存大小，这个值包括了 cached 和 应用程序实际使用的内存</p>
<p>free：未被使用的内存大小</p>
<p>shared：共享内存大小，是进程间通信的一种方式</p>
<p>buffers：被<strong>缓冲区</strong>占用的内存大小（硬盘）</p>
<p>cached：被<strong>缓存占</strong>用的内存大小 （程序）</p>
<h4 id="8-什么是cpu负载和使用率，怎么查看？高"><a href="#8-什么是cpu负载和使用率，怎么查看？高" class="headerlink" title="8. 什么是cpu负载和使用率，怎么查看？高"></a>8. 什么是cpu负载和使用率，怎么查看？高</h4><p>load average/使用率 一定时间内系统的平均负荷 单核0-100%</p>
<p>负载 显示的是一段时间内正在使用和等待使用CPU的平均任务数，使用率100%，同时处理两个程序，那么负载为2</p>
<p>uptime</p>
<p>top</p>
<h4 id="9-查看硬盘读写状态-中-高"><a href="#9-查看硬盘读写状态-中-高" class="headerlink" title="9. 查看硬盘读写状态 中-高"></a>9. 查看硬盘读写状态 中-高</h4><p>iostat -x<br>rrqm/s: 每秒进行 merge 的读操作数目。即 delta(rmerge)/s</p>
<p>wrqm/s: 每秒进行 merge 的写操作数目。即 delta(wmerge)/s</p>
<p>r/s: 每秒完成的读 I/O 设备次数。即 delta(rio)/s</p>
<p>w/s: 每秒完成的写 I/O 设备次数。即 delta(wio)/s</p>
<p>rsec/s: 每秒读扇区数。即 delta(rsect)/s</p>
<p>wsec/s: 每秒写扇区数。即 delta(wsect)/s</p>
<p>rkB/s: 每秒读K字节数。是 rsect/s 的一半，因为每扇区大小为512字节。(需要计算)</p>
<p>wkB/s: 每秒写K字节数。是 wsect/s 的一半。(需要计算)</p>
<p>%util: 一秒中有百分之多少的时间用于 I/O 操作</p>
<h4 id="10-其他命令-低-中"><a href="#10-其他命令-低-中" class="headerlink" title="10. 其他命令 低-中"></a>10. 其他命令 低-中</h4><p>检查网络</p>
<p>nc</p>
<p>telnet</p>
<p>查看网卡</p>
<p>ifconfig</p>
<p>ip a</p>
<h4 id="11-添加eth1-网卡-10-0-0-0-16-到10-0-0-1-的路由"><a href="#11-添加eth1-网卡-10-0-0-0-16-到10-0-0-1-的路由" class="headerlink" title="11. 添加eth1 网卡 10.0.0.0/16 到10.0.0.1 的路由"></a>11. 添加eth1 网卡 10.0.0.0/16 到10.0.0.1 的路由</h4><p>route add -net 203.208.39.104 netmask 255.255.255.255 gw 192.168.1.1 dev eth1</p>
<p>total：物理内存大小，就是机器实际的内存</p>
<h3 id="2-Python"><a href="#2-Python" class="headerlink" title="2. Python"></a>2. Python</h3><h4 id="1-python如何获取执行shell命令"><a href="#1-python如何获取执行shell命令" class="headerlink" title="1. python如何获取执行shell命令"></a>1. python如何获取执行shell命令</h4><p><code>os.system()</code></p>
<p>原理</p>
<p>1 fork一个子进程；</p>
<p>2 在子进程中调用exec函数去执行命令；</p>
<p>3 在父进程中调用wait（阻塞）去等待子进程结束</p>
<p><code>os.popen()</code><br>这种调用方式是通过管道的方式来实现，函数返回是 file read 的对象，对其进行读取read、readlines等操作可以看到执行的输出。</p>
<p>推荐使用</p>
<p><code>subprocess.Popen()</code></p>
<h4 id="2-python如何优雅的退出"><a href="#2-python如何优雅的退出" class="headerlink" title="2. python如何优雅的退出"></a>2. python如何优雅的退出</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 子进程退出后向父进程发送的信号</span><br><span class="line"> signal.signal(signal.SIGCHLD, onSigChld)</span><br><span class="line"># 主进程退出信号</span><br><span class="line"> signal.signal(signal.SIGINT, onSigInt)</span><br></pre></td></tr></table></figure>
<h4 id="3-如何拼接字符串"><a href="#3-如何拼接字符串" class="headerlink" title="3. 如何拼接字符串"></a>3. 如何拼接字符串</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">str_list=[&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;]</span><br><span class="line">&#x27;&#x27;.join(str_list)</span><br></pre></td></tr></table></figure>
<h4 id="4-python的构造函数"><a href="#4-python的构造函数" class="headerlink" title="4. python的构造函数"></a>4. python的构造函数</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">per = Person（）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def  __ init__(self,arg1,arg2,...):</span><br><span class="line">函数体</span><br></pre></td></tr></table></figure>
<h4 id="5-json和字典的区别"><a href="#5-json和字典的区别" class="headerlink" title="5. json和字典的区别"></a>5. json和字典的区别</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">d = &#123;&#x27;s&#x27;:&#x27;you&#x27;,&#x27;d&#x27;:&#x27;are&#x27;&#125;   #给一个字典</span><br><span class="line">j = json.dumps(d)</span><br><span class="line">type(j)</span><br><span class="line">str   #已经转化为json字符串</span><br><span class="line">d1 = json.loads(j)</span><br><span class="line">type(d1)</span><br><span class="line">dic  #已经将json字符串转化为字典了</span><br></pre></td></tr></table></figure>
<p>字典是一个数据的结构，而json只是一个具有一定规则的字符串，方便在不同平台上处理其中包含的数据。</p>
<h2 id="3-Docker面试题"><a href="#3-Docker面试题" class="headerlink" title="3. Docker面试题"></a>3. Docker面试题</h2><h4 id="1-如何理解docker-中"><a href="#1-如何理解docker-中" class="headerlink" title="1. 如何理解docker 中"></a>1. 如何理解docker 中</h4><p>docker的本质是进程</p>
<p>PID Namespace</p>
<p>Mount Namespace</p>
<p>Network Namespace</p>
<p>cgroup, namespace和unionFS<br>组成的类似于虚拟机的容器</p>
<h4 id="2-DevOps有哪些优势？-高"><a href="#2-DevOps有哪些优势？-高" class="headerlink" title="2. DevOps有哪些优势？ 高"></a>2. DevOps有哪些优势？ 高</h4><p>技术优势：</p>
<p>持续的软件交付<br>修复不太复杂的问题<br>更快地解决问题<br>商业利益：</p>
<p>更快速地传递功能<br>更稳定的操作环境<br>有更多时间可以增加价值（而不是修复/维护）</p>
<p>CI（持续集成）服务器的功能是什么？</p>
<p>CI服务器功能是不断地集成所有正在进行的更改并由不同的开发人员提交到存储库，并检查编译错误。它需要每天多次构建代码，最好是在每次提交之后，以便它可以检测在问题发生时是哪个提交Bug了。</p>
<h4 id="3-Docker内的服务使用的内核在哪"><a href="#3-Docker内的服务使用的内核在哪" class="headerlink" title="3. Docker内的服务使用的内核在哪"></a>3. Docker内的服务使用的内核在哪</h4><p>内核直接使用宿主机的docker，开发和生产之间要保持内核的一致性<br>windows服务器上的内核，必须支持虚拟化。否则需要使用vitrualbox的linux虚拟机</p>
<h4 id="4-如何停止并删除一个docker"><a href="#4-如何停止并删除一个docker" class="headerlink" title="4. 如何停止并删除一个docker"></a>4. 如何停止并删除一个docker</h4><p>|</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker ps |grep docker-server-name</span><br><span class="line">docker stop docker-server-name</span><br><span class="line">docker rm docker-server-name</span><br></pre></td></tr></table></figure>
<h4 id="5-如何清理docker数据目录"><a href="#5-如何清理docker数据目录" class="headerlink" title="5. 如何清理docker数据目录"></a>5. 如何清理docker数据目录</h4><p>sudo docker system prune -af</p>
<p>会清理不用的镜像、容器</p>
<h3 id="kubernets"><a href="#kubernets" class="headerlink" title="kubernets"></a>kubernets</h3><h4 id="1-什么是-Kubernetes？"><a href="#1-什么是-Kubernetes？" class="headerlink" title="1. 什么是 Kubernetes？"></a>1. 什么是 Kubernetes？</h4><p>Kubernetes 是一个开源容器管理工具，负责容器部署，容器扩缩容以及负载平衡。</p>
<h4 id="2-什么是-Kubelet？"><a href="#2-什么是-Kubelet？" class="headerlink" title="2. 什么是 Kubelet？"></a>2. 什么是 Kubelet？</h4><p>这是一个代理服务，它在每个节点上运行，并使从服务器与主服务器通信。因此，Kubelet 处理 PodSpec 中提供给它的容器的描述，并确保 PodSpec 中描述的容器运行正常</p>
<h4 id="3-什么是pod"><a href="#3-什么是pod" class="headerlink" title="3. 什么是pod"></a>3. 什么是pod</h4><p>一个Pod（就像一群鲸鱼，或者一个豌豆夹）相当于一个共享context的配置组，在同一个context下，应用可能还会有独立的cgroup隔离机制，一个Pod是一个容器环境下的“逻辑主机”，它可能包含一个或者多个紧密相连的应用，这些应用可能是在同一个物理主机或虚拟机上。</p>
<p>Pod 的context可以理解成多个linux命名空间的联合</p>
<p>PID 命名空间（同一个Pod中应用可以看到其它进程）<br>网络 命名空间（同一个Pod的中的应用对相同的IP地址和端口有权限）<br>IPC 命名空间（同一个Pod中的应用可以通过VPC或者POSIX进行通信）<br>UTS 命名空间（同一个Pod中的应用共享一个主机名称）</p>
<h4 id="4-pod的生命周期"><a href="#4-pod的生命周期" class="headerlink" title="4. pod的生命周期"></a>4. pod的生命周期</h4><p>od被安排到结点上，并且保持在这个节点上直到被终止（根据重启的设定）或者被删除，当一个节点死掉之后，上面的所有Pod均会被删除。特殊的Pod永远不会被转移到的其他的节点，作为替代，他们必须被replace.</p>
<h4 id="5-k8s的跨主机通信原理是什么"><a href="#5-k8s的跨主机通信原理是什么" class="headerlink" title="5. k8s的跨主机通信原理是什么"></a>5. k8s的跨主机通信原理是什么</h4><p>node network：承载kubernetes集群中各个“物理”Node(master和minion)通信的网络；<br>service network：由kubernetes集群中的Services所组成的“网络”；<br>flannel network： 即Pod网络，集群中承载各个Pod相互通信的网络。</p>
<p>flannel 是二层的，那么三层网络使用什么<br>Calico 是一个三层的数据中心网络方案，而且方便集成 OpenStack 这种 IaaS 云架构，能够提供高效可控的 VM、容器、裸机之间的通信。<br>缺点是什么？<br>每台机器都配所有服务器路由，当大于（规定）100台，网络负载会非常高<br>那么使用 BGP Client(BIRD)<br>大规模部署时使用，摒弃所有节点互联的 mesh 模式，通过一个或者多个BGP Route Reflector来完成集中式的路由分发</p>
<h4 id="6-Replica-Set-和-Replication-Controller之间有什么区别？"><a href="#6-Replica-Set-和-Replication-Controller之间有什么区别？" class="headerlink" title="6. Replica Set 和 Replication Controller之间有什么区别？"></a>6. Replica Set 和 Replication Controller之间有什么区别？</h4><p>Replica Set 和 Replication Controller几乎完全相同。它们都确保在任何给定时间运行指定数量的pod副本。不同之处在于复制pod使用的选择器。Replica Set使用基于集合的选择器，而Replication Controller使用基于权限的选择器。</p>
<h2 id="4-中间件集群"><a href="#4-中间件集群" class="headerlink" title="4. 中间件集群"></a>4. 中间件集群</h2><p>哨兵至少需要 3 个实例，来保证自己的健壮性。<br>哨兵 + redis 主从的部署架构，是不保证数据零丢失的，只能保证 redis 集群的高可用性。<br>对于哨兵 + redis 主从这种复杂的部署架构，尽量在测试环境和生产环境，都进行充足的测试和演</p>
<h4 id="6-官方Redis-Cluster-方案-服务端路由查询"><a href="#6-官方Redis-Cluster-方案-服务端路由查询" class="headerlink" title="6 官方Redis Cluster 方案(服务端路由查询)"></a>6 官方Redis Cluster 方案(服务端路由查询)</h4><p>方案说明</p>
<ul>
<li>通过哈希的方式，将数据分片，每个节点均分存储一定哈希槽(哈希值)区间的数据，默认分配了16384 个槽位</li>
<li>每份数据分片会存储在多个互为主从的多节点上</li>
<li>数据写入先写主节点，再同步到从节点(支持配置为阻塞同步)</li>
<li>同一分片多个节点间的数据不保持一致性</li>
<li>读取数据时，当客户端操作的key没有分配在该节点上时，redis会返回转向指令，指向正确的节点</li>
<li>扩容时时需要需要把旧节点的数据迁移一部分到新节点</li>
</ul>
<h4 id="7-Redis-主从架构"><a href="#7-Redis-主从架构" class="headerlink" title="7 Redis 主从架构"></a>7 Redis 主从架构</h4><h4 id="8-Redis是单线程的，如何提高多核CPU的利用率？"><a href="#8-Redis是单线程的，如何提高多核CPU的利用率？" class="headerlink" title="8. Redis是单线程的，如何提高多核CPU的利用率？"></a>8. Redis是单线程的，如何提高多核CPU的利用率？</h4><h4 id="1-什么是Redis"><a href="#1-什么是Redis" class="headerlink" title="1 什么是Redis"></a>1 什么是Redis</h4><p>Redis 可以存储键和五种不同类型的值之间的映射。键的类型只能为字符串，值支持五种数据类型：字符串、列表、集合、散列表、有序集合。</p>
<h4 id="2-Redis有哪些优缺点"><a href="#2-Redis有哪些优缺点" class="headerlink" title="2 Redis有哪些优缺点"></a>2 Redis有哪些优缺点</h4><p>优点</p>
<p>读写性能优异， Redis能读的速度是110000次/s，写的速度是81000次/s。<br>支持数据持久化，支持AOF和RDB两种持久化方式。<br>支持事务，Redis的所有操作都是原子性的，同时Redis还支持对几个操作合并后的原子性执行。<br>数据结构丰富，除了支持string类型的value外还支持hash、set、zset、list等数据结构。<br>支持主从复制，主机会自动将数据同步到从机，可以进行读写分离。<br>缺点</p>
<p>数据库容量受到物理内存的限制，不能用作海量数据的高性能读写，因此Redis适合的场景主要局限在较小数据量的高性能操作和运算上。<br>Redis 不具备自动容错和恢复功能，主机从机的宕机都会导致前端部分读写请求失败，需要等待机器重启或者手动切换前端的IP才能恢复。<br>主机宕机，宕机前有部分数据未能及时同步到从机，切换IP后还会引入数据不一致的问题，降低了系统的可用性。<br>Redis 较难支持在线扩容，在集群容量达到上限时在线扩容会变得很复杂。为避免这一问题，运维人员在系统上线时必须确保有足够的空间，这对资源造成了很大的浪费。</p>
<h4 id="3-为什么要用-Redis-为什么要用缓存"><a href="#3-为什么要用-Redis-为什么要用缓存" class="headerlink" title="3 为什么要用 Redis /为什么要用缓存"></a>3 为什么要用 Redis /为什么要用缓存</h4><p>主要从“高性能”和“高并发”这两点来看待这个问题。<br>高性能：<br>假如用户第一次访问数据库中的某些数据。这个过程会比较慢，因为是从硬盘上读取的。将该用户访问的数据存在数缓存中，这样下一次再访问这些数据的时候就可以直接从缓存中获取了。操作缓存就是直接操作内存，所以速度相当快。<br>高并发：<br>直接操作缓存能够承受的请求是远远大于直接访问数据库的，所以我们可以考虑把数据库中的部分数据转移到缓存中去，这样用户的一部分请求会直接到缓存这里而不用经过数据库。</p>
<h4 id="4-MySQL里有2000w数据，redis中只存20w的数据，如何保证redis中的数据都是热点数据"><a href="#4-MySQL里有2000w数据，redis中只存20w的数据，如何保证redis中的数据都是热点数据" class="headerlink" title="4 MySQL里有2000w数据，redis中只存20w的数据，如何保证redis中的数据都是热点数据"></a>4 MySQL里有2000w数据，redis中只存20w的数据，如何保证redis中的数据都是热点数据</h4><p>Redis的内存淘汰策略有哪些<br>Redis的内存淘汰策略是指在Redis的用于缓存的内存不足时，怎么处理需要新写入且需要申请额外空间的数据。</p>
<p>全局的键空间选择性移除<br>noeviction：当内存不足以容纳新写入数据时，新写入操作会报错。<br>allkeys-lru：当内存不足以容纳新写入数据时，在键空间中，移除最近最少使用的key。（这个是最常用的）<br>allkeys-random：当内存不足以容纳新写入数据时，在键空间中，随机移除某个key。<br>设置过期时间的键空间选择性移除<br>volatile-lru：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，移除最近最少使用的key。<br>volatile-random：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，随机移除某个key。<br>volatile-ttl：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，有更早过期时间的key优先移除。</p>
<h4 id="5-哨兵模式"><a href="#5-哨兵模式" class="headerlink" title="5 哨兵模式"></a>5 哨兵模式</h4><p>哨兵的介绍<br>sentinel，中文名是哨兵。哨兵是 redis 集群机构中非常重要的一个组件，主要有以下功能：</p>
<ul>
<li>集群监控：负责监控 redis master 和 slave 进程是否正常工作。</li>
<li>消息通知：如果某个 redis 实例有故障，那么哨兵负责发送消息作为报警通知给管理员。</li>
<li>故障转移：如果 master node 挂掉了，会自动转移到 slave node 上。</li>
<li>配置中心：如果故障转移发生了，通知 client 客户端新的 master 地址。<br>哨兵用于实现 redis 集群的高可用，本身也是分布式的，作为一个哨兵集群去运行，互相协同工作。</li>
</ul>
<p>故障转移时，判断一个 master node 是否宕机了，需要大部分的哨兵都同意才行，涉及到了分布式选举的问题。<br>即使部分哨兵节点挂掉了，哨兵集群还是能正常工作的，因为如果一个作为高可用机制重要组成部分的故障转移系统本身是单点的，那就很坑爹了。<br>哨兵的核心知识</p>
<p>哨兵至少需要 3 个实例，来保证自己的健壮性。<br>哨兵 + redis 主从的部署架构，是不保证数据零丢失的，只能保证 redis 集群的高可用性。<br>对于哨兵 + redis 主从这种复杂的部署架构，尽量在测试环境和生产环境，都进行充足的测试和演</p>
<h4 id="6-官方Redis-Cluster-方案-服务端路由查询-1"><a href="#6-官方Redis-Cluster-方案-服务端路由查询-1" class="headerlink" title="6 官方Redis Cluster 方案(服务端路由查询)"></a>6 官方Redis Cluster 方案(服务端路由查询)</h4><p>方案说明</p>
<ul>
<li>通过哈希的方式，将数据分片，每个节点均分存储一定哈希槽(哈希值)区间的数据，默认分配了16384 个槽位</li>
<li>每份数据分片会存储在多个互为主从的多节点上</li>
<li>数据写入先写主节点，再同步到从节点(支持配置为阻塞同步)</li>
<li>同一分片多个节点间的数据不保持一致性</li>
<li>读取数据时，当客户端操作的key没有分配在该节点上时，redis会返回转向指令，指向正确的节点</li>
<li>扩容时时需要需要把旧节点的数据迁移一部分到新节点</li>
</ul>
<h4 id="7-Redis-主从架构-1"><a href="#7-Redis-主从架构-1" class="headerlink" title="7 Redis 主从架构"></a>7 Redis 主从架构</h4><h4 id="8-Redis是单线程的，如何提高多核CPU的利用率？-1"><a href="#8-Redis是单线程的，如何提高多核CPU的利用率？-1" class="headerlink" title="8. Redis是单线程的，如何提高多核CPU的利用率？"></a>8. Redis是单线程的，如何提高多核CPU的利用率？</h4><p>可以在同一个服务器部署多个Redis的实例，并把他们当作不同的服务器来使用，在某些时候，无论如何一个服务器是不够的， 所以，如果你想使用多个CPU，你可以考虑一下分片（shard）</p>
<h1 id="sl版-融合中"><a href="#sl版-融合中" class="headerlink" title="sl版 融合中"></a>sl版 融合中</h1><p>环境部分</p>
<ol>
<li>当前公司主要业务是什么？</li>
<li>上家公司负责那部分？团队人数多少？</li>
</ol>
<p>基础部分</p>
<ol>
<li>sh与bash区别；</li>
<li>如果只有root用户权限，但无root密码，如何做到服务器之间的文件拷贝？</li>
<li>top中的各项是意思？</li>
<li>如何做到机器重启自动挂载磁盘？</li>
<li>TCP的交互过程，UDP与TCP的区别是什么？</li>
<li>如何测试TCP端口是否正常？如何测试UDP端口是否正常？</li>
<li>nfs的工作原理是什么？</li>
</ol>
<p>应用部分</p>
<ol>
<li>keepalived的工作原理，如何做健康检查？</li>
<li>HAProxy的工作原理是什么？与nginx的区别是什么？</li>
<li>nginx的功能是什么？描述下反向代理的过程；</li>
<li>MySQL的主从同步过程是什么样的，常见的MySQL的高可用有几种方案，描述原理；</li>
<li>redis高可用方案是什么？如何做到redis重启数据不丢失；</li>
</ol>
<p>docker部分</p>
<ol>
<li>Docker与虚拟机有何不同？</li>
<li>docker镜像是什么？描述下拉取镜像的过程；</li>
<li>容器是什么？容器状态有几种？查看容器状态的命令是什么？如何进入容器内部？</li>
<li>docker-compose是什么？</li>
<li>容器内时间与外部时间不一致怎么办？</li>
<li>docker内部用户与外部用户的关系是什么？</li>
</ol>
<p>SIP部分</p>
<ol>
<li>SIP信令常见的响应消息有几种？一个完整的通话过程中，信令交互的过程是什么样的？</li>
<li>SDP是什么？</li>
<li>RTP是如何工作的？RTCP是什么？通话中的单通现象是怎么产生的？通话断续什么什么原因？</li>
<li>如何利用wireshark分析呼叫是否正常？</li>
</ol>
<p>职业部分</p>
<ol>
<li>离职原因？</li>
<li>你认为运维工程师的职责是什么？</li>
<li>升级某个服务时，是保障升级过程可回滚的？</li>
</ol>
<p>运维的挑战</p>
<p>我们聊下运维岗位面临的一些挑战。</p>
<p>一是基础资源从集中式向云化转变。</p>
<p>传统的集中式基础资源，讲求的是单体的性能和稳定性，思考问题的方式是纵向的。但是在基于分布式的云化基础设施下，运维人员需要考虑的是云资源池的故障域要如何划分、云资源池的规模要如何设计、不同环境的资源池要如何隔离、资源的超售比设置为多少、资源的标准化要如何设计、云化资源池中不同范围的故障发生后，如何保证继续提供可靠的服务，这些都是云化以后运维人员需要考虑的。</p>
<p>二是运维前置。</p>
<p>笔者发现，有些公司运维人员做的事情太过于底层，只负责OS层及以下的部分，对应用层的运维完全不懂，以致于在应用出现问题的时候，看起来都是开发在排查问题，给领导的感觉会比较差。同时，随着云计算的普及，OS层以下的内容，后续很可能直接被云服务商托管掉，就类似现在很多公司使用的托管机房，以及很多创业公司直接使用公有云，极端情况下，就可能导致运维人员下岗。</p>
<p>因此，运维人员应该让自己的技能前置，例如，对于java技术栈为主的公司，对于运维人员而言最好是要学习java虚拟机的相关知识和技能，这样在java程序出现问题的时候能够快速定位问题，而不是强依赖开发人员。</p>
<p>三是容器运维。</p>
<p>容器平台在被大量使用以后，一定会带来运维问题，但是容器平台的运维模式和基于虚拟机的运维模式是完全不同的，这就需要运维人员能够熟悉容器平台的运行机制，对容器有理论上的知识储备以及实际的运维能力，而这项技能对传统运维人员而言基本就是全新的领域。</p>
<p>四是开源软件的运维。</p>
<p>前文提到了架构师需要对开源软件的引入进行专业的评估和把控，那么对于引入进来的开源软件的运维工作就落到了运维人员头上。传统的公司的运维，一般都会买一些外部的运维服务，而这些运维服务大多数也都是针对传统的商用软件而不是开源软件。因此在引入开源软件以后，对于运维人员而言，原来可以依靠的外部服务没有了，自己就需要去能够具备运维开源软件的能力，这里要投入的学习成本是相当高的，并且没有一个所谓的“掌握”标准。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/07/lvs-dr-%E6%A8%A1%E5%BC%8F%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%88%86%E6%9E%90-2-%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/07/lvs-dr-%E6%A8%A1%E5%BC%8F%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%88%86%E6%9E%90-2-%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">lvs dr 模式搭建与分析 (2) 抓包分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-09-07 22:52:48 / Modified: 23:05:49" itemprop="dateCreated datePublished" datetime="2021-09-07T22:52:48+08:00">2021-09-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BD%91%E7%BB%9C/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" itemprop="url" rel="index"><span itemprop="name">负载均衡</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="接前文"><a href="#接前文" class="headerlink" title="接前文"></a>接前文</h2><p>单单测试成功，我们可能还不理解tcp流的具体工作方式，这里我们逐步拆解，把过程从tcp层面展开分析</p>
<h3 id="实验的mac地址"><a href="#实验的mac地址" class="headerlink" title="实验的mac地址"></a>实验的mac地址</h3><p>192.168.232.1 00:50:56:c0:00:08 client<br>192.168.232.121 00:0c:29:c1:17:52 dir1<br>192.168.232.120 00:0c:29:c1:17:52 dir1/vip<br>192.168.232.111 00:0c:29:3a:d3:86 realip/nginx</p>
<h2 id="从请求到vip"><a href="#从请求到vip" class="headerlink" title="从请求到vip"></a>从请求到vip</h2><h3 id="先确定一下vip的绑定与vrrp协议的广播内容"><a href="#先确定一下vip的绑定与vrrp协议的广播内容" class="headerlink" title="先确定一下vip的绑定与vrrp协议的广播内容"></a>先确定一下vip的绑定与vrrp协议的广播内容</h3><h4 id="on-192-168-232-121-lvs1-hank-im"><a href="#on-192-168-232-121-lvs1-hank-im" class="headerlink" title="on 192.168.232.121 lvs1.hank.im"></a>on 192.168.232.121 lvs1.hank.im</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@lvs1 ~]# ip a</span><br><span class="line">...</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:c1:17:52 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.232.121/24 brd 192.168.232.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.232.120/24 scope global secondary ens33</span><br><span class="line">...</span><br><span class="line">[root@lvs1 ~]# tcpdump -i ens33 &#x27;((!port 22))&#x27; -w vip.vrrp.cap  # 排除你的ssh连接</span><br></pre></td></tr></table></figure>
<p>倒出用wireshark查看包内容</p>
<p><img src="/images/2021/09/07/99731554-7c60-48bb-af88-69019142ab58.jpg" alt="image.jpg"></p>
<p>再去lvs2看一眼</p>
<h4 id="on-192-168-232-122-lvs2-hank-im"><a href="#on-192-168-232-122-lvs2-hank-im" class="headerlink" title="on 192.168.232.122 lvs2.hank.im"></a>on 192.168.232.122 lvs2.hank.im</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs2 ~]# ip a</span><br><span class="line">...</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:35:e2:9e brd ff:ff:里边有一个握手包ff:ff:ff:ff</span><br><span class="line">    inet 192.168.232.122/24 brd 192.168.232.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>并没有vip,正常</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i ens33 &#x27;((!port 22))&#x27; -w vip2.vrrp.cap</span><br></pre></td></tr></table></figure>
<p><img src="/images/2021/09/07/e01626eb-e3f0-4ebc-95b6-d1ac9750b505.jpg" alt="image.jpg"></p>
<p>这时候可以确定vrrp协议正常，vip 192.168.232.120 在192.168.232.121上正常绑定。</p>
<h4 id="on-192-168-232-112-nginx2-hank-im"><a href="#on-192-168-232-112-nginx2-hank-im" class="headerlink" title="on 192.168.232.112 nginx2.hank.im"></a>on 192.168.232.112 nginx2.hank.im</h4><p>关闭，把流量全部导入到nginx1.hank.im</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx2 ~]# docker stop nginx</span><br></pre></td></tr></table></figure>
<h4 id="on-192-168-232-111-nginx1-hank-im"><a href="#on-192-168-232-111-nginx1-hank-im" class="headerlink" title="on 192.168.232.111 nginx1.hank.im"></a>on 192.168.232.111 nginx1.hank.im</h4><p>关闭lvs_real.sh stop</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx1 ~]# ./lvs_real.sh stop</span><br><span class="line">RealServer Stoped</span><br></pre></td></tr></table></figure>
<h3 id="尝试请求"><a href="#尝试请求" class="headerlink" title="尝试请求"></a>尝试请求</h3><h4 id="on-192-168-232-121-lvs1-hank-im-1"><a href="#on-192-168-232-121-lvs1-hank-im-1" class="headerlink" title="on 192.168.232.121 lvs1.hank.im"></a>on 192.168.232.121 lvs1.hank.im</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs1 ~]# tcpdump -i ens33 &#x27;((!port 22))&#x27; -w vip.httpreq.cap  # 排除你的ssh连接</span><br></pre></td></tr></table></figure>
<h4 id="on-192-168-232-111-nginx1-hank-im-1"><a href="#on-192-168-232-111-nginx1-hank-im-1" class="headerlink" title="on 192.168.232.111 nginx1.hank.im"></a>on 192.168.232.111 nginx1.hank.im</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx1 ~]# tcpdump -i ens33 &#x27;dst port 80&#x27; -w  nginx1.httpreq.cap</span><br></pre></td></tr></table></figure>
<h4 id="on-192-168-1-233-client-ip"><a href="#on-192-168-1-233-client-ip" class="headerlink" title="on 192.168.1.233 client ip"></a>on 192.168.1.233 client ip</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜   curl 192.168.232.120</span><br><span class="line">(无返回卡死)</span><br></pre></td></tr></table></figure>
<h4 id="on-192-168-232-121-lvs1-hank-im-192-168-232-111-nginx1-hank-im"><a href="#on-192-168-232-121-lvs1-hank-im-192-168-232-111-nginx1-hank-im" class="headerlink" title="on 192.168.232.121 lvs1.hank.im 192.168.232.111 nginx1.hank.im"></a>on 192.168.232.121 lvs1.hank.im 192.168.232.111 nginx1.hank.im</h4><p>停止抓包并拉回</p>
<h4 id="on-192-168-232-121-lvs1-hank-im-2"><a href="#on-192-168-232-121-lvs1-hank-im-2" class="headerlink" title="on 192.168.232.121 lvs1.hank.im"></a>on 192.168.232.121 lvs1.hank.im</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs1 ~]# ipvsadm -Lnc</span><br><span class="line">IPVS connection entries</span><br><span class="line">pro expire state       source             virtual            destination</span><br><span class="line">TCP 00:58  SYN_RECV    192.168.232.1:57317 192.168.232.120:80 192.168.232.111:80</span><br><span class="line">TCP 00:58  SYN_RECV    192.168.232.1:57315 192.168.232.120:80 192.168.232.111:80</span><br><span class="line">TCP 00:58  SYN_RECV    192.168.232.1:57316 192.168.232.120:80 192.168.232.111:80</span><br><span class="line">TCP 00:59  SYN_RECV    192.168.232.1:57323 192.168.232.120:80 192.168.232.111:80</span><br><span class="line">[root@lvs1 ~]# ipvsadm -Lnc</span><br><span class="line">IPVS connection entries</span><br><span class="line">pro expire state       source             virtual            destination</span><br><span class="line">TCP 00:54  SYN_RECV    192.168.232.1:57317 192.168.232.120:80 192.168.232.111:80</span><br><span class="line">TCP 00:54  SYN_RECV    192.168.232.1:57315 192.168.232.120:80 192.168.232.111:80</span><br><span class="line">TCP 00:54  SYN_RECV    192.168.232.1:57316 192.168.232.120:80 192.168.232.111:80</span><br><span class="line">TCP 00:56  SYN_RECV    192.168.232.1:57323 192.168.232.120:80 192.168.232.111:8</span><br></pre></td></tr></table></figure>
<p>state 为SYN_RECV状态，打开wireshark看一下请求状态，为什么卡死</p>
<h3 id="插入！复习一下tcp控制位"><a href="#插入！复习一下tcp控制位" class="headerlink" title="插入！复习一下tcp控制位"></a>插入！复习一下tcp控制位</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">控制位：字段长为 8 位，每一位从左到右分别为 CWR、ECE、URG、ACK、PSH、RST、SYN、FIN。这些控制标志也叫做控制位。当他们的对应位上值为 1 时，具体含义如下：</span><br><span class="line"></span><br><span class="line">CWR：CWR 标志与后面的 ECE 标志都用于 IP 首部的 ECN 字段，ECE 标志为 1 时，则通知对方已将拥塞窗口缩小；</span><br><span class="line"></span><br><span class="line">ECE：若其值为 1 则会通知对方，从对方到这边的网络有阻塞。在收到数据包的 IP 首部中 ECN 为 1 时将 TCP 首部中的 ECE 设为 1.；</span><br><span class="line"></span><br><span class="line">URG：该位设为 1，表示包中有需要紧急处理的数据，对于需要紧急处理的数据，与后面的紧急指针有关；</span><br><span class="line"></span><br><span class="line">ACK：该位设为 1，确认应答的字段有效，TCP规定除了最初建立连接时的 SYN 包之外该位必须设为 1；</span><br><span class="line"></span><br><span class="line">PSH：该位设为 1，表示需要将收到的数据立刻传给上层应用协议，若设为 0，则先将数据进行缓存；</span><br><span class="line"></span><br><span class="line">RST：该位设为 1，表示 TCP 连接出现异常必须强制断开连接；</span><br><span class="line"></span><br><span class="line">SYN：用于建立连接，该位设为 1，表示希望建立连接，并在其序列号的字段进行序列号初值设定；</span><br><span class="line"></span><br><span class="line">FIN：该位设为 1，表示今后不再有数据发送，希望断开连接。当通信结束希望断开连接时，通信双方的主机之间就可以相互交换 FIN 位置为 1 的 TCP 段。每个主机又对对方的 FIN 包进行确认应答之后可以断开连接。不过，主机收到 FIN 设置为 1 的 TCP 段之后不必马上回复一个 FIN 包，而是可以等到缓冲区中的所有数据都因为已成功发送而被自动删除之后再发 FIN 包；</span><br><span class="line"></span><br><span class="line">窗口大小：该字段长 16 位，用于通知从相同 TCP 首部的确认应答号所指位置开始能够接收的数据大小（8 位字节）。TCP 不允许发送超过该窗口大小的数据。若窗口为 0，则表示可以发送窗口探测，以了解最新的窗口大小，但这个数据必须是 1 个字节；</span><br><span class="line"></span><br><span class="line">检验和：TCP 的检验和与 UDP 检验和一样，也是采用伪首部，但是 TCP 的检验和无法关闭。TCP 伪首部的信息和 UDP 一样，包括：源 IP 地址、目的 IP 地址、填充、协议号以及 TCP 包长度；</span><br><span class="line"></span><br><span class="line">紧急指针：该字段为 16 位。只有在 URG 控制位为 1 时有效。该字段的数值表示本报文段中紧急数据的指针。从数据部分的首位到紧急指针所在的位置为止是紧急数据。因此，紧急指针是指出了紧急数据的末尾在报文段中的位置； </span><br><span class="line"></span><br><span class="line">常见错误</span><br><span class="line"></span><br><span class="line">TCP Out_of_Order的原因分析：</span><br><span class="line">一般来说是网络拥塞，导致顺序包抵达时间不同，延时太长，或者包丢失，需要重新组合数据单元，因为他们可能是由不同的路径到达你的电脑上面。</span><br><span class="line"></span><br><span class="line">TCP Retransmission原因分析：</span><br><span class="line">很明显是上面的超时引发的数据重传。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TCP dup ack XXX#X原因分析：</span><br><span class="line">就是重复应答#前的表示报文到哪个序号丢失，#后面的是表示第几次丢失。</span><br><span class="line"></span><br><span class="line">tcp previous segment not captured原因分析</span><br><span class="line">意思就是报文没有捕捉到，出现报文的丢失。</span><br></pre></td></tr></table></figure>
<p>好了，先看一下vip1的包</p>
<p>里边有一个握手包</p>
<p><img src="/images/2021/09/07/8f9ea882-3cd9-4361-a803-41c35783ffce.jpg" alt="image.jpg"></p>
<p>这两个框是nginx1 nginx2与dip之间tcp握手包。有sync ack rst，ack，完成握手并reset。说明这个属于一个与122与111联系的心跳包。</p>
<p>在查看一下来自192.168.232.1的包</p>
<p><img src="/images/2021/09/07/878eeff4-97cb-47eb-95fe-c1879fd70d68.jpg" alt="image.jpg"></p>
<p>那么为什么会发生超时，再看一下nginx1的包</p>
<p>这个包source ip 为192.168.232.1, destip为192.168.232.120，vip接收到这个包，并且开始建立握手，seq=0，并通知缩小拥塞窗口。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>srcip</th>
<th>srcmac</th>
<th>srcport</th>
<th>destip</th>
<th>destmac</th>
<th>destport</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.232.1</td>
<td>00:50:56:c0:00:08</td>
<td>57774</td>
<td>192.168.232.120</td>
<td>00:0c:29:c1:17:52</td>
<td>80</td>
</tr>
</tbody>
</table>
</div>
<p>然后120 vip 把这个包更改了mac地址，来源mac地址更改为dir1的mac（c1:17:52），dest mac更改为nginx1的mac地址，并发送给了nginx1</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>srcip</th>
<th>srcmac</th>
<th>srcport</th>
<th>destip</th>
<th>destmac</th>
<th>destport</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.232.1</td>
<td><strong>00:0c:29:c1:17:52</strong></td>
<td>57774</td>
<td><strong>00:0c:29:3a:d3:86</strong></td>
<td>VMware_c0:00:08</td>
<td>80</td>
</tr>
</tbody>
</table>
</div>
<p>在透传过程中发生了什么，产生了out of order，然后每秒发生一次tcp retransmission - 超时引发的数据重传。那么去nginx1服务器的抓包看一下<br><img src="/images/2021/09/07/3cbb60f6-3cfc-42c3-913b-2f81308eb1b3.jpg" alt="image.jpg"></p>
<p>原来，是nginx1发现这个包的ip与他自己的mac不符合，把这个包丢弃了。那么，就解释了，我们为什么要使用lvs_real.sh。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SNS_VIP=192.168.232.120  # 定义一下vip变量</span><br><span class="line">/sbin/ifconfig lo:0 $SNS_VIP netmask 255.255.255.255 broadcast $SNS_VIP # 把vip绑定在lo网卡上，然后设定掩码32，可能怕这个ip旅游广播。</span><br><span class="line">/sbin/route add -host $SNS_VIP dev lo:0 # 死死的把这个ip的路由绑定在lo:0, 没错，我就是vip！</span><br><span class="line">echo &quot;1&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore </span><br><span class="line">echo &quot;2&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_announce </span><br><span class="line">echo &quot;1&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_ignore </span><br><span class="line">echo &quot;2&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/06/lvs-dr-%E6%A8%A1%E5%BC%8F%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%88%86%E6%9E%90-1-%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/06/lvs-dr-%E6%A8%A1%E5%BC%8F%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%88%86%E6%9E%90-1-%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">lvs dr 模式搭建与分析 (1) 搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-09-06 22:06:59 / Modified: 23:48:17" itemprop="dateCreated datePublished" datetime="2021-09-06T22:06:59+08:00">2021-09-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BD%91%E7%BB%9C/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" itemprop="url" rel="index"><span itemprop="name">负载均衡</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="LVS相关术语"><a href="#LVS相关术语" class="headerlink" title="LVS相关术语"></a>LVS相关术语</h2><ul>
<li>DS：Director Server。指的是前端负载均衡器节点</li>
<li>RS：Real Server。后端真实的工作服务器</li>
<li>VIP：向外部直接面向用户请求，作为用户请求的目标的IP地址</li>
<li>DIP：Director Server IP，主要用于和内部主机通讯的IP地址</li>
<li>RIP：Real Server IP，后端服务器的IP地址</li>
<li>CIP：Client IP，访问客户端的IP地址</li>
</ul>
<h2 id="LVS负载均衡十种算法"><a href="#LVS负载均衡十种算法" class="headerlink" title="LVS负载均衡十种算法"></a>LVS负载均衡十种算法</h2><ul>
<li>轮循调度 rr<blockquote>
<p>均等地对待每一台服务器，不管服务器上的实际连接数和系统负载</p>
</blockquote>
</li>
<li>加权轮调 wrr<blockquote>
<p>调度器可以自动问询真实服务器的负载情况，并动态调整</p>
</blockquote>
</li>
<li>最少链接 lc<blockquote>
<p>动态地将网络请求调度到已建立的连接数最少的服务器上<br>如果集群真实的服务器具有相近的系统性能，采用该算法可以较好的实现负载均衡</p>
</blockquote>
</li>
<li>加权最少链接 wlc<blockquote>
<p>调度器可以自动问询真实服务器的负载情况，并动态调整权值<br>带权重的谁不干活就给谁分配，机器配置好的权重高</p>
</blockquote>
</li>
<li>基于局部性的最少连接调度算法 lblc<blockquote>
<p>这个算法是请求数据包的目标 IP 地址的一种调度算法，该算法先根据请求的目标 IP 地址寻找最近的该目标 IP 地址所有使用的服务器，如果这台服务器依然可用，并且有能力处理该请求，调度器会尽量选择相同的服务器，否则会继续选择其它可行的服务器</p>
</blockquote>
</li>
<li>复杂的基于局部性最少的连接算法 lblcr<blockquote>
<p>记录的不是要给目标 IP 与一台服务器之间的连接记录，它会维护一个目标 IP 到一组服务器之间的映射关系，防止单点服务器负载过高。</p>
</blockquote>
</li>
<li>目标地址散列调度算法 dh<blockquote>
<p>该算法是根据目标 IP 地址通过散列函数将目标 IP 与服务器建立映射关系，出现服务器不可用或负载过高的情况下，发往该目标 IP 的请求会固定发给该服务器。</p>
</blockquote>
</li>
<li>源地址散列调度算法 sh<blockquote>
<p>与目标地址散列调度算法类似，但它是根据源地址散列算法进行静态分配固定的服务器资源。</p>
</blockquote>
</li>
<li>最少期望延迟 sed<blockquote>
<p>不考虑非活动链接，谁的权重大，优先选择权重大的服务器来接收请求，但权重大的机器会比较忙</p>
</blockquote>
</li>
<li>永不排队 nq<blockquote>
<p>无需队列，如果有realserver的连接数为0就直接分配过去</p>
</blockquote>
</li>
</ul>
<h2 id="LVS-DR-工作原理："><a href="#LVS-DR-工作原理：" class="headerlink" title="LVS-DR 工作原理："></a>LVS-DR 工作原理：</h2><ol>
<li>客户端向VIP发出请求，请求报文中源IP为CIP，目标IP为VIP，源MAC为客户端的MAC，目标MAC为LVS调度器的MAC（Director）</li>
<li>LVS调度器接收到请求后，修改了请求报文中的目标MAC地址（Director会根据算法将请求报文中的目标MAC地址，修改成指定的RS的MAC地址）。并将请求进行广播。</li>
<li>RS接受到广播后，拆开报文，发现目标MAC地址是自己，于是开始响应请求。并直接将响应请求发送到客户端。响应的过程不经过LVS调度器。</li>
</ol>
<h2 id="LVS-DR模式的特性："><a href="#LVS-DR模式的特性：" class="headerlink" title="LVS DR模式的特性："></a>LVS DR模式的特性：</h2><ul>
<li>CIP必须能够和VIP通讯，所以通常VIP是外网地址 二级标题</li>
<li>DIP和RIP为同一物理网络，否则无法向RS发送ARP广播</li>
<li>RS上必须配置VIP地址，否则响应报文无法送达客户端，RS上的VIP对外界是不可见的，但RS可以接收目标地址为VIP的网络请求，并在回应数据包时将源地址设置为该VIP地址</li>
<li>RS上必须做ARP抑制，使RS不响应来自CIP的请求，相当于指定Director来响应CIP的请求</li>
<li>调度器几乎支持所有的UNIX、LINUX系统，但不支持windows，但是RS可以为windows</li>
<li>RS的网关不能指向DIP，应该指向出口网关</li>
<li>DR模式下，不支持端口映射，即Director不能更改请求报文的端口</li>
<li>DR模式效率很高，但配置麻烦，访问量不是非常大的情况下推荐使用haproxy或者nginx。标准：日访问量2000W PV以下，或者并发请求1W以下的可以考虑使用haproxy或nginx或使用LVS-NAT模式。</li>
<li>直接对外的访问业务，例如：web服务做RS节点，RS最好使用外网IP，如果不直接对外的业务，例如MySQL、存储系统RS节点，最好使用内网I</li>
</ul>
<h2 id="部署过程"><a href="#部署过程" class="headerlink" title="部署过程"></a>部署过程</h2><h3 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h3><p><img src="/images/2021/09/06/ba2df7a9-35de-48fd-a1e9-a9f2e0fcbd66.jpg" alt="image.jpg"></p>
<p>实验环境基于vmware虚拟机nat网路环境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.233 # CIP 访问ip，但是由于虚拟机nat，访问ip为192.168.232.1</span><br><span class="line">192.168.232.120 vip.hank.im # VIP</span><br><span class="line">192.168.232.121 lvs1.hank.im # DIR</span><br><span class="line">192.168.232.122 lvs2.hank.im # DIR</span><br><span class="line">192.168.232.111 nginx1.hank.im # RS</span><br><span class="line">192.168.232.112 nginx2.hank.im # RS</span><br></pre></td></tr></table></figure>
<h3 id="on-192-168-232-121-122-lvs1-hank-im-lvs2-hank-im"><a href="#on-192-168-232-121-122-lvs1-hank-im-lvs2-hank-im" class="headerlink" title="on 192.168.232.121/122 lvs1.hank.im/lvs2.hank.im"></a>on 192.168.232.121/122 lvs1.hank.im/lvs2.hank.im</h3><p>查看内核版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uname -rm</span><br><span class="line">3.10.0-1062.12.1.el7.x86_64 x86_64</span><br></pre></td></tr></table></figure>
<p>安装工具</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum group install Development Tools -y</span><br><span class="line">yum install net-tools vim tcpdump -y</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config</span><br></pre></td></tr></table></figure>
<p>安装ipvs</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ipvsadm</span><br><span class="line">ipvsadm</span><br></pre></td></tr></table></figure>
<p>查看内核是否加载ipvs</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lsmod | grep ip_vs</span><br><span class="line">ip_vs                 145497  0</span><br><span class="line">nf_conntrack          139224  7 ip_vs,nf_nat,nf_nat_ipv4,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_netlink,nf_conntrack_ipv4</span><br><span class="line">libcrc32c              12644  4 xfs,ip_vs,nf_nat,nf_conntrack</span><br></pre></td></tr></table></figure>
<p>安装keepalived</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install keepalived ipvsadm  -y</span><br></pre></td></tr></table></figure>
<h3 id="on-192-168-232-121-lvs1-hank-im"><a href="#on-192-168-232-121-lvs1-hank-im" class="headerlink" title="on 192.168.232.121 lvs1.hank.im"></a>on 192.168.232.121 lvs1.hank.im</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs1 ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id nginx.hank.im</span><br><span class="line">    #vrrp_mcast_group4 10.0.7.110</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33 vrrp</span><br><span class="line">    virtual_router_id 51 # vrrp id</span><br><span class="line">    priority 150 # weight</span><br><span class="line">    nopreempt    # 非抢占</span><br><span class="line">    advert_int 1 # heartbeat 1s</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass haha</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    track_interface &#123;</span><br><span class="line">        ens33</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.232.120/24 dev ens33</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.232.120 80 &#123;</span><br><span class="line">    delay_loop 3  # delay_loop</span><br><span class="line">    #lvs_sched rr  # LVS的调度算法</span><br><span class="line">    #lvs_method DR  #  LVS 模式</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    protocol TCP # 4层协议</span><br><span class="line">    real_server 192.168.232.111 80 &#123;</span><br><span class="line">        weight 100</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3  # get尝试次数</span><br><span class="line">            delay_before_retry 10 # 在尝试之前延迟多长时间</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    real_server 192.168.232.112 80 &#123;</span><br><span class="line">        weight 100</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3  # get尝试次数</span><br><span class="line">            delay_before_retry 10 # 在尝试之前延迟多长时间</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="on-192-168-232-122-lvs2-hank-im"><a href="#on-192-168-232-122-lvs2-hank-im" class="headerlink" title="on 192.168.232.122 lvs2.hank.im"></a>on 192.168.232.122 lvs2.hank.im</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">state MASTER</span><br><span class="line">改成</span><br><span class="line">state SLAVE</span><br></pre></td></tr></table></figure>
<h3 id="on-192-168-232-121-122-lvs1-hank-im-lvs2-hank-im-1"><a href="#on-192-168-232-121-122-lvs1-hank-im-lvs2-hank-im-1" class="headerlink" title="on 192.168.232.121/122 lvs1.hank.im/lvs2.hank.im"></a>on 192.168.232.121/122 lvs1.hank.im/lvs2.hank.im</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs1 ~]# systemctl restart keepalived</span><br><span class="line">[root@lvs1 ~]# ipvsadm -Ln</span><br><span class="line">[root@lvs2 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  192.168.232.120:80 rr</span><br><span class="line">  -&gt; 192.168.232.111:80           Route   100    0          0</span><br><span class="line">  -&gt; 192.168.232.112:80           Route   100    0          0</span><br></pre></td></tr></table></figure>
<h3 id="部署nginx"><a href="#部署nginx" class="headerlink" title="部署nginx"></a>部署nginx</h3><h3 id="on-192-168-232-111-112-nginx1-hank-im-nginx2-hank-im"><a href="#on-192-168-232-111-112-nginx1-hank-im-nginx2-hank-im" class="headerlink" title="on 192.168.232.111/112 nginx1.hank.im/nginx2.hank.im"></a>on 192.168.232.111/112 nginx1.hank.im/nginx2.hank.im</h3><p>安装工具</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum group install Development Tools -y</span><br><span class="line">yum install net-tools vim tcpdump -y</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config</span><br></pre></td></tr></table></figure>
<p>更新源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rm -rfv /etc/yum.repos.d/*</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo</span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">yum -y install docker-ce</span><br></pre></td></tr></table></figure>
<p>安装docker-compose</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://get.daocloud.io/docker/compose/releases/download/1.24.0/docker-compose-`uname -s`-`uname -m` &gt; /usr/bin/docker-compose</span><br><span class="line">chmod +x /usr/bin/docker-compose</span><br><span class="line">mkdir /etc/docker</span><br><span class="line">cat &gt;&gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;graph&quot;: &quot;/data/docker&quot;,</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://cqu2yr19.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">systemctl start docker</span><br><span class="line">docker info</span><br></pre></td></tr></table></figure>
<p>安装docker nginx镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx2 shells]# mkdir /data/hank/shells -p</span><br><span class="line">[root@nginx2 shells]# cd /data/hank/shells</span><br><span class="line">[root@nginx2 shells]# cat .env </span><br><span class="line">HOST_UID=0</span><br><span class="line">HOST_GID=0</span><br><span class="line"></span><br><span class="line">[root@nginx2 shells]# cat docker-compose-nginx.yml</span><br><span class="line">version: &#x27;3&#x27;</span><br><span class="line">services:</span><br><span class="line">  nginx:</span><br><span class="line">    image: nginx:1.19.1</span><br><span class="line">    restart: always</span><br><span class="line">    container_name: nginx</span><br><span class="line">    ports:</span><br><span class="line">      - 80:80</span><br><span class="line">      - 443:443</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/hank/logs/nginx:/var/log/nginx</span><br><span class="line">      - /data/hank/config/nginx/conf.d:/etc/nginx/conf.d</span><br><span class="line">      - /data/hank/data/nginx:/html</span><br><span class="line">    environment:</span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">      - HOST_UID=$&#123;HOST_UID&#125;</span><br><span class="line">      - HOST_GID=$&#123;HOST_GID&#125;</span><br><span class="line">    logging:</span><br><span class="line">      options:</span><br><span class="line">        max-size: &#x27;100m&#x27;</span><br><span class="line">        max-file: &#x27;10&#x27;</span><br><span class="line"></span><br><span class="line">[root@nginx2 shells]# docker-compose -f docker-compose-nginx.yml up -d</span><br><span class="line">[root@nginx2 shells]# cat /data/hank/config/nginx/conf.d/hello.conf</span><br><span class="line"># HTTP redirect</span><br><span class="line">server &#123;</span><br><span class="line">    listen      80;</span><br><span class="line">    listen      [::]:80;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="on-192-168-232-111-nginx1-hank-im"><a href="#on-192-168-232-111-nginx1-hank-im" class="headerlink" title="on 192.168.232.111 nginx1.hank.im"></a>on 192.168.232.111 nginx1.hank.im</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx1 shells]# cat  /data/hank/data/nginx/index.html</span><br><span class="line">&lt;h1&gt;hello world&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;br&gt;</span><br><span class="line">nginx1.hank.im&lt;br&gt;</span><br><span class="line">192.168.232.111</span><br></pre></td></tr></table></figure>
<h3 id="on-192-168-232-112-nginx2-hank-im"><a href="#on-192-168-232-112-nginx2-hank-im" class="headerlink" title="on 192.168.232.112 nginx2.hank.im"></a>on 192.168.232.112 nginx2.hank.im</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx2 shells]# cat  /data/hank/data/nginx/index.html</span><br><span class="line">&lt;h1&gt;hello world&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;br&gt;</span><br><span class="line">nginx2.hank.im&lt;br&gt;</span><br><span class="line">192.168.232.112</span><br></pre></td></tr></table></figure>
<h3 id="on-192-168-232-121-122-nginx1-hank-im-nginx2-hank-im"><a href="#on-192-168-232-121-122-nginx1-hank-im-nginx2-hank-im" class="headerlink" title="on 192.168.232.121/122 nginx1.hank.im/nginx2.hank.im"></a>on 192.168.232.121/122 nginx1.hank.im/nginx2.hank.im</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx2 shells]# docker exec -it nginx nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@nginx2 shells]# docker exec -it nginx nginx -s reload</span><br></pre></td></tr></table></figure>
<h3 id="开启lo回环地址与vip绑定"><a href="#开启lo回环地址与vip绑定" class="headerlink" title="开启lo回环地址与vip绑定"></a>开启lo回环地址与vip绑定</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx2 ~]# cd lvs_real.sh</span><br><span class="line">[root@nginx2 ~]# lvs_real.sh start </span><br><span class="line">RealServer Start OK</span><br></pre></td></tr></table></figure>
<h2 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h2><h4 id="on-client-ip"><a href="#on-client-ip" class="headerlink" title="on client ip"></a>on client ip</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ curl http://192.168.232.120/</span><br><span class="line">&lt;h1&gt;hello world&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;br&gt;</span><br><span class="line">nginx2.hank.im&lt;br&gt;</span><br><span class="line">192.168.232.112</span><br><span class="line">➜  ~ curl http://192.168.232.120/</span><br><span class="line">&lt;h1&gt;hello world&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;br&gt;</span><br><span class="line">nginx1.hank.im&lt;br&gt;</span><br><span class="line">192.168.232.111</span><br><span class="line">➜  ~ curl http://192.168.232.120/</span><br><span class="line">&lt;h1&gt;hello world&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;br&gt;</span><br><span class="line">nginx2.hank.im&lt;br&gt;</span><br><span class="line">192.168.232.112</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/06/pgsql-%E5%BA%93%E8%A1%A8%E5%AF%B9%E8%80%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/06/pgsql-%E5%BA%93%E8%A1%A8%E5%AF%B9%E8%80%83/" class="post-title-link" itemprop="url">pgsql 库表对考</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-09-06 21:57:06 / Modified: 22:22:24" itemprop="dateCreated datePublished" datetime="2021-09-06T21:57:06+08:00">2021-09-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>适合大量数据拷贝</p>
<p>sudo docker exec -i -e PGPASSWORD= pgsql pg_dump -t</p>
<p>-d -U -h | sudo docker exec -i -e PGPASSWORD= pgsql psql -U -h &gt;&gt; /dev/null 2&gt;&amp;1<br>pg_dump 选项<br>下列命令选项控制输出的内容和格式。</p>
<p>dbname<br>指定要被转储的数据库名。如果没有指定，将使用环境变量PGDATABASE。如果环境变量也没有设置，则使用指定给该连接的用户名。</p>
<p>-a<br>—data-only<br>只转储数据，而不转储模式（数据定义）。表数据、大对象和序列值都会被转储。</p>
<p>这个选项类似于指定—section=data，但是由于历史原因又不完全相同。</p>
<p>-b<br>—blobs<br>在转储中包括大对象。这是当—schema、—table或 —schema-only被指定时的默认行为，因此-b 开关仅对于将大对象添加到已请求特定模式或表的转储中时有用。 请注意，blob被视为数据，因此仅在使用—data-only时才会包含， 但在—schema-only时不会包含。</p>
<p>-B<br>—no-blobs<br>排除转储中的大对象。</p>
<p>当给定-b和-B时，行为是当数据被转储时输出大对象， 请参阅-b文档。</p>
<p>-c<br>—clean<br>在输出创建数据库对象的命令之前输出清除（删除）它们的命令 （除非也指定了—if-exists，如果任何对象不存在于 目的数据库中，恢复可能会产生一些伤害性的错误消息）。</p>
<p>这个选项只对纯文本格式有意义。对于归档格式，你可以在调用pg_restore时指定该选项。</p>
<p>-C<br>—create<br>使得在输出的开始是一个创建数据库本身并且重新连接到被创建的数据库的命令（通过这种形式的一个脚本，在运行脚本之前你连接的是目标安装中的哪个数据库都没有关系）。如果也指定了—clean，脚本会在重新连接到目标数据库之前先删除它然后再重建。</p>
<p>这个选项只对纯文本格式有意义。对于归档格式，你可以在你调用pg_restore时指定这个选项。</p>
<p>-E encoding<br>—encoding=encoding<br>以指定的字符集编码创建转储。在默认情况下，该转储会以该数据库的编码创建（另一种得到相同结果的方式是将PGCLIENTENCODING环境变量设置成想要的转储编码）。</p>
<p>-f file<br>—file=file<br>将输出发送到指定文件。对于基于输出格式的文件这个参数可以被忽略，在那种情况下将使用标准输出。不过对于目录输出格式必须给定这个参数，在目录输出格式中指定的是一个目录而不是一个文件。在这种情况中，该目录会由pg_dump创建并且不需要以前就存在。</p>
<p>-F format<br>—format=format<br>选择输出的格式。format可以是下列之一：</p>
<p>p<br>plain<br>输出一个纯文本形式的SQL脚本文件（默认值）。</p>
<p>c<br>custom<br>输出一个适合于作为pg_restore输入的自定义格式归档。和目录输出格式一起，这是最灵活的输出格式，它允许在恢复时手动选择和排序已归档的项。这种格式在默认情况还会被压缩。</p>
<p>d<br>directory<br>输出一个适合作为pg_restore输入的目录格式归档。这将创建一个目录，其中每个被转储的表和大对象都有一个文件，外加一个所谓的目录文件，该文件以一种pg_restore能读取的机器可读格式描述被转储的对象。一个目录格式归档能用标准 Unix 工具操纵，例如一个未压缩归档中的文件可以使用gzip工具压缩。这种格式默认情况下是被压缩的并且也支持并行转储。</p>
<p>t<br>tar<br>输出一个适合于输入到pg_restore中的tar-格式归档。tar 格式可以兼容目录格式，抽取一个 tar 格式的归档会产生一个合法的目录格式归档。不过，tar 格式不支持压缩。还有，在使用 tar 格式时，表数据项的相对顺序不能在恢复过程中被更改。</p>
<p>-j njobs<br>—jobs=njobs<br>通过同时归档njobs个表来运行并行转储。这个选项缩减了转储的时间，但是它也增加了数据库服务器上的负载。你只能和目录输出格式一起使用这个选项，因为这是唯一一种让多个进程能在同一时间写其数据的输出格式。</p>
<p>pg_dump将打开njobs + 1 个到该数据库的连接，因此确保你的max_connections设置足够高以容纳所有的连接。</p>
<p>在运行一次并行转储时请求数据库对象上的排他锁可能导致转储失败。其原因是，pg_dump主控进程会在工作者进程将要稍后转储的对象上请求共享锁，以便确保在转储运行时不会有人删除它们并让它们出错。如果另一个客户端接着请求一个表上的排他锁，那个锁将不会被授予但是会被排入队列等待主控进程的共享锁被释放。因此，任何其他对该表的访问将不会被授予或者将排在排他锁请求之后。这包括尝试转储该表的工作者进程。如果没有任何防范措施，这可能会是一种经典的死锁情况。要检测这种冲突，pg_dump工作者进程使用NOWAIT选项请求另一个共享锁。 如果该工作者进程没有被授予这个共享锁，其他某人必定已经在同时请求了一个排他锁并且没有办法继续转储，因此pg_dump除了中止转储之外别无选择。</p>
<p>对于一个一致的备份，数据库服务器需要支持同步的快照，在PostgreSQL 9.2中引入了一种针对主服务器特性和10个针对备用服务器的特性。有了这种特性，即便数据库客户端使用不同的连接，也可以保证他们看到相同的数据集。pg_dump -j使用多个数据库连接，它用主控进程连接到数据一次，并且为每一个工作者任务再一次连接数据库。如果没有同步快照特征，在每一个连接中不同的工作者任务将不能被保证看到相同的数据，这可能导致一个不一致的备份。</p>
<p>如果你希望运行一个 9.2 之前服务器的并行转储，你需要确保数据库内容从主控进程连接到数据库一直到最后一个工作者任务连接到数据库之间不会改变。做这些最简单的方法是在开始备份之前停止任何访问数据库的数据修改进程（DDL 以及 DML）。当对一个 9.2 之前的PostgreSQL服务器运行pg_dump -j时，你还需要指定—no-synchronized-snapshots参数。</p>
<p>-n schema<br>—schema=schema<br>只转储匹配schema的模式，这会选择模式本身以及它所包含的所有对象。当没有指定这个选项时，目标数据库中所有非系统模式都将被转储。多个模式可以通过书写多个-n开关来选择。另外，schema参数可以被解释为一种根据psql’s \d命令所用的相同规则（见模式（Pattern））编写的模式，这样多个模式也可以通过在该模式中书写通配字符来选择。在使用通配符时，如果需要阻止 shell 展开通配符需要小心引用该模式，见实例。</p>
<p>注意<br>当-n被指定时，pg_dump不会尝试转储所选模式可能依赖的任何其他数据库对象。因此，无法保证一次指定模式转储的结果能够仅凭其本身被成功地恢复到一个干净的数据库中。</p>
<p>注意<br>当-n被指定时，非模式对象（如二进制大对象）不会被转储。你可以使用—blobs开关将二进制大对象加回到该转储中。</p>
<p>-N schema<br>—exclude-schema=schema<br>不转储匹配schema模式的任何模式。该模式被根据-n所用的相同规则被解释。-N可以被给定多次来排除匹配几个模式中任意一个的模式。</p>
<p>当-n和-N都被给定时，该行为是只转储匹配至少一个-n开关但是不匹配-N开关的模式。如果只有-N而没有-n，那么匹配-N的模式会被从一个正常转储中排除。</p>
<p>-o<br>—oids<br>转储对象标识符（OID）作为每个表数据的一部分。如果你的应用以某种方式引用OID列（例如在一个外键约束中），应使用这个选项。否则，这个选项不应该被使用。</p>
<p>-O<br>—no-owner<br>不输出设置对象拥有关系来匹配原始数据库的命令。默认情况下，pg_dump会发出ALTER OWNER或SET SESSION AUTHORIZATION语句来设置被创建的数据库对象的拥有关系。除非该脚本被一个超级用户（或是拥有脚本中所有对象的同一个用户）启动，这些语句都将会失败。要使一个脚本能够被任意用户恢复，但把所有对象的拥有关系都给这个用户，可指定-O。</p>
<p>这个选项只对纯文本格式有意义。对于归档格式，你可以在调用pg_restore时指定该选项。</p>
<p>-R<br>—no-reconnect<br>这个选项已经废弃，但是为了向后兼容仍然能被接受。</p>
<p>-s<br>—schema-only<br>只转储对象定义（模式），而非数据。</p>
<p>这个选项是—data-only的逆选项。它和指定—section=pre-data —section=post-data相似，但是由于历史原因又不完全相同。</p>
<p>（不要把这个选项和—schema选项混淆，后者在“schema”的使用上有不同的含义）。</p>
<p>要为数据库中表的一个子集排除表数据，见—exclude-table-data。</p>
<p>-S username<br>—superuser=username<br>指定要在禁用触发器时使用的超级用户的用户名。只有使用—disable-triggers时，这个选项才相关（通常，最好省去这个选项，而作为超级用户来启动结果脚本来取而代之）。</p>
<p>-t table<br>—table=table<br>只转储名字匹配table的表，“table”还可以包括视图、物化视图、序列和外部表。通过写多个-t开关可以选择多个表。另外，table参数可以被解释为一种根据psql’s \d命令所用的相同规则（见模式（Pattern））编写的模式，这样多个表也可以通过在该模式中书写通配字符来选择。在使用通配符时，如果需要阻止 shell 展开通配符需要小心引用该模式，见实例。</p>
<p>当-t被使用时，-n和-N开关不会有效果，因为被-t选择的表将被转储而无视那些开关，并且非表对象将不会被转储。</p>
<p>注意<br>当-t被指定时，pg_dump不会尝试转储所选表可能依赖的任何其他数据库对象。因此，无法保证一次指定表转储的结果能够仅凭其本身被成功地恢复到一个干净的数据库中。</p>
<p>注意<br>-t开关的行为不完全向前兼容 8.2 之前的PostgreSQL版本。以前，写-t tab将转储所有命名为tab的表，但现在它仅仅转储在你默认搜索路径中可见的那一个。要得到旧的行为，你可以写成-t ‘*.tab’。还有，你必须写类似-t sch.tab的东西来选择一个特定模式中的一个表，而不是用老的惯用语-n sch -t tab。</p>
<p>-T table<br>—exclude-table=table<br>不转储匹配table模式的任何表。该模式被根据-t所用的相同规则被解释。-T可以被给定多次来排除匹配几个模式中任意一个的模式。</p>
<p>当-t和-T都被给定时，该行为是只转储匹配至少一个-t开关但是不匹配-T开关的表。如果只有-T而没有-t，那么匹配-T的表会被从一个正常转储中排除。</p>
<p>-v<br>—verbose<br>指定冗长模式。这将导致pg_dump向标准错误输出详细的对象注释以及转储文件的开始/停止时间，还有进度消息。</p>
<p>-V<br>—version<br>pg_dump版本并退出。</p>
<p>-x<br>—no-privileges<br>—no-acl<br>防止转储访问特权（授予/收回命令）。</p>
<p>-Z 0..9<br>—compress=0..9<br>指定要使用的压缩级别。零意味着不压缩。对于自定义归档格式，这会指定个体表数据段的压缩，并且默认是进行中等级别的压缩。对于纯文本输出，设置一个非零压缩级别会导致整个输出文件被压缩，就好像它被gzip处理过一样，但是默认是不压缩。tar 归档格式当前完全不支持压缩。</p>
<p>—binary-upgrade<br>这个选项用于就地升级功能。我们不推荐也不支持把它用于其他目的。这个选项在未来的发行中可能被改变而不做通知。</p>
<p>—column-inserts<br>—attribute-inserts<br>将数据转储为带有显式列名的INSERT命令（INSERT INTO table (column, …) VALUES …）。这将使得恢复过程非常慢，这主要用于使转储能够被载入到非PostgreSQL数据库中。不过，由于这个选项为每一行都产生一个单独的命令，重载一行时的一个错误只会导致那一行被丢失而不是整个表内容丢失。</p>
<p>—disable-dollar-quoting<br>这个选项禁止在函数体中使用美元符号引用，并且强制它们使用 SQL 标准字符串语法被引用。</p>
<p>—disable-triggers<br>只有在创建一个只转储数据的转储时，这个选项才相关。它指示pg_dump包括在数据被重新载入时能够临时禁用目标表上的触发器的命令。如果你在表上有引用完整性检查或其他触发器，并且你在数据重新载入期间不想调用它们，请使用这个选项。</p>
<p>当前，为—disable-triggers发出的命令必须作为超级用户来执行。因此，你还应当使用-S指定一个超级用户名，或者宁可作为一个超级用户启动结果脚本。</p>
<p>这个选项只对纯文本格式有意义。对于归档格式，你可以在调用pg_restore时指定这个选项。</p>
<p>—enable-row-security<br>只有在转储具有行安全性的表的内容时，这个选项才相关。默认情况下， pg_dump将把 row_security设置为 off 来确保从该表中转储 出所有的数据。如果用户不具有足够能绕过行安全性的特权，那么会抛出 一个错误这个参数指示pg_dump将 row_security设置为 on，允许用户只转储该表中 它们能够访问到的部分内容。</p>
<p>请注意，如果您当前使用此选项，则可能还需要以INSERT格式转储， 因为还原期间的COPY FROM不支持行安全性。</p>
<p>—exclude-table-data=table<br>不转储匹配table模式的任何表中的数据。该模式根据-t的相同规则被解释。—exclude-table-data可以被给定多次来排除匹配多个模式的表。当你需要一个特定表的定义但不想要其中的数据时，这个选项就有用了。</p>
<p>要排除数据库中所有表的数据，见—schema-only。</p>
<p>—if-exists<br>时间条件性命令（即增加一个IF EXISTS子句）来清除数据库和其他对象。 只有同时指定了—clean时，这个选项才可用。</p>
<p>—inserts<br>将数据转储为INSERT命令（而不是COPY）。这将使得恢复非常慢，这主要用于使转储能够被载入到非PostgreSQL数据库中。不过，由于这个选项为每一行都产生一个单独的命令，重载一行时的一个错误只会导致那一行被丢失而不是整个表内容丢失。注意如果你已经重新安排了列序，该恢复可能会一起失败。—column-inserts选项对于列序改变是安全的，但是会更慢。</p>
<p>—lock-wait-timeout=timeout<br>在转储的开始从不等待共享表锁的获得。而是在指定的timeout内不能锁定一个表时失败。超时时长可以用SET statement_timeout接受的任何格式指定（允许的格式根据你从其转出的服务器版本变化，但是所有版本都接受一个整数表示的毫秒数。）。</p>
<p>—no-publications<br>不转储发布。</p>
<p>—no-security-labels<br>不转储安全标签。</p>
<p>—no-subscriptions<br>不转储订阅。</p>
<p>—no-sync<br>默认情况下，pg_dump将等待所有文件安全写入磁盘。 这个选项会导致pg_dump无需等待而返回，这更快， 但意味着后续的操作系统崩溃可能会导致转储损坏。通常， 此选项对于测试非常有用，但在从生产安装中转储数据时不应使用此选项。</p>
<p>—no-synchronized-snapshots<br>这个选项允许对 9.2 以前的服务器运行pg_dump -j，详见-j参数的文档。</p>
<p>—no-tablespaces<br>不要输出选择表空间的命令。通过这个选项，在恢复期间所有的对象都会被创建在任何作为默认的表空间中。</p>
<p>这个选项只对纯文本格式有意义。对于归档格式，你可以在调用pg_restore时指定该选项。</p>
<p>—no-unlogged-table-data<br>不转储非日志记录表的内容。这个选项对于表定义（模式）是否被转储没有影响，它只会限制转储表数据。当从一个后备服务器转储时，在非日志记录表中的数据总是会被排除。</p>
<p>—quote-all-identifiers<br>强制引用所有标识符。当从PostgreSQL主版本与pg_dump不同的服务器上转储一个数据库时或者当输出准备载入到一个具有不同主版本的服务器时，推荐使用这个选项。默认情况下，pg_dump只对在其主版本中是被保留词的标识符加上引号。在转储其他版本服务器时，这种默认行为有时会导致兼容性问题，因为那些版本可能具有些许不同的被保留词集合。使用—quote-all-identifiers能阻止这种问题，但代价是转储脚本更难阅读。</p>
<p>—section=sectionname<br>只转储命名节。节的名称可以是pre-data、data或post-data。这个选项可以被指定多次来选择多个节。默认是转储所有节。</p>
<p>数据节包含真正的表数据、大对象内容和序列值。数据后项包括索引、触发器、规则和除了已验证检查约束之外的约束的定义。数据前项包括所有其他数据定义项。</p>
<p>—serializable-deferrable<br>为转储使用一个可序列化事务，以保证所使用的快照与后来的数据库状态是一致的。但是这样做是在事务流中等待一个点，在该点上不能存在异常，这样就不会有转储失败或者导致其他事务带着serialization_failure回滚的风险。关于事务隔离和并发控制详见第 13 章。</p>
<p>对于一个只为灾难恢复存在的转储，这个选项没什么益处。如果一个转储被用来在原始数据库持续被更新期间载入一份用于报表或其他只读负载的数据库拷贝时，这个选项就有所帮助。如果没有这个选项，转储可能会反映一个与最终提交事务的任何执行序列都不一致的状态。例如，如果使用了批处理技术，一个批处理在转储中可以显示为关闭，而其中的所有项都不出现。</p>
<p>如果 pg_dump 被启动时没有读写事务在活动，则这个选项没有什么不同。如果有读写事务在活动，该转储的启动可能会被延迟一段不确定的时间。一旦开始运行，有没有这个开关的表现是相同的。</p>
<p>—snapshot=snapshotname<br>在做一个数据库的转储时指定一个同步的快照（详见 表 9.82）。</p>
<p>在需要把转储和一个逻辑复制槽（见第 48 章） 或者一个并发会话同步时可以用上这个选项。</p>
<p>在并行转储的情况下，将使用这个选项指定的快照名而不是取一个新快照。</p>
<p>—strict-names<br>要求每一个模式（-n/—schema）和表（-t/—table）限定符匹配要转储的数据库中至少一个模式/表。注意，如果没有找到有这样的模式/表限定符匹配，即便没有—strict-names，pg_dump也将生成一个错误。</p>
<p>这个选项对-N/—exclude-schema、-T/—exclude-table或者—exclude-table-data没有效果。无法匹配任何对象的排除模式不会被当作错误。</p>
<p>—use-set-session-authorization<br>输出 SQL-标准的SET SESSION AUTHORIZATION命令取代ALTER OWNER命令来确定对象的所有关系。这让该转储更加兼容标准，但是取决于该转储中对象的历史，该转储可能无法正常恢复。而且，一个使用SET SESSION AUTHORIZATION的转储将一定会要求超级用户特权来正确地恢复，而ALTER OWNER要求更少的特权。</p>
<p>-?<br>—help<br>显示有关pg_dump命令行参数的帮助并退出。</p>
<p>下列命令行选项控制数据库连接参数。</p>
<p>-d dbname<br>—dbname=dbname<br>指定要连接到的数据库名。这等效于指定dbname为命令行上的第一个非选项参数。</p>
<p>如果这个参数包含一个=符号或者以一个合法的URI前缀（postgresql://或postgres://）开始，它将被视作一个conninfo字符串。详见第 33.1 节。</p>
<p>-h host<br>—host=host<br>指定服务器正在运行的机器的主机名。如果该值开始于一个斜线，它被用作一个 Unix 域套接字的目录。默认是从PGHOST环境变量中取得（如果被设置），否则将尝试一次 Unix 域套接字连接。</p>
<p>-p port<br>—port=port<br>指定服务器正在监听连接的 TCP 端口或本地 Unix 域套接字文件扩展名。默认是放在PGPORT环境变量中（如果被设置），否则使用编译在程序中的默认值。</p>
<p>-U username<br>—username=username<br>要作为哪个用户连接。</p>
<p>-w<br>—no-password<br>从不发出一个口令提示。如果服务器要求口令认证并且没有其他方式提供口令（例如一个.pgpass文件），那么连接尝试将失败。这个选项对于批处理任务和脚本有用，因为在其中没有一个用户来输入口令。</p>
<p>-W<br>—password<br>强制pg_dump在连接到一个数据库之前提示要求一个口令。</p>
<p>这个选项从来不是必须的，因为如果服务器要求口令认证，pg_dump将自动提示要求一个口令。但是，pg_dump将浪费一次连接尝试来发现服务器想要一个口令。在某些情况下，值得键入-W来避免额外的连接尝试。</p>
<p>—role=rolename<br>指定一个用来创建该转储的角色名。这个选项导致pg_dump在连接到数据库后发出一个SET ROLE rolename命令。当已认证用户（由-U指定）缺少pg_dump所需的特权但是能够切换到一个具有所需权利的角色时，这个选项很有用。一些安装有针对直接作为超级用户登录的策略，使用这个选项可以让转储在不违反该策略的前提下完成。</p>
<p>环境<br>PGDATABASE<br>PGHOST<br>PGOPTIONS<br>PGPORT<br>PGUSER<br>默认连接参数</p>
<p>和大部分其他PostgreSQL工具相似，这个工具也使用libpq（见第 33.14 节）支持的环境变量。</p>
<p>诊断<br>pg_dump在内部执行SELECT语句。如果你运行pg_dump时出现问题，确定你能够从正在使用的数据库中选择信息，例如psql。此外，libpq前端-后端库所使用的任何默认连接设置和环境变量都将适用。</p>
<p>pg_dump的数据库活动会被统计收集器正常地收集。如果不想这样，你可以通过PGOPTIONS或ALTER USER命令设置参数track_counts为假。</p>
<p>注解<br>如果你的数据库集簇对于template1数据库有任何本地添加，要注意将pg_dump的输出恢复到一个真正的空数据库。否则你很可能由于以增加对象的重复定义而得到错误。要创建一个不带任何本地添加的空数据库，从template0而不是template1复制它，例如：</p>
<p>CREATE DATABASE foo WITH TEMPLATE template0;<br>当一个只含数据的转储被选中并且使用了选项—disable-triggers时，pg_dump在开始插入数据之前会发出命令禁用用户表上的触发器，并且接着在数据被插入之后发出命令重新启用它们。如果恢复中途被停止，系统目录可能会停留在一种错误状态。</p>
<p>pg_dump产生的转储文件不包含优化器用来做出查询计划决定的统计信息。因此，在从一个转储文件恢复后运行ANALYZE来确保最优性能是明智的，详见第 24.1.3 节和第 24.1.6 节。转储文件也不包含任何ALTER DATABASE … SET命令，这些设置会与数据库用户及其他安装设置一起被pg_dumpall转储。</p>
<p>因为pg_dump被用来传输数据到更新版本的PostgreSQL，pg_dump的输出被认为可以载入到比pg_dump版本更新的PostgreSQL服务器中。pg_dump也能够从比其版本更旧的PostgreSQL服务器中转储（当前支持回退到版本 8.0）。不过，pg_dump无法从比起主版本号更新的PostgreSQL服务器中转储，它甚至将拒绝冒着创建一个非法转储的风险尝试。还有，不保证pg_dump的输出能被载入到一个更旧主版本的服务器 — 即使该转储是从该版本的服务器中被取得也不行。将一个转储文件载入到一个更旧的服务器可能需要手工编辑该转储文件来移除旧服务器无法理解的语法。在跨版本的情况下，推荐使用—quote-all-identifiers选项，因为它可以避免因为不同PostgreSQL版本间的保留词列表变化而发生问题。</p>
<p>在转储逻辑复制订阅时，pg_dump将生成使用 NOCONNECT选项的CREATE SUBSCRIPTION命令， 以便恢复订阅不会创建远程连接复制插槽或初始表副本。这样，可以恢复转储， 而不需要网络访问远程服务器。然后由用户以合适的方式重新激活订阅。 如果涉及的主机已更改，则可能必须更改连接信息。 在启动新的全表副本之前截断目标表也许是适当的。</p>
<p>实例<br>要把一个数据库mydb转储到一个 SQL 脚本文件：</p>
<p>$ pg_dump mydb &gt; db.sql<br>要把这样一个脚本重新载入到一个（新创建的）名为newdb的数据库中：</p>
<p>$ psql -d newdb -f db.sql<br>要转储一个数据库到一个自定义格式归档文件：</p>
<p>$ pg_dump -Fc mydb &gt; db.dump<br>要转储一个数据库到一个目录格式的归档：</p>
<p>$ pg_dump -Fd mydb -f dumpdir<br>要用 5 个并行的工作者任务转储一个数据库到一个目录格式的归档：</p>
<p>$ pg_dump -Fd mydb -j 5 -f dumpdir<br>要把一个归档文件重新载入到一个（新创建的）名为newdb的数据库：</p>
<p>$ pg_restore -d newdb db.dump<br>要转储一个名为mytab的表：</p>
<p>$ pg_dump -t mytab mydb &gt; db.sql<br>要转储detroit模式中名称以emp开始的所有表，排除名为employee_log的表：</p>
<p>$ pg_dump -t ‘detroit.emp*’ -T detroit.employee_log mydb &gt; db.sql<br>要转储名称以east或者west开始并且以gsm结束的所有模式，排除名称包含词test的任何模式：</p>
<p>$ pg_dump -n ‘eastgsm’ -n ‘westgsm’ -N ‘test‘ mydb &gt; db.sql<br>同样，用正则表达式记号法来合并开关：</p>
<p>$ pg<em>dump -n ‘(east|west)gsm’ -N ‘test*’ mydb &gt; db.sql<br>要转储除了名称以ts</em>开头的表之外的所有数据库对象：</p>
<p>$ pg<em>dump -T ‘ts</em>*’ mydb &gt; db.sql<br>要在-t和相关开关中指定一个大写形式或混合大小写形式的名称，你需要双引用该名称，否则它会被折叠到小写形式（见模式（Pattern））。但是双引号对于 shell 是特殊的，所以反过来它们必须被引用。因此，要转储一个有混合大小写名称的表，你需要类似这样的东西：</p>
<p>$ pg_dump -t “\”MixedCaseName\”” mydb &gt; mytab.sql</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/06/Docker-%E6%8E%92%E6%9F%A5%E6%80%9D%E8%B7%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/06/Docker-%E6%8E%92%E6%9F%A5%E6%80%9D%E8%B7%AF/" class="post-title-link" itemprop="url">Docker 排查思路</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-09-06 21:38:50 / Modified: 22:22:24" itemprop="dateCreated datePublished" datetime="2021-09-06T21:38:50+08:00">2021-09-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DOCKER/" itemprop="url" rel="index"><span itemprop="name">DOCKER</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-查看当时docker状态"><a href="#1-查看当时docker状态" class="headerlink" title="1 查看当时docker状态"></a>1 查看当时docker状态</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo docker stats</span><br><span class="line"> </span><br><span class="line">sudo docker ps</span><br><span class="line"> </span><br><span class="line">sudo docker ps -a</span><br></pre></td></tr></table></figure>
<h3 id="2-容器本身日志"><a href="#2-容器本身日志" class="headerlink" title="2 容器本身日志"></a>2 容器本身日志</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker inspect &lt;container name/hash&gt; |grep log</span><br></pre></td></tr></table></figure>
<h3 id="3-docker-事件日志"><a href="#3-docker-事件日志" class="headerlink" title="3 docker 事件日志"></a>3 docker 事件日志</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo journalctl -u docker.service &gt;/tmp/docker_service.log</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/30/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E5%86%85%E5%AD%98%E7%AF%87-Linux%E5%86%85%E5%AD%98%E6%98%AF%E6%80%8E%E4%B9%88%E5%B7%A5%E4%BD%9C%E7%9A%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/30/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E5%86%85%E5%AD%98%E7%AF%87-Linux%E5%86%85%E5%AD%98%E6%98%AF%E6%80%8E%E4%B9%88%E5%B7%A5%E4%BD%9C%E7%9A%84/" class="post-title-link" itemprop="url">性能优化-内存篇 Linux内存是怎么工作的</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-30 14:52:35" itemprop="dateCreated datePublished" datetime="2020-07-30T14:52:35+08:00">2020-07-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-09-06 22:22:24" itemprop="dateModified" datetime="2021-09-06T22:22:24+08:00">2021-09-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%B3%BB%E7%BB%9F%E4%BC%98%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">系统优化</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="内存映射"><a href="#内存映射" class="headerlink" title="内存映射"></a>内存映射</h3><p>说到内存，你能说出你现在用的这台计算机内存有多大吗？我估计你记得很清楚，因为这是我们购买时，首先考虑的一个重要参数，比方说，我的笔记本电脑内存就是 8GB 的 。</p>
<p>我们通常所说的内存容量，就像我刚刚提到的 8GB，其实指的是物理内存。物理内存也称为主存，大多数计算机用的主存都是动态随机访问内存（DRAM）。只有内核才可以直接访问物理内存。那么，进程要访问内存时，该怎么办呢？</p>
<p>Linux 内核给每个进程都提供了一个独立的虚拟地址空间，并且这个地址空间是连续的。这样，进程就可以很方便地访问内存，更确切地说是访问虚拟内存。</p>
<p>虚拟地址空间的内部又被分为内核空间和用户空间两部分，不同字长（也就是单个 CPU 指令可以处理数据的最大长度）的处理器，地址空间的范围也不同。比如最常见的 32 位和 64 位系统，我画了两张图来分别表示它们的虚拟地址空间，如下所示：</p>
<p><img src="/images/2020/07/29/8461d1a5-cbc6-43a6-8411-83cc51fdcfc1.png" alt="image.png"></p>
<p>通过这里可以看出，32 位系统的内核空间占用 1G，位于最高处，剩下的 3G 是用户空间。而 64 位系统的内核空间和用户空间都是 128T，分别占据整个内存空间的最高和最低处，剩下的中间部分是未定义的。</p>
<p>还记得进程的用户态和内核态吗？进程在用户态时，只能访问用户空间内存；只有进入内核态后，才可以访问内核空间内存。虽然每个进程的地址空间都包含了内核空间，但这些内核空间，其实关联的都是相同的物理内存。这样，进程切换到内核态后，就可以很方便地访问内核空间内存。</p>
<p>既然每个进程都有一个这么大的地址空间，那么所有进程的虚拟内存加起来，自然要比实际的物理内存大得多。所以，并不是所有的虚拟内存都会分配物理内存，只有那些实际使用的虚拟内存才分配物理内存，并且分配后的物理内存，是通过内存映射来管理的。</p>
<p>内存映射，其实就是将<strong>虚拟内存地址</strong>映射到<strong>物理内存地址</strong>。为了完成内存映射，内核为每个进程都维护了一张页表，记录虚拟地址与物理地址的映射关系，如下图所示：</p>
<p><img src="/images/2020/07/29/4985c70f-aded-453d-9d5d-53611a380e1a.png" alt="image.png"></p>
<p>页表实际上存储在 CPU 的内存管理单元 MMU 中，这样，正常情况下，处理器就可以直接通过硬件，找出要访问的内存。</p>
<p>而当进程访问的虚拟地址在页表中查不到时，系统会产生一个缺页异常，进入内核空间分配物理内存、更新进程页表，最后再返回用户空间，恢复进程的运行。</p>
<p>另外，我在 CPU 上下文切换的文章中曾经提到， TLB（Translation Lookaside Buffer，转译后备缓冲器）会影响 CPU 的内存访问性能，在这里其实就可以得到解释。</p>
<p>TLB 其实就是 MMU 中页表的高速缓存。由于进程的虚拟地址空间是独立的，而 TLB 的访问速度又比 MMU 快得多，所以，通过减少进程的上下文切换，减少 TLB 的刷新次数，就可以提高 TLB 缓存的使用率，进而提高 CPU 的内存访问性能。</p>
<p>不过要注意，MMU 并不以字节为单位来管理内存，而是规定了一个内存映射的最小单位，也就是页，通常是 4 KB 大小。这样，每一次内存映射，都需要关联 4 KB 或者 4KB 整数倍的内存空间。</p>
<p>页的大小只有 4 KB ，导致的另一个问题就是，整个页表会变得非常大。比方说，仅 32 位系统就需要 100 多万个页表项（4GB/4KB），才可以实现整个地址空间的映射。为了解决页表项过多的问题，Linux 提供了两种机制，也就是多级页表和大页（HugePage）。</p>
<p>多级页表就是把内存分成区块来管理，将原来的映射关系改成区块索引和区块内的偏移。由于虚拟内存空间通常只用了很少一部分，那么，多级页表就只保存这些使用中的区块，这样就可以大大地减少页表的项数。</p>
<p>Linux 用的正是四级页表来管理内存页，如下图所示，虚拟地址被分为 5 个部分，前 4 个表项用于选择页，而最后一个索引表示页内偏移。</p>
<p><img src="/images/2020/07/29/adfea2a4-cb35-4b0f-a584-28b7ed81df86.png" alt="image.png"></p>
<p>再看大页，顾名思义，就是比普通页更大的内存块，常见的大小有 2MB 和 1GB。大页通常用在使用大量内存的进程上，比如 Oracle、DPDK 等。</p>
<p>通过这些机制，在页表的映射下，进程就可以通过虚拟地址来访问物理内存了。那么具体到一个 Linux 进程中，这些内存又是怎么使用的呢？</p>
<h3 id="虚拟内存空间分布"><a href="#虚拟内存空间分布" class="headerlink" title="虚拟内存空间分布"></a>虚拟内存空间分布</h3><p>首先，我们需要进一步了解虚拟内存空间的分布情况。最上方的内核空间不用多讲，下方的用户空间内存，其实又被分成了多个不同的段。以 32 位系统为例，我画了一张图来表示它们的关系</p>
<p><img src="/images/2020/07/30/84a0c839-1610-4526-ad67-252a897947f7.png" alt="image.png"></p>
<p>通过这张图你可以看到，用户空间内存，从低到高分别是五种不同的内存段。</p>
<ul>
<li>只读段，包括代码和常量等。</li>
<li>数据段，包括全局变量等。</li>
<li>堆，包括动态分配的内存，从低地址开始向上增长。文件映射段，包括动态库、共享内存等，从高地址开始向下增长。</li>
<li>栈，包括局部变量和函数调用的上下文等。栈的大小是固定的，一般是 8 MB。</li>
</ul>
<p>在这五个内存段中，堆和文件映射段的内存是动态分配的。比如说，使用 C 标准库的 malloc() 或者 mmap() ，就可以分别在堆和文件映射段动态分配内存。</p>
<p>其实 64 位系统的内存分布也类似，只不过内存空间要大得多。那么，更重要的问题来了，内存究竟是怎么分配的呢？</p>
<h3 id="内存分配与回收"><a href="#内存分配与回收" class="headerlink" title="内存分配与回收"></a>内存分配与回收</h3><p>malloc() 是 C 标准库提供的内存分配函数，对应到系统调用上，有两种实现方式，即 brk() 和 mmap()。</p>
<p>对小块内存（小于 128K），C 标准库使用 brk() 来分配，也就是通过移动堆顶的位置来分配内存。</p>
<p>这些内存释放后并不会立刻归还系统，而是被缓存起来，这样就可以重复使用。而大块内存（大于 128K），则直接使用内存映射 mmap() 来分配，也就是在文件映射段找一块空闲内存分配出去。</p>
<p>这两种方式，自然各有优缺点。brk() 方式的缓存，可以减少缺页异常的发生，提高内存访问效率。不过，由于这些内存没有归还系统，在内存工作繁忙时，频繁的内存分配和释放会造成内存碎片。</p>
<p>而 mmap() 方式分配的内存，会在释放时直接归还系统，所以每次 mmap 都会发生缺页异常。在内存工作繁忙时，频繁的内存分配会导致大量的缺页异常，使内核的管理负担增大。这也是 malloc 只对大块内存使用 mmap 的原因。</p>
<p>了解这两种调用方式后，我们还需要清楚一点，那就是，当这两种调用发生后，其实并没有真正分配内存。这些内存，都只在首次访问时才分配，也就是通过缺页异常进入内核中，再由内核来分配内存。</p>
<p>整体来说，Linux 使用伙伴系统来管理内存分配。前面我们提到过，这些内存在 MMU 中以页为单位进行管理，伙伴系统也一样，以页为单位来管理内存，并且会通过相邻页的合并，减少内存碎片化（比如 brk 方式造成的内存碎片）。</p>
<p>你可能会想到一个问题，如果遇到比页更小的对象，比如不到 1K 的时候，该怎么分配内存呢？实际系统运行中，确实有大量比页还小的对象，如果为它们也分配单独的页，那就太浪费内存了。</p>
<p>所以，在用户空间，malloc 通过 brk() 分配的内存，在释放时并不立即归还系统，而是缓存起来重复利用。</p>
<p>在内核空间，Linux 则通过 slab 分配器来管理小内存。你可以把 slab 看成构建在伙伴系统上的一个缓存，主要作用就是分配并释放内核中的小对象。</p>
<p>对内存来说，如果只分配而不释放，就会造成内存泄漏，甚至会耗尽系统内存。所以，在应用程序用完内存后，还需要调用 free() 或 unmap() ，来释放这些不用的内存。</p>
<p>当然，系统也不会任由某个进程用完所有内存。在发现内存紧张时，系统就会通过一系列机制来回收内存，比如下面这三种方式：</p>
<ul>
<li>回收缓存，比如使用 LRU（Least Recently Used）算法，回收最近使用最少的内存页面；</li>
<li>回收不常访问的内存，把不常用的内存通过交换分区直接写到磁盘中；</li>
<li>杀死进程，内存紧张时系统还会通过 OOM（Out of Memory），直接杀掉占用大量内存的进程。</li>
</ul>
<p>其中，第二种方式回收不常访问的内存时，会用到交换分区（以下简称 Swap）。Swap 其实就是把一块磁盘空间当成内存来用。它可以把进程暂时不用的数据存储到磁盘中（这个过程称为换出），当进程访问这些内存时，再从磁盘读取这些数据到内存中（这个过程称为换入）。</p>
<p>所以，你可以发现，Swap 把系统的可用内存变大了。不过要注意，通常只在内存不足时，才会发生 Swap 交换。并且由于磁盘读写的速度远比内存慢，Swap 会导致严重的内存性能问题。</p>
<p>第三种方式提到的 OOM（Out of Memory），其实是内核的一种保护机制。它监控进程的内存使用情况，并且使用 oom_score 为每个进程的内存使用情况进行评分：</p>
<ul>
<li>一个进程消耗的内存越大，oom_score 就越大；</li>
<li>一个进程运行占用的 CPU 越多，oom_score 就越小。</li>
</ul>
<p>这样，进程的 oom_score 越大，代表消耗的内存越多，也就越容易被 OOM 杀死，从而可以更好保护系统。</p>
<p>当然，为了实际工作的需要，管理员可以通过 /proc 文件系统，手动设置进程的 oom_adj ，从而调整进程的 oom_score。oom_adj 的范围是 [-17, 15]，数值越大，表示进程越容易被 OOM 杀死；数值越小，表示进程越不容易被 OOM 杀死，其中 -17 表示禁止 OOM。</p>
<p>比如用下面的命令，你就可以把 sshd 进程的 oom_adj 调小为 -16，这样， sshd 进程就不容易被 OOM 杀死。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -16 &gt; /proc/$(pidof sshd)/oom_adj</span><br></pre></td></tr></table></figure>
<h3 id="如何查看内存使用情况"><a href="#如何查看内存使用情况" class="headerlink" title="如何查看内存使用情况"></a>如何查看内存使用情况</h3><p>通过了解内存空间的分布，以及内存的分配和回收，我想你对内存的工作原理应该有了大概的认识。当然，系统的实际工作原理更加复杂，也会涉及其他一些机制，这里我只讲了最主要的原理。掌握了这些，你可以对内存的运作有一条主线认识，不至于脑海里只有术语名词的堆砌。</p>
<p>那么在了解内存的工作原理之后，我们又该怎么查看系统内存使用情况呢？</p>
<p>其实前面 CPU 内容的学习中，我们也提到过一些相关工具。在这里，你第一个想到的应该是 free 工具吧。下面是一个 free 的输出示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 注意不同版本的free输出可能会有所不同</span></span><br><span class="line">$ free</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:        8169348      263524     6875352         668     1030472     7611064</span><br><span class="line">Swap:             0           0           0</span><br></pre></td></tr></table></figure>
<p>你可以看到，free 输出的是一个表格，其中的数值都默认以字节为单位。表格总共有两行六列，这两行分别是物理内存 Mem 和交换分区 Swap 的使用情况，而六列中，每列数据的含义分别为：</p>
<ul>
<li>第一列，total 是总内存大小；</li>
<li>第二列，used 是已使用内存的大小，包含了共享内存；</li>
<li>第三列，free 是未使用内存的大小；</li>
<li>第四列，shared 是共享内存的大小；</li>
<li>第五列，buff/cache 是缓存和缓冲区的大小；</li>
<li>最后一列，available 是新进程可用内存的大小。</li>
</ul>
<p>这里尤其注意一下，最后一列的可用内存 available 。available 不仅包含未使用内存，还包括了可回收的缓存，所以一般会比未使用内存更大。不过，并不是所有缓存都可以回收，因为有些缓存可能正在使用中。</p>
<p>不过，我们知道，free 显示的是整个系统的内存使用情况。如果你想查看进程的内存使用情况，可以用 top 或者 ps 等工具。比如，下面是 top 的输出示例：</p>
<p>这里尤其注意一下，最后一列的可用内存 available 。available 不仅包含未使用内存，还包括了可回收的缓存，所以一般会比未使用内存更大。不过，并不是所有缓存都可以回收，因为有些缓存可能正在使用中。</p>
<p>不过，我们知道，free 显示的是整个系统的内存使用情况。如果你想查看进程的内存使用情况，可以用 top 或者 ps 等工具。比如，下面是 top 的输出示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 按下M切换到内存排序</span></span><br><span class="line">$ top</span><br><span class="line">...</span><br><span class="line">KiB Mem :  8169348 total,  6871440 free,   267096 used,  1030812 buff/cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used.  7607492 avail Mem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">  430 root      19  -1  122360  35588  23748 S   0.0  0.4   0:32.17 systemd-journal</span><br><span class="line"> 1075 root      20   0  771860  22744  11368 S   0.0  0.3   0:38.89 snapd</span><br><span class="line"> 1048 root      20   0  170904  17292   9488 S   0.0  0.2   0:00.24 networkd-dispat</span><br><span class="line">    1 root      20   0   78020   9156   6644 S   0.0  0.1   0:22.92 systemd</span><br><span class="line">12376 azure     20   0   76632   7456   6420 S   0.0  0.1   0:00.01 systemd</span><br><span class="line">12374 root      20   0  107984   7312   6304 S   0.0  0.1   0:00.00 sshd</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>top 输出界面的顶端，也显示了系统整体的内存使用情况，这些数据跟 free 类似，我就不再重复解释。我们接着看下面的内容，跟内存相关的几列数据，比如 VIRT、RES、SHR 以及 %MEM 等。</p>
<p>这些数据，包含了进程最重要的几个内存使用情况，我们挨个来看。</p>
<ul>
<li>VIRT 是进程虚拟内存的大小，只要是进程申请过的内存，即便还没有真正分配物理内存，也会计算在内。</li>
<li>RES 是常驻内存的大小，也就是进程实际使用的物理内存大小，但不包括 Swap 和共享内存。</li>
<li>SHR 是共享内存的大小，比如与其他进程共同使用的共享内存、加载的动态链接库以及程序的代码段等。%MEM 是进程使用物理内存占系统总内存的百分比。</li>
</ul>
<p>除了要认识这些基本信息，在查看 top 输出时，你还要注意两点。</p>
<p>第一，虚拟内存通常并不会全部分配物理内存。从上面的输出，你可以发现每个进程的虚拟内存都比常驻内存大得多。</p>
<p>第二，共享内存 SHR 并不一定是共享的，比方说，程序的代码段、非共享的动态链接库，也都算在 SHR 里。当然，SHR 也包括了进程间真正共享的内存。所以在计算多个进程的内存使用时，不要把所有进程的 SHR 直接相加得出结果。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>今天，我们梳理了 Linux 内存的工作原理。对普通进程来说，它能看到的其实是内核提供的虚拟内存，这些虚拟内存还需要通过页表，由系统映射为物理内存。</p>
<p>当进程通过 malloc() 申请内存后，内存并不会立即分配，而是在首次访问时，才通过缺页异常陷入内核中分配内存。</p>
<p>由于进程的虚拟地址空间比物理内存大很多，Linux 还提供了一系列的机制，应对内存不足的问题，比如缓存的回收、交换分区 Swap 以及 OOM 等。</p>
<p>当你需要了解系统或者进程的内存使用情况时，可以用 free 和 top 、ps 等性能工具。它们都是分析性能问题时最常用的性能工具，希望你能熟练使用它们，并真正理解各个指标的含义。</p>
<p>— 侵权删 —</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/20/Consul-%E6%89%8B%E5%8A%A8%E6%93%8D%E4%BD%9C-%E6%9F%A5%E7%9C%8B-%E6%B3%A8%E9%94%80%E8%8A%82%E7%82%B9-%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/20/Consul-%E6%89%8B%E5%8A%A8%E6%93%8D%E4%BD%9C-%E6%9F%A5%E7%9C%8B-%E6%B3%A8%E9%94%80%E8%8A%82%E7%82%B9-%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">Consul 手动操作 查看 注销节点/服务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-20 17:32:49" itemprop="dateCreated datePublished" datetime="2020-06-20T17:32:49+08:00">2020-06-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-09-06 22:22:24" itemprop="dateModified" datetime="2021-09-06T22:22:24+08:00">2021-09-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/" itemprop="url" rel="index"><span itemprop="name">注册中心</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="查看指定ip-services"><a href="#查看指定ip-services" class="headerlink" title="查看指定ip services"></a>查看指定ip services</h3><hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -s http://10.0.2.26:8500/v1/catalog/services| python -m json.tool</span><br><span class="line"></span><br><span class="line">curl -s http://10.0.2.26:8500/v1/agent/services | python -m json.tool</span><br></pre></td></tr></table></figure>
<h3 id="查看指定ip-不健康的services"><a href="#查看指定ip-不健康的services" class="headerlink" title="查看指定ip 不健康的services"></a>查看指定ip 不健康的services</h3><hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s http://10.0.2.26:8500/v1/health/state/critical | python -m json.tool</span><br></pre></td></tr></table></figure>
<h3 id="查看本机配置"><a href="#查看本机配置" class="headerlink" title="查看本机配置"></a>查看本机配置</h3><hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s http://10.0.2.26:8500/v1/agent/self | python -m json.tool</span><br></pre></td></tr></table></figure>
<h3 id="返回本地agent的配置和成员信息"><a href="#返回本地agent的配置和成员信息" class="headerlink" title="返回本地agent的配置和成员信息"></a>返回本地agent的配置和成员信息</h3><hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s http://10.0.2.26:8500/v1/agent/self| python -m json.tool</span><br></pre></td></tr></table></figure>
<h3 id="查看集群服务端"><a href="#查看集群服务端" class="headerlink" title="查看集群服务端"></a>查看集群服务端</h3><hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s http://10.0.2.26:8500/v1/status/peers</span><br></pre></td></tr></table></figure>
<h3 id="查看leader"><a href="#查看leader" class="headerlink" title="查看leader"></a>查看leader</h3><hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s http://10.0.2.26:8500/v1/status/leader</span><br></pre></td></tr></table></figure>
<h3 id="查看集群所有节点-nodes"><a href="#查看集群所有节点-nodes" class="headerlink" title="查看集群所有节点 nodes"></a>查看集群所有节点 nodes</h3><hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s http://10.0.2.26:8500/v1/catalog/nodes | python -m json.tool</span><br></pre></td></tr></table></figure>
<h3 id="注销节点-consul重启导致node名冲突"><a href="#注销节点-consul重启导致node名冲突" class="headerlink" title="注销节点/consul重启导致node名冲突"></a>注销节点/consul重启导致node名冲突</h3><hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -s http://10.0.2.26:8500/v1/catalog/nodes | python -m json.tool |grep <span class="string">&quot;Node&quot;</span> <span class="comment"># 找到冲突节点的node名称</span></span><br><span class="line"></span><br><span class="line">curl -X PUT -H <span class="string">&#x27;application/json&#x27;</span> -d <span class="string">&#x27;&#123;&quot;Datacenter&quot;: &quot;dc1&quot;,&quot;Node&quot;: &quot;consul_client71&quot;&#125;&#x27;</span> http://10.0.2.26:8500/v1/catalog/deregister   <span class="comment"># 修改Node后的value ，重启节点重新注册</span></span><br></pre></td></tr></table></figure>
<h2 id="注销服务"><a href="#注销服务" class="headerlink" title="注销服务"></a>注销服务</h2><h3 id="删除服务必须使用连接到服务注册的那个节点上的consul-agent上执行dregister"><a href="#删除服务必须使用连接到服务注册的那个节点上的consul-agent上执行dregister" class="headerlink" title="删除服务必须使用连接到服务注册的那个节点上的consul agent上执行dregister"></a>删除服务必须使用连接到服务注册的那个节点上的consul agent上执行dregister</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -s http://10.0.2.26:8500/v1/agent/services | python -m json.tool|grep <span class="string">&quot;ID&quot;</span>. <span class="comment"># 查看这个ip的服务id</span></span><br><span class="line"></span><br><span class="line">curl --request PUT http://10.0.2.26:8500/v1/agent/service/deregister/msg-core-10-0-2-26-25105  <span class="comment"># 替换后边id名称</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/20/Consul%E4%BD%9C%E4%B8%BA%E5%86%85%E5%AD%98%E5%9E%8B%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/20/Consul%E4%BD%9C%E4%B8%BA%E5%86%85%E5%AD%98%E5%9E%8B%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">Consul作为内存型注册中心使用方式安装</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-20 17:30:14" itemprop="dateCreated datePublished" datetime="2020-06-20T17:30:14+08:00">2020-06-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-09-06 22:22:24" itemprop="dateModified" datetime="2021-09-06T22:22:24+08:00">2021-09-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/" itemprop="url" rel="index"><span itemprop="name">注册中心</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-单主服务端"><a href="#1-单主服务端" class="headerlink" title="1 单主服务端"></a>1 单主服务端</h2><hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@vm10-0-8-11 shells]<span class="comment"># cat docker-compose-consul.yml</span></span><br><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  consul_client:</span><br><span class="line">    container_name: consul_client</span><br><span class="line">    restart: always</span><br><span class="line">    image: hub.lingban.cn/consul:latest</span><br><span class="line">    network_mode: <span class="string">&quot;host&quot;</span></span><br><span class="line">    <span class="built_in">command</span>:  agent -server -client 0.0.0.0 -<span class="built_in">bind</span> 10.0.8.10 -node consul_server3 -bootstrap-expect 1 -datacenter aiaas4 -ui</span><br><span class="line">    logging:</span><br><span class="line">      options:</span><br><span class="line">        max-size: <span class="string">&#x27;100m&#x27;</span></span><br><span class="line">        max-file: <span class="string">&#x27;10&#x27;</span></span><br></pre></td></tr></table></figure>
<p>-datacenter 使用datacenter名称，其他agent不会主动加入不同名称的集群<br>-bootstrap-expect 1 设置为1，集群中第一个启动的为一个主，集群初始化时不用至少启动两个来选举主</p>
<h2 id="2-多主模式"><a href="#2-多主模式" class="headerlink" title="2 多主模式"></a>2 多主模式</h2><hr>
<p><strong>第一个主</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@vm10-0-8-11 shells]<span class="comment"># cat docker-compose-consul.yml</span></span><br><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  consul_client:</span><br><span class="line">    container_name: consul_client</span><br><span class="line">    restart: always</span><br><span class="line">    image: hub.lingban.cn/consul:latest</span><br><span class="line">    <span class="comment">#volumes:</span></span><br><span class="line">      <span class="comment">#- /data/aiaas/data/consul:/consul/data</span></span><br><span class="line">      <span class="comment">#- /data/aiaas/config/consul:/consul/config</span></span><br><span class="line">    network_mode: <span class="string">&quot;host&quot;</span></span><br><span class="line">    <span class="built_in">command</span>:  agent -server -client 0.0.0.0 -<span class="built_in">bind</span> 10.0.8.11 -node consul_server2 -bootstrap-expect 1 -datacenter aiaas4-test -ui</span><br><span class="line">    logging:</span><br><span class="line">      options:</span><br><span class="line">        max-size: <span class="string">&#x27;100m&#x27;</span></span><br><span class="line">        max-file: <span class="string">&#x27;10&#x27;</span></span><br></pre></td></tr></table></figure></p>
<p>-datacenter aiaas4-test 使用datacenter名称，防止其他consul加入，或者主动加入错误节点<br>-bootstrap-expect 1 第一个主必须设置1，否则可能启动失败，需要等第二个节点加入选择才可用。<br>-bind 10.0.8.11 设置为本机ip<br>-node consul_server2 不同节点不同</p>
<p><strong>第二个主</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  consul_client:</span><br><span class="line">    container_name: consul_client</span><br><span class="line">    restart: always</span><br><span class="line">    image: hub.lingban.cn/consul:latest</span><br><span class="line">    network_mode: <span class="string">&quot;host&quot;</span></span><br><span class="line">    <span class="built_in">command</span>:  agent -server -client 0.0.0.0 -<span class="built_in">bind</span> 10.0.8.12 -node consul_server3 -bootstrap-expect 2 -datacenter aiaas4-test -ui -retry-join 10.0.8.11</span><br><span class="line"> </span><br><span class="line">    logging:</span><br><span class="line">      options:</span><br><span class="line">        max-size: <span class="string">&#x27;100m&#x27;</span></span><br><span class="line">        max-file: <span class="string">&#x27;10&#x27;</span></span><br></pre></td></tr></table></figure><br>-datacenter aiaas4-test 使用datacenter名称，防止其他consul加入，或者主动加入错误节点<br>-bootstrap-expect 2 第二个设置为2<br>-node consul_server3 不同节点名称不同</p>
<h2 id="3-非主-从节点模式"><a href="#3-非主-从节点模式" class="headerlink" title="3 非主 从节点模式"></a>3 非主 从节点模式</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  consul_client:</span><br><span class="line">    container_name: consul_client</span><br><span class="line">    restart: always</span><br><span class="line">    image: hub.lingban.cn/consul:latest</span><br><span class="line">    <span class="comment">#volumes:</span></span><br><span class="line">    <span class="comment">#  - /data/aiaas/data/consul:/consul/data</span></span><br><span class="line">    <span class="comment">#  - /data/aiaas/config/consul:/consul/config</span></span><br><span class="line">    network_mode: <span class="string">&quot;host&quot;</span></span><br><span class="line">    <span class="built_in">command</span>:  agent -<span class="built_in">bind</span> 10.0.8.10 -client 0.0.0.0 -node consul_client1  -retry-join 10.0.8.11 -datacenter aiaas4-test -ui</span><br><span class="line">    logging:</span><br><span class="line">      options:</span><br><span class="line">        max-size: <span class="string">&#x27;100m&#x27;</span></span><br><span class="line">        max-file: <span class="string">&#x27;10&#x27;</span></span><br></pre></td></tr></table></figure>
<p>没有-server 参数<br>-client 0.0.0.0 允许webui的浏览器访问<br>-retry-join 10.0.8.11 加入server<br>-datacenter aiaas4-test 加入指定集群</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/20/HOMER-SIP-%E6%8A%93%E5%8C%85%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chenhan Hank">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="止乎于静">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/20/HOMER-SIP-%E6%8A%93%E5%8C%85%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">HOMER - SIP 抓包监控服务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-20 17:25:31" itemprop="dateCreated datePublished" datetime="2020-06-20T17:25:31+08:00">2020-06-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-09-06 22:22:24" itemprop="dateModified" datetime="2021-09-06T22:22:24+08:00">2021-09-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E9%9F%B3%E7%94%B5%E8%AF%9D/" itemprop="url" rel="index"><span itemprop="name">语音电话</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="一-什么是HOMER"><a href="#一-什么是HOMER" class="headerlink" title="一 什么是HOMER"></a>一 什么是HOMER</h2><hr>
<blockquote>
<p>HOMER是SIPCAPTURE堆栈的一部分：一个健壮的、运营商级的、模块化的VoIP和RTC捕获框架，用于分析和监视，支持所有主要的OSS语音平台和供应商不可知的捕获代理。HOMER在全球范围内部署了数千个部署，包括臭名昭著的行业供应商、语音网络运营商和财富500强企业，为使用和依赖VoIP服务和RTC技术的ITSP、VoIP提供商和主干供应商提供高级搜索、端到端分析和数据包深入分析功能—所有这些都是100%开源的</p>
</blockquote>
<h2 id="二-Homer安装-compose文件"><a href="#二-Homer安装-compose文件" class="headerlink" title="二 Homer安装  compose文件"></a>二 Homer安装  compose文件</h2><hr>
<h3 id="1-存放位置"><a href="#1-存放位置" class="headerlink" title="1 存放位置"></a>1 存放位置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[jms_op@vm10-0-7-66 homer5]$ <span class="built_in">pwd</span></span><br><span class="line">/data/aiaas/shells/homer5</span><br></pre></td></tr></table></figure>
<h4 id="2-Homer5-的heplify-server-与-homer-app、db的组合compose"><a href="#2-Homer5-的heplify-server-与-homer-app、db的组合compose" class="headerlink" title="2 Homer5 的heplify-server 与 homer-app、db的组合compose"></a>2 Homer5 的heplify-server 与 homer-app、db的组合compose</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">[jms_op@vm10-0-7-66 homer5]$ cat ./docker-compose.yml</span><br><span class="line">version: <span class="string">&#x27;3.1&#x27;</span></span><br><span class="line"> </span><br><span class="line">networks:</span><br><span class="line">  monitor-net:</span><br><span class="line">    driver: bridge</span><br><span class="line"> </span><br><span class="line">services:</span><br><span class="line">  caddy:</span><br><span class="line">    image: hub.lingban.cn/homer/caddy:latest</span><br><span class="line">    container_name: caddy</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;3000:3000&quot;</span></span><br><span class="line">      - <span class="string">&quot;9090:9090&quot;</span></span><br><span class="line">      - <span class="string">&quot;9093:9093&quot;</span></span><br><span class="line">      - <span class="string">&quot;9080:9080&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - ./caddy/:/etc/caddy/</span><br><span class="line">    environment:</span><br><span class="line">      - ADMIN_USER=<span class="variable">$&#123;ADMIN_USER:-admin&#125;</span></span><br><span class="line">      - ADMIN_PASSWORD=<span class="variable">$&#123;ADMIN_PASSWORD:-admin&#125;</span></span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    networks:</span><br><span class="line">      - monitor-net</span><br><span class="line">    labels:</span><br><span class="line">      org.label-schema.group: <span class="string">&quot;monitoring&quot;</span></span><br><span class="line"> </span><br><span class="line">  db:</span><br><span class="line">    container_name: db</span><br><span class="line">    image: hub.lingban.cn/homer/mariadb:latest</span><br><span class="line">    environment:</span><br><span class="line">      - <span class="string">&quot;MYSQL_ROOT_PASSWORD=&quot;</span></span><br><span class="line">      - <span class="string">&quot;MYSQL_ALLOW_EMPTY_PASSWORD=yes&quot;</span></span><br><span class="line">      - <span class="string">&quot;MYSQL_ROOT_HOST=%&quot;</span></span><br><span class="line">    ports:</span><br><span class="line">      - 3306:3306</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="string">&quot;/data/homer/data/mysql:/var/lib/mysql&quot;</span></span><br><span class="line">      - <span class="string">&quot;/data/homer/config/mysql:/etc/mysql&quot;</span></span><br><span class="line">    networks:</span><br><span class="line">      - monitor-net</span><br><span class="line">    restart: unless-stopped</span><br><span class="line"> </span><br><span class="line">  adminer:</span><br><span class="line">    image: hub.lingban.cn/homer/adminer:latest</span><br><span class="line">    depends_on:</span><br><span class="line">      - db</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:8080</span><br><span class="line">    networks:</span><br><span class="line">      - monitor-net</span><br><span class="line">    restart: unless-stopped</span><br><span class="line"> </span><br><span class="line">  heplify-server:</span><br><span class="line">    image: hub.lingban.cn/homer/heplify-server:latest</span><br><span class="line">    container_name: heplify-server</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9096:9096&quot;</span></span><br><span class="line">      - <span class="string">&quot;9060:9060&quot;</span></span><br><span class="line">      - <span class="string">&quot;9060:9060/udp&quot;</span></span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - <span class="string">&#x27;./heplify-server&#x27;</span></span><br><span class="line">    environment:</span><br><span class="line">      - <span class="string">&quot;HEPLIFYSERVER_HEPADDR=0.0.0.0:9060&quot;</span></span><br><span class="line">      - <span class="string">&quot;HEPLIFYSERVER_ESADDR=&quot;</span></span><br><span class="line">      - <span class="string">&quot;HEPLIFYSERVER_DBDRIVER=mysql&quot;</span></span><br><span class="line">      - <span class="string">&quot;HEPLIFYSERVER_DBADDR=db:3306&quot;</span></span><br><span class="line">      - <span class="string">&quot;HEPLIFYSERVER_DBUSER=root&quot;</span></span><br><span class="line">      - <span class="string">&quot;HEPLIFYSERVER_DBPASS=&quot;</span></span><br><span class="line">      - <span class="string">&quot;HEPLIFYSERVER_DBDROPDAYS=7&quot;</span></span><br><span class="line">      - <span class="string">&quot;HEPLIFYSERVER_LOGLVL=info&quot;</span></span><br><span class="line">      - <span class="string">&quot;HEPLIFYSERVER_LOGSTD=true&quot;</span></span><br><span class="line">      - <span class="string">&quot;HEPLIFYSERVER_PROMADDR=0.0.0.0:9096&quot;</span></span><br><span class="line">      - <span class="string">&quot;HEPLIFYSERVER_PROMTARGETIP=&quot;</span></span><br><span class="line">      - <span class="string">&quot;HEPLIFYSERVER_PROMTARGETNAME=&quot;</span></span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">      - TIME_ZONE=Asia/Shanghai</span><br><span class="line">    volumes:</span><br><span class="line">      - /etc/localtime:/etc/localtime:ro</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    expose:</span><br><span class="line">      - 9096</span><br><span class="line">    networks:</span><br><span class="line">      - monitor-net</span><br><span class="line">    depends_on:</span><br><span class="line">      - db</span><br><span class="line">    labels:</span><br><span class="line">      org.label-schema.group: <span class="string">&quot;monitoring&quot;</span></span><br><span class="line"> </span><br><span class="line">  homer-webapp:</span><br><span class="line">    container_name: homer-webapp</span><br><span class="line">    image: hub.lingban.cn/homer/homer-webapp:latest</span><br><span class="line">    environment:</span><br><span class="line">      - <span class="string">&quot;DB_HOST=db&quot;</span></span><br><span class="line">      - <span class="string">&quot;DB_USER=root&quot;</span></span><br><span class="line">      - <span class="string">&quot;DB_PASS=&quot;</span></span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">      - TIME_ZONE=Asia/Shanghai</span><br><span class="line">    expose:</span><br><span class="line">      - 80</span><br><span class="line">    volumes:</span><br><span class="line">      - /etc/localtime:/etc/localtime:ro</span><br><span class="line">      - ./docker-compose.yml:/homer-semaphore/.bootstrapped</span><br><span class="line">      - /data/homer/data/homer-webapp/opt:/opt</span><br><span class="line"> </span><br><span class="line">    networks:</span><br><span class="line">      - monitor-net</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    depends_on:</span><br><span class="line">      - db</span><br></pre></td></tr></table></figure>
<h2 id="二-Homer-heplify-探针-compose-文件"><a href="#二-Homer-heplify-探针-compose-文件" class="headerlink" title="二 Homer heplify 探针 compose 文件"></a>二 Homer heplify 探针 compose 文件</h2><hr>
<h3 id="1-一般存放位置"><a href="#1-一般存放位置" class="headerlink" title="1 一般存放位置"></a>1 一般存放位置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[jms_op@vm10-0-2-23 homer]$ <span class="built_in">pwd</span></span><br><span class="line">/data/aiaas/shells/homer</span><br></pre></td></tr></table></figure>
<h3 id="2-每种服务的不同探针compose文件"><a href="#2-每种服务的不同探针compose文件" class="headerlink" title="2 每种服务的不同探针compose文件"></a>2 每种服务的不同探针compose文件</h3><p>针对每种服务的打开端口不同，分别监控不同的udp范围<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[jms_op@vm10-0-2-23 homer]$ cat docker-compose-homer-hep-fs.yml</span><br><span class="line">version: <span class="string">&#x27;2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  heplify_fs:</span><br><span class="line">    image: hub.lingban.cn/homer/heplify:latest</span><br><span class="line">    <span class="built_in">command</span>: <span class="string">&quot;./heplify -hs 10.0.7.66:9060 -pr 15060-15080 -e&quot;</span></span><br><span class="line">    container_name: heplify_fs</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    network_mode: <span class="string">&quot;host&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /proc:/host/proc</span><br><span class="line">      - /sys:/host/sys</span><br><span class="line">      - /:/rootfs</span><br><span class="line"> </span><br><span class="line">[jms_op@vm10-0-2-23 homer]$ cat docker-compose-homer-hep-opensips.yml</span><br><span class="line">version: <span class="string">&#x27;2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  heplify_opensips:</span><br><span class="line">    image: hub.lingban.cn/homer/heplify:latest</span><br><span class="line">    <span class="built_in">command</span>: <span class="string">&quot;./heplify -hs 10.0.7.66:9060 -pr 6060 -e&quot;</span></span><br><span class="line">    container_name: heplify_opensips</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    network_mode: <span class="string">&quot;host&quot;</span></span><br><span class="line">    environment:</span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">      - TIME_ZONE=Asia/Shanghai</span><br><span class="line">    volumes:</span><br><span class="line">      - /etc/localtime:/etc/localtime:ro</span><br><span class="line">      - /proc:/host/proc</span><br><span class="line">      - /sys:/host/sys</span><br><span class="line">      - /:/rootfs</span><br><span class="line"> </span><br><span class="line">[jms_op@vm10-0-2-23 homer]$ cat docker-compose-homer-hep-janus.yml</span><br><span class="line">version: <span class="string">&#x27;2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  heplify_janus:</span><br><span class="line">    image: hub.lingban.cn/homer/heplify:latest</span><br><span class="line">    <span class="built_in">command</span>: <span class="string">&quot;./heplify -hs 10.0.7.66:9060 -pr 30000-39999 -e&quot;</span></span><br><span class="line">    container_name: heplify_janus</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    network_mode: <span class="string">&quot;host&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">    - /proc:/host/proc</span><br><span class="line">    - /sys:/host/sys</span><br><span class="line">    - /:/rootfs</span><br><span class="line">    - /etc/localtime:/etc/localtime:ro</span><br><span class="line">    environment:</span><br><span class="line">    - TZ=Asia/Shanghai</span><br><span class="line">    - TIME_ZONE=Asia/Shanghai</span><br><span class="line"> </span><br><span class="line">[jms_op@vm10-0-2-23 homer]$ cat docker-compose-homer-hep-rtp.yml</span><br><span class="line">version: <span class="string">&#x27;2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  heplify_rtp_1:</span><br><span class="line">    image: hub.lingban.cn/homer/heplify:latest</span><br><span class="line">    <span class="built_in">command</span>: <span class="string">&quot;./heplify -hs 10.0.7.66:9060 -pr 20000-29999 -e&quot;</span></span><br><span class="line">    container_name: heplify_rtp</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    network_mode: <span class="string">&quot;host&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /proc:/host/proc</span><br><span class="line">      - /sys:/host/sys</span><br><span class="line">      - /:/rootfs</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Chenhan Hank</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">78</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">80</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chenhan Hank</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
